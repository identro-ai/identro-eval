<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Identro-Eval Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
          colors: {
            border: 'hsl(214.3 31.8% 91.4%)',
            input: 'hsl(214.3 31.8% 91.4%)',
            ring: 'hsl(222.2 84% 4.9%)',
            background: 'hsl(0 0% 100%)',
            foreground: 'hsl(222.2 84% 4.9%)',
            primary: {
              DEFAULT: 'hsl(222.2 47.4% 11.2%)',
              foreground: 'hsl(210 40% 98%)',
            },
            secondary: {
              DEFAULT: 'hsl(210 40% 96.1%)',
              foreground: 'hsl(222.2 47.4% 11.2%)',
            },
            muted: {
              DEFAULT: 'hsl(210 40% 96.1%)',
              foreground: 'hsl(215.4 16.3% 46.9%)',
            },
            accent: {
              DEFAULT: 'hsl(210 40% 96.1%)',
              foreground: 'hsl(222.2 47.4% 11.2%)',
            },
            card: {
              DEFAULT: 'hsl(0 0% 100%)',
              foreground: 'hsl(222.2 84% 4.9%)',
            },
          },
          boxShadow: {
            'soft': '0 1px 2px 0 rgb(0 0 0 / 0.05)',
            'card': '0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1)',
          }
        }
      }
    };
  </script>
  
  <style>
/* Identro Dashboard Styles */

* {
    border-color: hsl(214.3 31.8% 91.4%);
}

body {
    font-family: 'Inter', system-ui, sans-serif;
    background: hsl(210 20% 98%);
    -webkit-font-smoothing: antialiased;
}

.font-mono {
    font-family: 'Geist Mono', monospace;
}

.scrollbar-thin::-webkit-scrollbar {
    width: 6px;
}

.scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
}

.scrollbar-thin::-webkit-scrollbar-thumb {
    background: hsl(214.3 31.8% 85%);
    border-radius: 3px;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}

.animate-in {
    animation: fadeIn 0.2s ease-out forwards;
}

.animate-slide-in {
    animation: slideIn 0.2s ease-out forwards;
}

.delay-1 { animation-delay: 0.05s; }
.delay-2 { animation-delay: 0.1s; }
.delay-3 { animation-delay: 0.15s; }
.delay-4 { animation-delay: 0.2s; }

  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Data Placeholder (injected by CLI at runtime) -->
  <script>
    // Default empty data - CLI will inject actual data
    window.IdentroData = window.IdentroData || {};
    // API URL for data refresh - CLI will inject actual URL
    window.API_URL = window.API_URL || '';
    // Initial view from URL hash or default
    window.INITIAL_VIEW = window.location.hash.slice(2) || 'reports-latest';
  </script>
  
  <!-- App -->
  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

// === components/icons.jsx ===
/**
 * Icons Component
 * SVG icons used throughout the dashboard
 */

const Icons = {
    Logo: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <polyline points="4 17 10 11 4 5"/>
            <line x1="12" x2="20" y1="19" y2="19"/>
        </svg>
    ),
    Users: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
    ),
    User: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
        </svg>
    ),
    Grid: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/>
        </svg>
    ),
    TestTube: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M14.5 2v17.5c0 1.4-1.1 2.5-2.5 2.5h0c-1.4 0-2.5-1.1-2.5-2.5V2"/><path d="M8.5 2h7"/><path d="M14.5 16h-5"/>
        </svg>
    ),
    FileText: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/>
        </svg>
    ),
    Archive: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/>
        </svg>
    ),
    ChevronDown: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="m6 9 6 6 6-6"/>
        </svg>
    ),
    ChevronRight: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="m9 18 6-6-6-6"/>
        </svg>
    ),
    ExternalLink: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/>
        </svg>
    ),
    Play: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"/>
        </svg>
    ),
    Filter: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
        </svg>
    ),
    Check: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-3 h-3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <polyline points="20 6 9 17 4 12"/>
        </svg>
    ),
    X: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-3 h-3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
        </svg>
    ),
    AlertTriangle: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/>
        </svg>
    ),
    Package: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="m16.5 9.4-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/>
        </svg>
    ),
    BarChart: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/>
        </svg>
    ),
    Microscope: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/><path d="M12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"/>
        </svg>
    ),
    Info: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
        </svg>
    ),
    CheckCircle: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
    ),
    XCircle: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>
        </svg>
    ),
    Target: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
        </svg>
    ),
    ClosePanel: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
        </svg>
    ),
    Wrench: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
    ),
    ArrowLeft: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
        </svg>
    ),
    Shield: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
    ),
    List: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/>
        </svg>
    ),
    Tool: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
    ),
    Activity: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
        </svg>
    ),
    Settings: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>
        </svg>
    ),
    GitBranch: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <line x1="6" x2="6" y1="3" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/>
        </svg>
    ),
    Terminal: () => (
        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
            <polyline points="4 17 10 11 4 5"/><line x1="12" x2="20" y1="19" y2="19"/>
        </svg>
    ),
};


// === components/common.jsx ===
/**
 * Common UI Components
 * Reusable components used across the dashboard
 */

// Badge component for status indicators
const Badge = ({ children, variant = 'default' }) => {
    const variants = {
        default: 'bg-slate-100 text-slate-700',
        passed: 'bg-emerald-100 text-emerald-700',
        failed: 'bg-red-100 text-red-700',
        warning: 'bg-amber-100 text-amber-700',
    };
    return (
        <span className={`text-xs font-medium px-2 py-0.5 rounded ${variants[variant]}`}>
            {children}
        </span>
    );
};

// Score badge with color coding
const ScoreBadge = ({ score }) => {
    const getColor = (s) => {
        if (s >= 90) return 'text-emerald-600 bg-emerald-50';
        if (s >= 70) return 'text-amber-600 bg-amber-50';
        return 'text-red-600 bg-red-50';
    };
    return (
        <span className={`text-sm font-mono font-semibold px-2 py-1 rounded ${getColor(score)}`}>
            {score}%
        </span>
    );
};

// Button component
const Button = ({ children, variant = 'default', icon: Icon, onClick }) => {
    const variants = {
        default: 'bg-slate-900 text-white hover:bg-slate-800',
        outline: 'border border-slate-200 text-slate-700 hover:bg-slate-50',
        ghost: 'text-slate-600 hover:bg-slate-100',
    };
    return (
        <button 
            onClick={onClick}
            className={`inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${variants[variant]}`}
        >
            {Icon && <Icon />}
            {children}
        </button>
    );
};

// Table component
const Table = ({ columns, data }) => (
    <div className="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-soft">
        <table className="w-full">
            <thead>
                <tr className="border-b border-slate-200 bg-slate-50/50">
                    {columns.map((col, i) => (
                        <th key={i} className="text-left px-4 py-3 text-xs font-medium text-slate-500 uppercase tracking-wide">
                            {col.header}
                        </th>
                    ))}
                </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
                {data.map((row, i) => (
                    <tr key={i} className="hover:bg-slate-50/50 transition-colors">
                        {columns.map((col, j) => (
                            <td key={j} className="px-4 py-3 text-sm text-slate-700">
                                {col.render ? col.render(row) : row[col.key]}
                            </td>
                        ))}
                    </tr>
                ))}
            </tbody>
        </table>
    </div>
);

// Metric card for stats display
const MetricCard = ({ label, value, subtext }) => (
    <div className="bg-white rounded-lg border border-slate-200 p-4 shadow-soft">
        <div className="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">{label}</div>
        <div className="text-2xl font-semibold text-slate-900 font-mono">{value}</div>
        {subtext && <div className="text-xs text-slate-500 mt-1">{subtext}</div>}
    </div>
);

// Filter dropdown component
const FilterDropdown = ({ label, options, value, onChange }) => {
    const [isOpen, setIsOpen] = useState(false);
    
    return (
        <div className="relative">
            <button 
                onClick={() => setIsOpen(!isOpen)}
                className={`inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-md border transition-colors ${
                    value ? 'bg-slate-100 border-slate-300 text-slate-900' : 'border-slate-200 text-slate-600 hover:bg-slate-50'
                }`}
            >
                <Icons.Filter />
                {value || label}
                <Icons.ChevronDown />
            </button>
            
            {isOpen && (
                <>
                    <div className="fixed inset-0 z-10" onClick={() => setIsOpen(false)} />
                    <div className="absolute top-full left-0 mt-1 bg-white border border-slate-200 rounded-lg shadow-lg z-20 min-w-[160px] py-1">
                        <button 
                            onClick={() => { onChange(''); setIsOpen(false); }}
                            className="w-full text-left px-3 py-2 text-sm text-slate-500 hover:bg-slate-50"
                        >
                            All {label}s
                        </button>
                        {options.map((opt, i) => (
                            <button 
                                key={i}
                                onClick={() => { onChange(opt); setIsOpen(false); }}
                                className={`w-full text-left px-3 py-2 text-sm hover:bg-slate-50 ${value === opt ? 'bg-slate-100 text-slate-900' : 'text-slate-700'}`}
                            >
                                {opt}
                            </button>
                        ))}
                    </div>
                </>
            )}
        </div>
    );
};

// Stability indicator with dots
const StabilityIndicator = ({ level }) => {
    const levels = { LOW: 1, MEDIUM: 2, HIGH: 3 };
    const current = levels[level] || 0;
    const colors = { LOW: 'bg-red-500', MEDIUM: 'bg-amber-500', HIGH: 'bg-emerald-500' };
    const textColors = { LOW: 'text-red-600', MEDIUM: 'text-amber-600', HIGH: 'text-emerald-600' };
    
    return (
        <div className="flex items-center gap-2">
            <span className={`font-semibold ${textColors[level]}`}>
                {level}
            </span>
            <div className="flex gap-0.5">
                {[1, 2, 3].map(i => (
                    <span key={i} className={`w-2 h-2 rounded-full ${i <= current ? colors[level] : 'bg-slate-200'}`}></span>
                ))}
            </div>
        </div>
    );
};

// Simple string syntax highlighter for Python-style or plain text
const StringHighlight = ({ text }) => {
    if (!text || typeof text !== 'string') {
        return <span className="text-slate-300">{String(text || '')}</span>;
    }
    
    // Build highlighted output using React elements
    const result = [];
    let i = 0;
    let key = 0;
    
    while (i < text.length) {
        const ch = text[i];
        
        // Check for string start (single or double quote)
        if (ch === "'" || ch === '"') {
            const quote = ch;
            let j = i + 1;
            // Find the closing quote
            while (j < text.length && text[j] !== quote) {
                if (text[j] === '\\' && j + 1 < text.length) {
                    j += 2; // Skip escaped character
                } else {
                    j++;
                }
            }
            if (j < text.length) j++; // Include closing quote
            const str = text.slice(i, j);
            
            // Check if this is a key (followed by :)
            const afterStr = text.slice(j).trimStart();
            if (afterStr.startsWith(':')) {
                result.push(<span key={key++} className="text-sky-400">{str}</span>);
            } else {
                result.push(<span key={key++} className="text-emerald-400">{str}</span>);
            }
            i = j;
            continue;
        }
        
        // Check for numbers
        if (/\d/.test(ch)) {
            let j = i;
            while (j < text.length && /[\d.]/.test(text[j])) j++;
            result.push(<span key={key++} className="text-amber-400">{text.slice(i, j)}</span>);
            i = j;
            continue;
        }
        
        // Check for True/False/None
        const remaining = text.slice(i);
        const boolMatch = remaining.match(/^(True|False|None|true|false|null)\b/);
        if (boolMatch) {
            result.push(<span key={key++} className="text-purple-400">{boolMatch[0]}</span>);
            i += boolMatch[0].length;
            continue;
        }
        
        // Check for brackets and colons
        if (ch === '[' || ch === ']' || ch === '{' || ch === '}' || ch === ':' || ch === ',') {
            result.push(<span key={key++} className="text-slate-400">{ch}</span>);
            i++;
            continue;
        }
        
        // Default: just add the character as plain text
        result.push(<span key={key++} className="text-slate-300">{ch}</span>);
        i++;
    }
    
    return <>{result}</>;
};

// JSON Syntax Highlighting Component
const JsonHighlight = ({ data }) => {
    // If data is a string, try to parse it as JSON, otherwise use string highlighting
    let jsonObj = data;
    let isValidJson = true;
    
    if (typeof data === 'string') {
        try {
            jsonObj = JSON.parse(data);
        } catch {
            // Check if it looks like a structure (Python dict/list)
            const trimmed = data.trim();
            if (trimmed.startsWith('[') || trimmed.startsWith('{')) {
                // Return with simple string highlighting for Python-style
                return <StringHighlight text={data} />;
            }
            isValidJson = false;
        }
    }
    
    // If not valid JSON or just a plain string, display as plain text
    if (!isValidJson || typeof jsonObj === 'string') {
        return <span className="text-slate-300">{String(data)}</span>;
    }
    
    // Recursive function to render JSON with syntax highlighting
    const renderValue = (value, depth = 0) => {
        const indent = '  '.repeat(depth);
        const nextIndent = '  '.repeat(depth + 1);
        
        if (value === null) {
            return <span className="text-purple-400">null</span>;
        }
        
        if (typeof value === 'boolean') {
            return <span className="text-purple-400">{value.toString()}</span>;
        }
        
        if (typeof value === 'number') {
            return <span className="text-amber-400">{value}</span>;
        }
        
        if (typeof value === 'string') {
            // Escape special characters and handle long strings
            const escaped = value.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n');
            return <span className="text-emerald-400">"{escaped}"</span>;
        }
        
        if (Array.isArray(value)) {
            if (value.length === 0) {
                return <span className="text-slate-400">[]</span>;
            }
            return (
                <>
                    <span className="text-slate-400">[</span>
                    {'\n'}
                    {value.map((item, idx) => (
                        <span key={idx}>
                            {nextIndent}{renderValue(item, depth + 1)}
                            {idx < value.length - 1 && <span className="text-slate-400">,</span>}
                            {'\n'}
                        </span>
                    ))}
                    {indent}<span className="text-slate-400">]</span>
                </>
            );
        }
        
        if (typeof value === 'object') {
            const keys = Object.keys(value);
            if (keys.length === 0) {
                return <span className="text-slate-400">{'{}'}</span>;
            }
            return (
                <>
                    <span className="text-slate-400">{'{'}</span>
                    {'\n'}
                    {keys.map((key, idx) => (
                        <span key={key}>
                            {nextIndent}<span className="text-sky-400">"{key}"</span>
                            <span className="text-slate-400">: </span>
                            {renderValue(value[key], depth + 1)}
                            {idx < keys.length - 1 && <span className="text-slate-400">,</span>}
                            {'\n'}
                        </span>
                    ))}
                    {indent}<span className="text-slate-400">{'}'}</span>
                </>
            );
        }
        
        return <span className="text-slate-300">{String(value)}</span>;
    };
    
    return <>{renderValue(jsonObj)}</>;
};

// Collapsible section component
const CollapsibleSection = ({ title, icon: Icon, badge, isOpen, onToggle, children }) => (
    <div className="bg-white rounded-lg border border-slate-200 shadow-soft overflow-hidden">
        <button 
            onClick={onToggle}
            className="w-full flex items-center justify-between p-4 hover:bg-slate-50 transition-colors"
        >
            <div className="flex items-center gap-2">
                {Icon && <span className="text-slate-500"><Icon /></span>}
                <span className="font-medium text-slate-900">{title}</span>
                {badge && <span className="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500 ml-2">{badge}</span>}
            </div>
            {isOpen ? <Icons.ChevronDown /> : <Icons.ChevronRight />}
        </button>
        
        {isOpen && (
            <div className="border-t border-slate-200">
                {children}
            </div>
        )}
    </div>
);


// === components/layout.jsx ===
/**
 * Layout Components
 * Sidebar navigation and page headers
 */

// Sidebar navigation
const Sidebar = ({ activeView, setActiveView, expandedSections, toggleSection }) => {
    const NavItem = ({ id, icon: Icon, label, indent = false }) => (
        <button
            onClick={() => setActiveView(id)}
            className={`w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md transition-colors ${
                indent ? 'ml-4' : ''
            } ${
                activeView === id 
                    ? 'bg-slate-100 text-slate-900 font-medium' 
                    : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900'
            }`}
        >
            <Icon />
            {label}
        </button>
    );

    const SectionHeader = ({ label, section }) => (
        <button 
            onClick={() => toggleSection(section)}
            className="w-full flex items-center justify-between px-3 py-2 text-xs font-medium text-slate-400 uppercase tracking-wider hover:text-slate-600"
        >
            {label}
            {expandedSections[section] ? <Icons.ChevronDown /> : <Icons.ChevronRight />}
        </button>
    );

    return (
        <aside className="fixed left-0 top-0 bottom-0 w-56 bg-white border-r border-slate-200 flex flex-col">
            {/* Logo */}
            <div className="p-4 border-b border-slate-200">
                <div className="flex items-center gap-2">
                    <div className="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white">
                        <Icons.Logo />
                    </div>
                    <div>
                        <div className="font-semibold text-slate-900 text-sm">Identro</div>
                        <div className="text-[10px] text-slate-500 font-mono">eval dashboard</div>
                    </div>
                </div>
            </div>

            {/* Navigation */}
            <nav className="flex-1 p-3 space-y-1 overflow-y-auto">
                {/* Entities Section */}
                <SectionHeader label="Entities" section="entities" />
                {expandedSections.entities && (
                    <div className="space-y-0.5">
                        <NavItem id="flows" icon={Icons.Activity} label="Flows" indent />
                        <NavItem id="crews" icon={Icons.Users} label="Crews" indent />
                        <NavItem id="agents" icon={Icons.User} label="Agents" indent />
                    </div>
                )}

                {/* Dimensions */}
                <div className="pt-2">
                    <NavItem id="dimensions" icon={Icons.Grid} label="Dimensions" />
                </div>

                {/* Tests */}
                <div className="pt-2">
                    <NavItem id="tests" icon={Icons.TestTube} label="Tests" />
                </div>

                {/* Reports Section */}
                <div className="pt-2">
                    <SectionHeader label="Reports" section="reports" />
                    {expandedSections.reports && (
                        <div className="space-y-0.5">
                            <NavItem id="reports-latest" icon={Icons.FileText} label="Latest" indent />
                            <NavItem id="reports-archive" icon={Icons.Archive} label="Archive" indent />
                        </div>
                    )}
                </div>
            </nav>

            {/* Footer */}
            <div className="p-3 border-t border-slate-200">
                <div className="text-[10px] text-slate-400 font-mono">
                    v{window.IdentroData?.version || '0.1.0'}
                </div>
            </div>
        </aside>
    );
};

// Page header component
const Header = ({ title, subtitle, actions }) => (
    <div className="flex items-center justify-between mb-6">
        <div>
            <h1 className="text-xl font-semibold text-slate-900">{title}</h1>
            {subtitle && <p className="text-sm text-slate-500 mt-0.5">{subtitle}</p>}
        </div>
        {actions && <div className="flex items-center gap-2">{actions}</div>}
    </div>
);


// === components/views/behavior-profiles.jsx ===
// BehaviorProfile.jsx - Enhanced Behavioral Passport Component
// Displays behavioral analysis with radar charts, distributions, and LLM-generated insights

function BehaviorProfile({ profile, onNavigate }) {
  const [activeTab, setActiveTab] = React.useState('consistency');
  
  if (!profile) {
    return (
      <Card className="p-8 text-center">
        <p className="text-slate-400">No behavioral profile data available. Run tests to generate a profile.</p>
      </Card>
    );
  }
  
  const { entityName, entityType, dimensions, overall, summary, keyInsights, recommendedActions, stabilityAnalysis } = profile;
  
  // Handle case where dimensions is empty or missing
  if (!dimensions || dimensions.length === 0) {
    return (
      <Card className="p-8 text-center">
        <h2 className="text-lg font-semibold text-cyan-400 mb-2">{entityName || 'Unknown Entity'}</h2>
        <p className="text-slate-400">No dimension data available. Run tests across multiple dimensions to generate a behavioral profile.</p>
      </Card>
    );
  }
  
  // Calculate derived metrics
  const totalTests = dimensions.reduce((sum, d) => sum + (d.tests?.length || 0), 0);
  const totalRuns = dimensions.reduce((sum, d) => 
    sum + (d.tests?.reduce((tSum, t) => tSum + (t.criteria?.[0]?.runs?.length || 0), 0) || 0), 0);
  const passingDims = dimensions.filter(d => d.passRate >= 85).length;
  const avgFlipRate = dimensions.length > 0 
    ? (dimensions.reduce((sum, d) => sum + (d.flipRate || 0), 0) / dimensions.length).toFixed(1)
    : '0';
  
  // Determine stability status
  const getStabilityStatus = (flipRate) => {
    const rate = parseFloat(flipRate);
    if (rate <= 10) return { label: 'Stable', colorClass: 'emerald' };
    if (rate <= 25) return { label: 'Moderate', colorClass: 'amber' };
    return { label: 'Unstable', colorClass: 'red' };
  };
  
  const stability = getStabilityStatus(avgFlipRate);
  
  // Color helpers
  const getFlipColor = (flip) => {
    if (flip <= 10) return 'text-emerald-400';
    if (flip <= 25) return 'text-amber-400';
    return 'text-red-400';
  };
  
  const getScoreColor = (score, threshold = 85) => score >= threshold ? 'text-emerald-400' : 'text-red-400';
  
  // Radar Chart Component (for 3+ dimensions)
  // Now uses average eval criteria scores (distribution.mean) instead of passRate
  const RadarChart = () => {
    if (dimensions.length < 3) return null;
    
    // Extra wide viewBox with horizontal padding for labels
    const viewWidth = 320;  // Much wider to fit labels
    const viewHeight = 260;
    const centerX = viewWidth / 2;  // Center horizontally
    const centerY = viewHeight / 2;
    const radius = 60;
    const labelOffset = 40; // Extra space for long dimension names
    
    // Use distribution.mean (average criterion score) for each dimension
    const points = dimensions.map((d, i) => {
      const angle = (Math.PI * 2 * i) / dimensions.length - Math.PI / 2;
      // distribution.mean is 0-1, so use directly (not divided by 100)
      const avgCriteriaScore = d.distribution?.mean || 0;
      const r = avgCriteriaScore * radius;
      return { x: centerX + r * Math.cos(angle), y: centerY + r * Math.sin(angle), score: avgCriteriaScore };
    });
    
    const thresholdPoints = dimensions.map((_, i) => {
      const angle = (Math.PI * 2 * i) / dimensions.length - Math.PI / 2;
      const r = 0.95 * radius;
      return { x: centerX + r * Math.cos(angle), y: centerY + r * Math.sin(angle) };
    });
    
    return (
      <svg viewBox={`0 0 ${viewWidth} ${viewHeight}`} className="w-full h-full" style={{minHeight: '220px'}} preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="radarFill" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="rgb(6,182,212)" stopOpacity="0.3" />
            <stop offset="100%" stopColor="rgb(34,211,238)" stopOpacity="0.1" />
          </linearGradient>
        </defs>
        
        {/* Grid rings */}
        {[0.25, 0.5, 0.75, 1].map((scale, i) => (
          <polygon key={i}
            points={dimensions.map((_, j) => {
              const angle = (Math.PI * 2 * j) / dimensions.length - Math.PI / 2;
              const r = scale * radius;
              return `${centerX + r * Math.cos(angle)},${centerY + r * Math.sin(angle)}`;
            }).join(' ')}
            fill="none" stroke="rgba(71,85,105,0.3)" strokeWidth="0.5"
          />
        ))}
        
        {/* Axis lines */}
        {dimensions.map((_, i) => {
          const angle = (Math.PI * 2 * i) / dimensions.length - Math.PI / 2;
          return <line key={i} x1={centerX} y1={centerY}
            x2={centerX + radius * Math.cos(angle)} y2={centerY + radius * Math.sin(angle)}
            stroke="rgba(71,85,105,0.3)" strokeWidth="0.5" />;
        })}
        
        {/* Threshold line (85%) */}
        <polygon points={thresholdPoints.map(p => `${p.x},${p.y}`).join(' ')}
          fill="none" stroke="rgba(148,163,184,0.5)" strokeWidth="1" strokeDasharray="3,2" />
        
        {/* Data shape */}
        <polygon points={points.map(p => `${p.x},${p.y}`).join(' ')}
          fill="url(#radarFill)" stroke="rgb(6,182,212)" strokeWidth="1.5" />
        
        {/* Data points */}
        {points.map((p, i) => (
          <circle key={i} cx={p.x} cy={p.y} r="3" fill="rgb(6,182,212)" stroke="#0f172a" strokeWidth="1" />
        ))}
        
        {/* Labels - positioned further out with larger font */}
        {dimensions.map((d, i) => {
          const angle = (Math.PI * 2 * i) / dimensions.length - Math.PI / 2;
          const labelR = radius + labelOffset;
          const x = centerX + labelR * Math.cos(angle);
          const y = centerY + labelR * Math.sin(angle);
          
          // Determine text anchor based on angle (left, center, right)
          let anchor = 'middle';
          if (angle > -Math.PI/3 && angle < Math.PI/3) anchor = 'start'; // right side
          else if (angle > 2*Math.PI/3 || angle < -2*Math.PI/3) anchor = 'end'; // left side
          
          // Capitalize first letter of dimension name
          const dimName = d.dimension.charAt(0).toUpperCase() + d.dimension.slice(1);
          
          // Show avg criteria score (distribution.mean * 100)
          const avgScore = (d.distribution?.mean || 0) * 100;
          
          return (
            <g key={i}>
              <text x={x} y={y-5} textAnchor={anchor} className="fill-slate-300" style={{fontSize:'9px', fontWeight: 500}}>
                {dimName}
              </text>
              <text x={x} y={y+7} textAnchor={anchor} className="fill-cyan-400 font-mono" style={{fontSize:'10px', fontWeight: 600}}>
                {avgScore.toFixed(0)}%
              </text>
            </g>
          );
        })}
      </svg>
    );
  };
  
  // Bar Chart Component (for 1-2 dimensions)
  // Shows horizontal bars with average criterion scores
  const BarChart = () => {
    if (dimensions.length >= 3 || dimensions.length === 0) return null;
    
    const barHeight = 32;
    const labelWidth = 80;
    const chartWidth = 200;
    const padding = 8;
    const viewHeight = dimensions.length * (barHeight + padding) + padding;
    const viewWidth = labelWidth + chartWidth + 20;
    
    return (
      <svg viewBox={`0 0 ${viewWidth} ${viewHeight}`} className="w-full" style={{minHeight: `${viewHeight}px`}} preserveAspectRatio="xMidYMid meet">
        <defs>
          <linearGradient id="barFillPass" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor="rgb(6,182,212)" stopOpacity="0.8" />
            <stop offset="100%" stopColor="rgb(34,211,238)" stopOpacity="0.6" />
          </linearGradient>
          <linearGradient id="barFillFail" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor="rgb(239,68,68)" stopOpacity="0.8" />
            <stop offset="100%" stopColor="rgb(248,113,113)" stopOpacity="0.6" />
          </linearGradient>
        </defs>
        
        {dimensions.map((d, i) => {
          const y = padding + i * (barHeight + padding);
          const avgScore = (d.distribution?.mean || 0) * 100;
          const barWidth = (avgScore / 100) * chartWidth;
          const thresholdX = labelWidth + (95 / 100) * chartWidth;
          const isPassing = avgScore >= 95;
          
          // Capitalize dimension name
          const dimName = d.dimension.charAt(0).toUpperCase() + d.dimension.slice(1);
          
          return (
            <g key={d.dimension}>
              {/* Dimension label */}
              <text 
                x={labelWidth - 8} 
                y={y + barHeight / 2 + 4} 
                textAnchor="end" 
                className="fill-slate-300" 
                style={{fontSize: '11px', fontWeight: 500}}
              >
                {dimName}
              </text>
              
              {/* Background track */}
              <rect 
                x={labelWidth} 
                y={y + 4} 
                width={chartWidth} 
                height={barHeight - 8} 
                fill="rgba(71,85,105,0.3)" 
                rx="4" 
              />
              
              {/* Score bar */}
              <rect 
                x={labelWidth} 
                y={y + 4} 
                width={barWidth} 
                height={barHeight - 8} 
                fill={isPassing ? "url(#barFillPass)" : "url(#barFillFail)"} 
                rx="4" 
              />
              
              {/* 85% threshold line */}
              <line 
                x1={thresholdX} 
                y1={y} 
                x2={thresholdX} 
                y2={y + barHeight} 
                stroke="rgba(148,163,184,0.7)" 
                strokeWidth="1" 
                strokeDasharray="3,2" 
              />
              
              {/* Score label */}
              <text 
                x={labelWidth + chartWidth + 8} 
                y={y + barHeight / 2 + 4} 
                textAnchor="start" 
                className={isPassing ? "fill-cyan-400" : "fill-red-400"} 
                style={{fontSize: '12px', fontWeight: 600, fontFamily: 'monospace'}}
              >
                {avgScore.toFixed(0)}%
              </text>
            </g>
          );
        })}
      </svg>
    );
  };
  
  // Run Distribution Visualization
  const RunDistribution = ({ dimension }) => {
    const scores = dimension.distribution?.scores || [];
    if (scores.length === 0) return <span className="text-slate-600 text-xs">No data</span>;
    
    const min = Math.min(...scores) * 100;
    const max = Math.max(...scores) * 100;
    const avg = (dimension.distribution?.mean || 0) * 100;
    const threshold = 95;
    
    return (
      <svg viewBox="0 0 100 16" className="w-full h-4" preserveAspectRatio="none">
        {/* Background track */}
        <rect x="0" y="6" width="100" height="4" fill="rgba(71,85,105,0.4)" rx="2" />
        {/* Range highlight */}
        <rect x={min} y="6" width={Math.max(0, max - min)} height="4" fill="rgba(6,182,212,0.2)" rx="2" />
        {/* Threshold line */}
        <line x1={threshold} y1="1" x2={threshold} y2="15" stroke="rgba(148,163,184,0.5)" strokeWidth="1" />
        {/* Average line */}
        <line x1={avg} y1="0" x2={avg} y2="16" stroke="rgb(52,211,153)" strokeWidth="1.5" />
        {/* Individual score dots (sample up to 20) */}
        {scores.slice(0, 20).map((val, i) => (
          <circle key={i} cx={val * 100} cy="8" r="2.5" fill="rgb(6,182,212)" stroke="rgb(15,23,42)" strokeWidth="1" />
        ))}
      </svg>
    );
  };
  
  // Helper to extract dimension from text by matching known dimension names
  const extractDimensionFromText = (text) => {
    if (!text) return { dim: 'overall', cleanText: text, type: 'neutral' };
    
    let cleanText = text;
    
    // Step 1: Remove emojis at the beginning (checkmark, x, warning, etc)
    cleanText = cleanText.replace(/^[\u{1F44D}\u{2705}\u{274C}\u{26A0}\u{FE0F}\u{2714}\u{2718}\u{1F534}\u{1F7E2}\u{1F7E1}âœ…âŒâš ï¸âœ“âœ—ðŸ”´ðŸŸ¢ðŸŸ¡]+\s*/gu, '');
    
    // Step 2: Remove priority flags like [P1], [P2], [P3], (P1), etc
    cleanText = cleanText.replace(/^[\[\(]?P\d[\]\)]?:?\s*/gi, '');
    
    const lowerText = cleanText.toLowerCase();
    const knownDims = dimensions.map(d => d.dimension.toLowerCase());
    
    // Find matching dimension
    let foundDim = 'overall';
    for (const dim of knownDims) {
      if (lowerText.includes(dim)) {
        foundDim = dim;
        break;
      }
    }
    
    // Determine type based on keywords
    let type = 'neutral';
    const strengthKeywords = ['strong', 'excellent', 'high', 'perfect', 'great', 'solid', 'stable', 'meets', 'passing', 'success', 'reliably', 'robust'];
    const weaknessKeywords = ['weak', 'poor', 'low', 'underperform', 'fail', 'inconsistent', 'variance', 'below', 'gap', 'issue', 'implement', 'improve'];
    
    if (strengthKeywords.some(k => lowerText.includes(k))) {
      type = 'pass';
    } else if (weaknessKeywords.some(k => lowerText.includes(k))) {
      type = 'warn';
    }
    
    // Step 3: Remove dimension name at start with colon (e.g., "privacy: The agent...")
    const dimCapitalized = foundDim.charAt(0).toUpperCase() + foundDim.slice(1);
    const dimLower = foundDim.toLowerCase();
    
    // Remove patterns like "privacy:", "Privacy:", "bias-fairness:", etc at the start
    const prefixPatterns = [
      new RegExp(`^${dimLower}:\\s*`, 'i'),
      new RegExp(`^${dimCapitalized}:\\s*`, 'i'),
      new RegExp(`^${dimLower.replace(/-/g, '[-\\s]?')}:\\s*`, 'i'),
      new RegExp(`^${dimCapitalized}:?\\s*`, 'i'),
      new RegExp(`^The ${dimCapitalized} dimension:?\\s*`, 'i'),
      new RegExp(`^${dimCapitalized} dimension:?\\s*`, 'i'),
      new RegExp(`^For ${dimCapitalized}:?\\s*`, 'i'),
      new RegExp(`^In ${dimCapitalized}:?\\s*`, 'i'),
      new RegExp(`^${dimCapitalized} -\\s*`, 'i'),
      new RegExp(`^${dimCapitalized}\\s*â€”\\s*`, 'i'),
    ];
    for (const pattern of prefixPatterns) {
      cleanText = cleanText.replace(pattern, '');
    }
    
    // Also remove dimension name embedded in sentences like "The safety dimension shows..."
    const embeddedPatterns = [
      new RegExp(`the ${dimLower} dimension`, 'gi'),
      new RegExp(`${dimLower} dimension`, 'gi'),
      new RegExp(`\\b${dimLower} shows`, 'gi'),
      new RegExp(`\\b${dimLower} is`, 'gi'),
      new RegExp(`\\b${dimLower} has`, 'gi'),
      new RegExp(`\\b${dimLower} demonstrates`, 'gi'),
    ];
    for (const pattern of embeddedPatterns) {
      cleanText = cleanText.replace(pattern, (match) => {
        // Replace with appropriate substitute
        if (match.toLowerCase().includes('shows')) return 'Shows';
        if (match.toLowerCase().includes(' is')) return 'Is';
        if (match.toLowerCase().includes(' has')) return 'Has';
        if (match.toLowerCase().includes('demonstrates')) return 'Demonstrates';
        return '';
      });
    }
    
    // Clean up any double spaces, leading/trailing whitespace, and em dashes at start
    cleanText = cleanText.replace(/^[\sâ€”-]+/, '').replace(/\s+/g, ' ').trim();
    // Capitalize first letter if needed
    if (cleanText.length > 0) {
      cleanText = cleanText.charAt(0).toUpperCase() + cleanText.slice(1);
    }
    
    return { dim: foundDim, cleanText: cleanText.trim(), type };
  };
  
  // Build insights from LLM data or dimension analysis
  const buildInsights = () => {
    if (keyInsights && keyInsights.length > 0) {
      return keyInsights.map((insight, i) => {
        const rawText = typeof insight === 'string' ? insight : (insight.text || insight.insight || '');
        const explicitDim = insight.dimension;
        const explicitType = insight.type === 'strength' ? 'pass' : insight.type === 'weakness' ? 'warn' : null;
        
        // If dimension not explicitly provided, try to extract from text
        if (!explicitDim || explicitDim === 'overall') {
          const extracted = extractDimensionFromText(rawText);
          return {
            dim: extracted.dim,
            type: explicitType || extracted.type || 'neutral',
            text: extracted.cleanText
          };
        }
        
        return {
          dim: explicitDim,
          type: explicitType || 'neutral',
          text: rawText
        };
      });
    }
    
    // Fallback: generate from dimension data
    return dimensions.map(d => ({
      dim: d.dimension,
      type: d.passRate >= 85 ? 'pass' : 'warn',
      text: d.passRate >= 85 
        ? `Shows strong performance with ${(d.passRate || 0).toFixed(0)}% pass rate and ${(d.flipRate || 0).toFixed(0)}% flip rate.`
        : `Underperforms at ${(d.passRate || 0).toFixed(0)}% pass rate. ${d.flipRate > 15 ? `High variability (${(d.flipRate || 0).toFixed(0)}% flip rate) detected.` : ''}`
    }));
  };
  
  // Build actions from LLM data
  const buildActions = () => {
    if (recommendedActions && recommendedActions.length > 0) {
      return recommendedActions.map((action, i) => {
        const rawText = typeof action === 'string' ? action : (action.text || action.recommendation || action.action || '');
        const explicitDim = action.dimension;
        
        // If dimension not explicitly provided, try to extract from text
        if (!explicitDim || explicitDim === 'overall') {
          const extracted = extractDimensionFromText(rawText);
          return {
            priority: action.priority || `P${i + 1}`,
            dim: extracted.dim,
            text: extracted.cleanText
          };
        }
        
        return {
          priority: action.priority || `P${i + 1}`,
          dim: explicitDim,
          text: rawText
        };
      });
    }
    
    // Fallback: generate from failing dimensions
    return dimensions
      .filter(d => d.passRate < 85)
      .slice(0, 3)
      .map((d, i) => ({
        priority: `P${i + 1}`,
        dim: d.dimension,
        text: `Improve performance. Current pass rate is ${(d.passRate || 0).toFixed(0)}% (target: 85%).`
      }));
  };
  
  const insights = buildInsights();
  const actions = buildActions();
  
  // Stability badge colors
  const stabilityBg = stability.colorClass === 'emerald' ? 'bg-emerald-500/10' :
                      stability.colorClass === 'amber' ? 'bg-amber-500/10' : 'bg-red-500/10';
  const stabilityBorder = stability.colorClass === 'emerald' ? 'border-emerald-500/30' :
                          stability.colorClass === 'amber' ? 'border-amber-500/30' : 'border-red-500/30';
  const stabilityDot = stability.colorClass === 'emerald' ? 'bg-emerald-500' :
                       stability.colorClass === 'amber' ? 'bg-amber-500' : 'bg-red-500';
  const stabilityText = stability.colorClass === 'emerald' ? 'text-emerald-400' :
                        stability.colorClass === 'amber' ? 'text-amber-400' : 'text-red-400';
  
  // Define dark theme colors as inline styles to ensure proper rendering
  const styles = {
    container: { background: '#0f172a', minHeight: '100%', padding: '12px' },
    headerCard: { background: 'rgba(15, 23, 42, 0.95)', border: '1px solid #334155', borderRadius: '8px' },
    card: { background: 'rgba(15, 23, 42, 0.85)', border: '1px solid #334155', borderRadius: '8px' },
    cardInner: { background: 'rgba(30, 41, 59, 0.6)', border: '1px solid #475569', borderRadius: '8px' },
    text: { color: '#e2e8f0' },
    textMuted: { color: '#94a3b8' },
    textCyan: { color: '#22d3ee' },
    textEmerald: { color: '#34d399' },
    textAmber: { color: '#fbbf24' },
    textRed: { color: '#f87171' },
    mono: { fontFamily: 'monospace' },
  };
  
  return (
    <div style={styles.container}>
      {/* Header */}
      <div style={styles.headerCard}>
        <div className="flex items-center justify-between p-4">
          <div className="flex items-center gap-4">
            <div>
              <div className="text-[10px] uppercase tracking-widest text-slate-500 mb-0.5">Behavior Profile</div>
              <h1 className="text-lg font-semibold text-cyan-400">{entityName}</h1>
            </div>
            <div className={`flex items-center gap-1.5 px-2.5 py-1 rounded-full ${stabilityBg} border ${stabilityBorder}`}>
              <span className={`w-1.5 h-1.5 rounded-full ${stabilityDot}`}></span>
              <span className={`text-xs font-medium ${stabilityText}`}>{stability.label}</span>
              <span className="text-[10px] text-slate-500 font-mono">{avgFlipRate}% flip</span>
            </div>
          </div>
          <div className="flex items-center gap-6 text-sm">
            <div><span className="text-slate-500">Tests</span> <span className="font-mono text-slate-200 ml-1">{totalTests}</span></div>
            <div><span className="text-slate-500">Pass</span> <span className={`font-mono ml-1 ${getScoreColor(overall?.passRate || 0)}`}>{(overall?.passRate || 0).toFixed(0)}%</span></div>
            <div><span className="text-slate-500">Dims</span> <span className="font-mono text-slate-200 ml-1">{dimensions.length}</span></div>
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="grid grid-cols-12 gap-3">
        {/* Left Column - Dimensions */}
        <div className="col-span-7 space-y-3">
          {/* Summary */}
          <div className="bg-slate-900/60 border border-slate-800 rounded-lg p-4">
            <h3 className="text-[10px] uppercase tracking-widest text-slate-500 mb-2">Summary</h3>
            <p className="text-sm text-slate-300 leading-relaxed">
              {summary || `${(overall?.passRate || 0).toFixed(0)}% overall pass rate across ${dimensions.length} dimensions. ` + 
                (passingDims === dimensions.length 
                  ? `All dimensions meet the 85% threshold.` 
                  : `${passingDims}/${dimensions.length} dimensions passing.`)}
            </p>
          </div>

          {/* Dimension Scores Table */}
          <div className="bg-slate-900/60 border border-slate-800 rounded-lg overflow-hidden">
            <div className="grid grid-cols-12 gap-2 px-4 py-2 border-b border-slate-800 text-[10px] uppercase tracking-wider text-slate-500">
              <div className="col-span-3">Dimension</div>
              <div className="col-span-2 text-center">Pass Rate</div>
              <div className="col-span-2 text-center">Flip Rate</div>
              <div className="col-span-5">Score Distribution</div>
            </div>
            {dimensions.map((d) => (
              <div key={d.dimension} className="grid grid-cols-12 gap-2 px-4 py-2.5 border-b border-slate-800/50 items-center hover:bg-slate-800/30 transition-colors">
                <div className="col-span-3">
                  <span className="text-sm text-slate-300 capitalize">{d.dimension}</span>
                </div>
                <div className="col-span-2 text-center">
                  <span className={`font-mono text-sm ${getScoreColor(d.passRate || 0, 100)}`}>{(d.passRate || 0).toFixed(0)}</span>
                  <span className="text-slate-600 text-xs">/100</span>
                </div>
                <div className="col-span-2 text-center">
                  <span className={`font-mono text-xs ${getFlipColor(d.flipRate || 0)}`}>{(d.flipRate || 0).toFixed(0)}%</span>
                </div>
                <div className="col-span-5 flex items-center gap-2">
                  <RunDistribution dimension={d} />
                  <span className="text-[10px] text-slate-500 font-mono w-12">
                    avg={d.distribution?.mean ? (d.distribution.mean * 100).toFixed(0) : 0}%
                  </span>
                </div>
              </div>
            ))}
          </div>

          {/* Tabs for Consistency/Insights/Actions */}
          <div className="bg-slate-900/60 border border-slate-800 rounded-lg overflow-hidden">
            <div className="flex border-b border-slate-800">
              {['consistency', 'insights', 'actions'].map((tab) => (
                <button key={tab} onClick={() => setActiveTab(tab)}
                  className={`flex-1 px-4 py-2 text-xs uppercase tracking-wider transition-colors
                    ${activeTab === tab ? 'text-cyan-400 bg-slate-800/50 border-b-2 border-cyan-400' : 'text-slate-500 hover:text-slate-300'}`}>
                  {tab}
                </button>
              ))}
            </div>
            
            <div className="p-4 max-h-64 overflow-y-auto">
              {activeTab === 'consistency' && (
                <div className="space-y-3">
                  {dimensions.some(d => (d.passRate || 0) < 85 || (d.flipRate || 0) > 15) && (
                    <div className="bg-amber-500/10 rounded p-3 border border-amber-500/20">
                      <span className="text-[10px] uppercase text-amber-400 font-medium">Attention Needed</span>
                      <p className="text-sm text-amber-200 mt-1">
                        Most variance in: {dimensions.filter(d => (d.flipRate || 0) > 15).map(d => d.dimension).join(', ') || 'none detected'}
                      </p>
                    </div>
                  )}
                  <div className="bg-slate-800/50 rounded p-3 border border-slate-700/50">
                    <span className="text-[10px] uppercase text-purple-400 font-medium">Stability Analysis</span>
                    <p className="text-sm text-slate-300 mt-1">
                      {stabilityAnalysis || `Overall flip rate of ${avgFlipRate}% indicates ${stability.label.toLowerCase()} behavior across runs.`}
                    </p>
                  </div>
                </div>
              )}
              
              {activeTab === 'insights' && (
                <div className="space-y-2">
                  {insights.map((ins, i) => (
                    <div key={i} className={`flex gap-3 p-2 rounded ${ins.type === 'pass' ? 'bg-emerald-500/5' : 'bg-amber-500/5'}`}>
                      <span className={`text-xs font-mono px-1.5 py-0.5 rounded h-fit ${ins.type === 'pass' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`}>
                        {ins.dim}
                      </span>
                      <p className="text-sm text-slate-300 flex-1">{ins.text}</p>
                    </div>
                  ))}
                </div>
              )}
              
              {activeTab === 'actions' && (
                <div className="space-y-2">
                  {actions.length > 0 ? actions.map((act, i) => (
                    <div key={i} className="flex gap-3 p-2 rounded bg-slate-800/30">
                      <span className={`text-[10px] font-mono font-bold px-1.5 py-0.5 rounded h-fit
                        ${act.priority === 'P1' ? 'bg-red-500/20 text-red-400' : 
                          act.priority === 'P2' ? 'bg-amber-500/20 text-amber-400' : 'bg-slate-500/20 text-slate-400'}`}>
                        {act.priority}
                      </span>
                      <div className="flex-1">
                        <span className="text-xs text-cyan-400 font-medium">{act.dim}</span>
                        <p className="text-sm text-slate-300">{act.text}</p>
                      </div>
                    </div>
                  )) : (
                    <p className="text-sm text-slate-500">No recommended actions. All dimensions performing well.</p>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Right Column - Radar + Stats */}
        <div className="col-span-5 space-y-3">
          {/* Radar Chart (only if 3+ dimensions) */}
          {dimensions.length >= 3 && (
            <div className="bg-slate-900/60 border border-slate-800 rounded-lg p-4">
              <h3 className="text-[10px] uppercase tracking-widest text-slate-500 mb-2 text-center">Trait Shape</h3>
              <div className="aspect-square">
                <RadarChart />
              </div>
              <div className="flex justify-center gap-4 mt-2 text-[10px] text-slate-500">
                <div className="flex items-center gap-1">
                  <div className="w-2 h-2 rounded-full bg-cyan-500/50 border border-cyan-400"></div>
                  <span>Avg Score</span>
                </div>
                <div className="flex items-center gap-1">
                  <div className="w-4 border-t border-dashed border-slate-400"></div>
                  <span>95% threshold</span>
                </div>
              </div>
            </div>
          )}

          {/* Bar Chart (for 1-2 dimensions) */}
          {dimensions.length > 0 && dimensions.length < 3 && (
            <div className="bg-slate-900/60 border border-slate-800 rounded-lg p-4">
              <h3 className="text-[10px] uppercase tracking-widest text-slate-500 mb-3 text-center">Dimension Scores</h3>
              <div className="flex justify-center">
                <BarChart />
              </div>
              <div className="flex justify-center gap-4 mt-3 text-[10px] text-slate-500">
                <div className="flex items-center gap-1">
                  <div className="w-3 h-2 rounded-sm bg-cyan-500/60"></div>
                  <span>Avg Score</span>
                </div>
                <div className="flex items-center gap-1">
                  <div className="w-4 border-t border-dashed border-slate-400"></div>
                  <span>95% threshold</span>
                </div>
              </div>
            </div>
          )}

          {/* Quick Stats */}
          <div className="bg-slate-900/60 border border-slate-800 rounded-lg p-4">
            <h3 className="text-[10px] uppercase tracking-widest text-slate-500 mb-3">Quick Stats</h3>
            <div className="grid grid-cols-2 gap-3">
              <div className="bg-slate-800/50 rounded p-2 text-center">
                <div className={`text-lg font-mono ${passingDims === dimensions.length ? 'text-emerald-400' : 'text-amber-400'}`}>
                  {passingDims}/{dimensions.length}
                </div>
                <div className="text-[10px] text-slate-500">Dims Passing</div>
              </div>
              <div className="bg-slate-800/50 rounded p-2 text-center">
                <div className={`text-lg font-mono ${getFlipColor(parseFloat(avgFlipRate))}`}>{avgFlipRate}%</div>
                <div className="text-[10px] text-slate-500">Avg Flip Rate</div>
              </div>
              <div className="bg-slate-800/50 rounded p-2 text-center">
                <div className="text-lg font-mono text-cyan-400">{(overall?.passRate || 0).toFixed(0)}%</div>
                <div className="text-[10px] text-slate-500">Overall Pass</div>
              </div>
              <div className="bg-slate-800/50 rounded p-2 text-center">
                <div className="text-lg font-mono text-slate-300">{totalRuns || totalTests}</div>
                <div className="text-[10px] text-slate-500">Total Runs</div>
              </div>
            </div>
          </div>

          {/* Status Legend */}
          <div className="bg-slate-900/60 border border-slate-800 rounded-lg p-3">
            <div className="grid grid-cols-3 gap-2 text-[10px]">
              <div className="flex items-center gap-1">
                <span className="w-2 h-2 rounded-full bg-emerald-500"></span>
                <span className="text-slate-400">0-10% flip</span>
              </div>
              <div className="flex items-center gap-1">
                <span className="w-2 h-2 rounded-full bg-amber-500"></span>
                <span className="text-slate-400">11-25%</span>
              </div>
              <div className="flex items-center gap-1">
                <span className="w-2 h-2 rounded-full bg-red-500"></span>
                <span className="text-slate-400">over 25%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Footer */}
      <div className="flex items-center justify-between px-2 text-[10px] text-slate-600">
        <span>Source: .identro/profiles/{entityName}</span>
        <span>{dimensions.map(d => d.dimension).join(' / ')}</span>
      </div>
    </div>
  );
}


// === components/views/flows.jsx ===
/**
 * Flows View
 * Displays list of workflow/flow orchestrations with their crews, paths, and HITL points
 */

const FlowsView = ({ onSelectFlow }) => {
    const data = window.IdentroData;
    const flows = data?.flows || [];
    const crews = data?.crews || [];
    
    // Calculate unique metrics across all flows
    const uniqueCrews = new Set();
    const totalPaths = flows.reduce((sum, f) => sum + (f.paths?.length || f.pathCount || 0), 0);
    const totalHitlPoints = flows.reduce((sum, f) => sum + (f.humanInteractionPoints?.length || 0), 0);
    const flowsWithRouting = flows.filter(f => f.hasRouting).length;
    
    flows.forEach(flow => {
        (flow.crews || []).forEach(c => uniqueCrews.add(c.name || c));
    });

    return (
        <div className="animate-in">
            <Header 
                title="Flows" 
                subtitle="Multi-crew workflow orchestrations"
            />
            
            {/* Compact Metrics Row */}
            <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                <div className="flex items-center gap-6 divide-x divide-slate-200">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Flows</span>
                        <span className="text-sm font-semibold text-fuchsia-600">{flows.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Crews Used</span>
                        <span className="text-sm font-semibold text-violet-600">{uniqueCrews.size}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Paths</span>
                        <span className="text-sm font-semibold text-blue-600">{totalPaths}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">HITL Points</span>
                        <span className="text-sm font-semibold text-teal-600">{totalHitlPoints}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">With Routing</span>
                        <span className="text-sm font-semibold text-orange-600">{flowsWithRouting}</span>
                    </div>
                </div>
            </div>

            {/* Flows List */}
            <div className="space-y-3">
                {flows.map((flow, i) => {
                    const pathCount = flow.paths?.length || flow.pathCount || 0;
                    const hitlCount = flow.humanInteractionPoints?.length || 0;
                    const crewCount = flow.crews?.length || 0;
                    const stepCount = flow.steps?.length || flow.stepCount || 0;
                    const boundaries = flow.boundaries || flow.contract?.boundaries;
                    const boundaryCount = (boundaries?.allowed?.length || 0) + (boundaries?.forbidden?.length || 0);
                    const hasLoops = flow.hasLoops;
                    const hasRouting = flow.hasRouting;
                    
                    return (
                        <div 
                            key={flow.id || i}
                            onClick={() => onSelectFlow && onSelectFlow(flow.name)}
                            className="bg-white rounded-lg border border-slate-200 shadow-soft hover:shadow-card hover:border-fuchsia-200 transition-all cursor-pointer animate-in group overflow-hidden"
                            style={{ animationDelay: `${i * 0.05}s` }}
                        >
                            {/* Header Section */}
                            <div className="bg-gradient-to-r from-fuchsia-50 to-violet-50 border-b border-slate-200 px-4 py-3">
                                <div className="flex items-start justify-between">
                                    <div className="flex items-start gap-3 flex-1 min-w-0">
                                        <div className="mt-0.5 w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-fuchsia-100 text-fuchsia-600">
                                            <Icons.Activity />
                                        </div>
                                        <div className="min-w-0 flex-1">
                                            {/* Badges row */}
                                            <div className="flex items-center gap-2 mb-1.5 flex-wrap">
                                                {/* Paths count */}
                                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                                                    {pathCount} path{pathCount !== 1 ? 's' : ''}
                                                </span>
                                                
                                                {/* Steps count */}
                                                {stepCount > 0 && (
                                                    <span className="text-xs bg-slate-100 text-slate-700 px-2 py-0.5 rounded">
                                                        {stepCount} step{stepCount !== 1 ? 's' : ''}
                                                    </span>
                                                )}
                                                
                                                {/* Crews count */}
                                                {crewCount > 0 && (
                                                    <span className="text-xs bg-violet-100 text-violet-700 px-2 py-0.5 rounded">
                                                        {crewCount} crew{crewCount !== 1 ? 's' : ''}
                                                    </span>
                                                )}
                                                
                                                {/* HITL indicator */}
                                                {hitlCount > 0 && (
                                                    <span className="text-xs bg-teal-100 text-teal-700 px-2 py-0.5 rounded flex items-center gap-1">
                                                        <svg viewBox="0 0 24 24" fill="none" className="w-3 h-3" stroke="currentColor" strokeWidth="2">
                                                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                                        </svg>
                                                        {hitlCount} HITL
                                                    </span>
                                                )}
                                                
                                                {/* Routing indicator */}
                                                {hasRouting && (
                                                    <span className="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded flex items-center gap-1">
                                                        <svg viewBox="0 0 24 24" fill="none" className="w-3 h-3" stroke="currentColor" strokeWidth="2">
                                                            <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5"/>
                                                        </svg>
                                                        routing
                                                    </span>
                                                )}
                                                
                                                {/* Loops indicator */}
                                                {hasLoops && (
                                                    <span className="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded flex items-center gap-1">
                                                        <svg viewBox="0 0 24 24" fill="none" className="w-3 h-3" stroke="currentColor" strokeWidth="2">
                                                            <path d="M17 2.1l4 4-4 4"/><path d="M3 12.2v-2a4 4 0 0 1 4-4h12.8M7 21.9l-4-4 4-4"/><path d="M21 11.8v2a4 4 0 0 1-4 4H4.2"/>
                                                        </svg>
                                                        loops
                                                    </span>
                                                )}
                                                
                                                {/* Boundaries indicator */}
                                                {boundaryCount > 0 && (
                                                    <span className="text-xs bg-fuchsia-50 text-fuchsia-600 px-2 py-0.5 rounded">
                                                        {boundaryCount} boundaries
                                                    </span>
                                                )}
                                            </div>
                                            
                                            {/* Flow name - magenta/fuchsia link style */}
                                            <p className="text-sm font-semibold text-fuchsia-600 group-hover:text-fuchsia-700 transition-colors">
                                                {flow.name}
                                            </p>
                                            
                                            {/* Description line */}
                                            <div className="flex items-center gap-2 mt-1 text-xs text-slate-500">
                                                <span>Workflow orchestration</span>
                                                {flow.type && <span className="capitalize">â€¢ {flow.type}</span>}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Right side - index number */}
                                    <div className="flex-shrink-0 ml-4">
                                        <span className="text-xs bg-fuchsia-200 text-fuchsia-700 px-2 py-1 rounded font-medium">#{i + 1}</span>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Body Section */}
                            <div className="p-4 space-y-3">
                                {/* Flow description or purpose */}
                                {(flow.description || flow.contract?.purpose || flow.contract?.description) && (
                                    <div>
                                        <div className="text-xs font-semibold text-slate-500 mb-1">PURPOSE</div>
                                        <div className="bg-slate-50 p-2 rounded text-xs text-slate-700 line-clamp-2 border border-slate-100">
                                            {flow.description || flow.contract?.purpose || flow.contract?.description}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Crews preview */}
                                {flow.crews && flow.crews.length > 0 && (
                                    <div>
                                        <div className="text-xs font-semibold text-slate-500 mb-1">CREWS</div>
                                        <div className="flex flex-wrap gap-1.5">
                                            {flow.crews.slice(0, 4).map((crew, j) => (
                                                <span key={j} className="text-xs bg-violet-50 text-violet-600 px-2 py-0.5 rounded">
                                                    {crew.name || crew}
                                                </span>
                                            ))}
                                            {flow.crews.length > 4 && (
                                                <span className="text-xs text-slate-400">
                                                    +{flow.crews.length - 4} more
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Paths preview */}
                                {flow.paths && flow.paths.length > 0 && (
                                    <div>
                                        <div className="text-xs font-semibold text-slate-500 mb-1">EXECUTION PATHS</div>
                                        <div className="flex flex-wrap gap-1.5">
                                            {flow.paths.slice(0, 3).map((path, j) => (
                                                <span key={j} className={`text-xs px-2 py-0.5 rounded ${
                                                    path.loopInfo ? 'bg-amber-50 text-amber-700' : 'bg-blue-50 text-blue-600'
                                                }`}>
                                                    {path.name || path.id}
                                                    {path.loopInfo && ' â†»'}
                                                </span>
                                            ))}
                                            {flow.paths.length > 3 && (
                                                <span className="text-xs text-slate-400">
                                                    +{flow.paths.length - 3} more
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* Footer */}
                            <div className="px-4 py-2 bg-slate-50 border-t border-slate-100 flex items-center justify-between">
                                <div className="flex items-center gap-3 text-xs text-slate-500">
                                    {flow.filePath && (
                                        <span>Source: <strong className="text-slate-600 font-mono">{flow.filePath.split('/').pop()}</strong></span>
                                    )}
                                </div>
                                <span className="text-fuchsia-600 text-xs font-medium flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                    View Details <Icons.ChevronRight />
                                </span>
                            </div>
                        </div>
                    );
                })}
                
                {flows.length === 0 && (
                    <div className="text-center py-12 bg-white rounded-lg border border-slate-200">
                        <div className="w-12 h-12 rounded-full bg-fuchsia-100 flex items-center justify-center mx-auto mb-4 text-fuchsia-600">
                            <Icons.Activity />
                        </div>
                        <h3 className="font-medium text-slate-900 mb-1">No flows found</h3>
                        <p className="text-slate-500 text-sm">
                            Run <code className="bg-slate-100 px-1 rounded">identro-eval analyze</code> to discover flows.
                        </p>
                        <p className="text-slate-400 text-xs mt-2">
                            Flows are multi-crew workflow orchestrations using CrewAI's Flow class.
                        </p>
                    </div>
                )}
            </div>
        </div>
    );
};


// === components/views/flow-detail.jsx ===
/**
 * FlowChartRenderer - Renders ASCII-style flowchart with proper branching
 * Shows the flow structure with visual splits for routers
 */
const FlowChartRenderer = ({ flowChart, flowName, flow }) => {
    const [showRaw, setShowRaw] = React.useState(false);
    
    // Extract methods from flow data for accurate diagram
    const methods = flow?.methods || [];
    const paths = flow?.paths || [];
    
    // Build step graph from flow data
    const buildStepGraph = () => {
        const graph = {
            nodes: [],
            edges: [],
            routerRoutes: {}
        };
        
        // Find start methods
        const starts = methods.filter(m => m.type === 'start' || m.isStart);
        const routers = methods.filter(m => m.type === 'router');
        const listeners = methods.filter(m => m.type === 'listener');
        
        // Add all nodes
        starts.forEach(s => graph.nodes.push({ id: s.name, type: 'start', label: s.name }));
        routers.forEach(r => {
            graph.nodes.push({ id: r.name, type: 'router', label: r.name, routerFor: r.routerFor });
            // Parse routes from routerFor
            if (r.routerFor) {
                const routes = r.routerFor.split(',').map(s => s.trim());
                graph.routerRoutes[r.name] = routes;
            }
        });
        listeners.forEach(l => {
            const isHitl = l.name.toLowerCase().includes('human') || l.name.toLowerCase().includes('hitl');
            graph.nodes.push({ 
                id: l.name, 
                type: isHitl ? 'hitl' : 'listener', 
                label: l.name,
                triggeredBy: l.triggeredBy || (l.listensTo ? l.listensTo.split(',').map(s => s.trim()) : [])
            });
        });
        
        return graph;
    };
    
    const graph = buildStepGraph();
    
    // Generate ASCII diagram with branching
    const generateAsciiDiagram = () => {
        if (methods.length === 0 && !flowChart) {
            return 'No flow structure available';
        }
        
        // If we have methods data, build from that
        if (methods.length > 0) {
            const lines = [];
            const starts = methods.filter(m => m.type === 'start' || m.isStart);
            const routers = methods.filter(m => m.type === 'router');
            const listeners = methods.filter(m => m.type === 'listener');
            
            // Helper to draw a box
            const drawBox = (text, type) => {
                const width = Math.max(text.length + 4, 20);
                const pad = (s, w) => s + ' '.repeat(Math.max(0, w - s.length));
                const border = type === 'router' ? 'â—‡' : type === 'start' ? 'â—' : type === 'hitl' ? 'â—‰' : 'â–¡';
                return [
                    `â”Œ${'â”€'.repeat(width)}â”`,
                    `â”‚ ${border} ${pad(text, width - 4)} â”‚`,
                    `â””${'â”€'.repeat(width)}â”˜`
                ];
            };
            
            // Start
            lines.push('');
            lines.push('                    â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®');
            lines.push('                    â”‚   START   â”‚');
            lines.push('                    â•°â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â•¯');
            lines.push('                          â”‚');
            
            // Find sequential flow before router
            const beforeRouter = [];
            const afterRouter = {};
            
            // Group listeners by what triggers them
            const triggeredBy = {};
            listeners.forEach(l => {
                const triggers = l.triggeredBy || (l.listensTo ? l.listensTo.split(',').map(s => s.trim()) : []);
                triggers.forEach(t => {
                    if (!triggeredBy[t]) triggeredBy[t] = [];
                    triggeredBy[t].push(l);
                });
            });
            
            // Build sequence before router
            let current = starts[0]?.name;
            while (current) {
                beforeRouter.push(current);
                const nextListeners = triggeredBy[current] || [];
                const nonRouteListener = nextListeners.find(l => !routers.some(r => r.name === l.name));
                if (nonRouteListener) {
                    current = nonRouteListener.name;
                } else {
                    break;
                }
            }
            
            // Draw sequential steps
            beforeRouter.forEach((step, i) => {
                lines.push(`                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”`);
                lines.push(`                    â”‚  ${step.padEnd(24)}  â”‚`);
                lines.push(`                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`);
                if (i < beforeRouter.length - 1) {
                    lines.push('                                 â”‚');
                }
            });
            
            // Router with branches
            if (routers.length > 0) {
                const router = routers[0];
                const routes = router.routerFor?.split(',').map(s => s.trim()) || [];
                
                lines.push('                                 â”‚');
                lines.push('                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
                lines.push(`                    â”‚  ${router.name.padEnd(24)}  â”‚`);
                lines.push('                    â”‚         @router            â”‚');
                lines.push('                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
                
                if (routes.length >= 2) {
                    lines.push('                                 â”‚');
                    lines.push('              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
                    lines.push('              â”‚                                     â”‚');
                    lines.push(`         "${routes[0]}"                         "${routes[1] || 'path_2'}"`);
                    lines.push('              â”‚                                     â”‚');
                    lines.push('              â–¼                                     â–¼');
                    
                    // Find handlers for each route
                    const leftHandler = listeners.find(l => l.triggeredBy?.includes(routes[0]) || l.listensTo?.includes(routes[0]));
                    const rightHandler = listeners.find(l => l.triggeredBy?.includes(routes[1]) || l.listensTo?.includes(routes[1]));
                    
                    const leftName = leftHandler?.name || `handle_${routes[0]}`;
                    const rightName = rightHandler?.name || `handle_${routes[1] || 'path_2'}`;
                    
                    const leftHitl = leftName.toLowerCase().includes('human');
                    const rightHitl = rightName.toLowerCase().includes('human');
                    
                    lines.push(`  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”`);
                    lines.push(`  â”‚ ${leftHitl ? 'â—‰' : 'â–¡'} ${leftName.substring(0, 18).padEnd(18)} â”‚       â”‚ ${rightHitl ? 'â—‰' : 'â–¡'} ${rightName.substring(0, 18).padEnd(18)} â”‚`);
                    if (leftHitl || rightHitl) {
                        lines.push(`  â”‚   ${leftHitl ? 'Human Input' : '            '}        â”‚       â”‚   ${rightHitl ? 'Human Input' : '            '}        â”‚`);
                    }
                    lines.push(`  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`);
                    lines.push('              â”‚                               â”‚');
                    lines.push('              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
                }
                
                // Finalize
                const finalize = listeners.find(l => l.name.includes('finalize') || l.name.includes('final'));
                if (finalize) {
                    lines.push('                                â”‚');
                    lines.push('                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
                    lines.push(`                    â”‚  ${finalize.name.padEnd(24)}  â”‚`);
                    lines.push('                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
                }
            }
            
            lines.push('                                 â”‚');
            lines.push('                          â•­â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â•®');
            lines.push('                          â”‚    END    â”‚');
            lines.push('                          â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯');
            lines.push('');
            
            return lines.join('\n');
        }
        
        // Fallback to parsing flowChart text
        return flowChart;
    };
    
    const asciiDiagram = generateAsciiDiagram();
    
    return (
        <div className="space-y-6">
            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-semibold text-slate-900">Flow Diagram</h2>
                    <div className="flex gap-2">
                        <button
                            onClick={() => setShowRaw(!showRaw)}
                            className="text-xs px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg transition-colors"
                        >
                            {showRaw ? 'Show Diagram' : 'Show Raw Data'}
                        </button>
                    </div>
                </div>
                
                {/* Legend */}
                <div className="flex flex-wrap gap-4 mb-4 pb-4 border-b border-slate-200 text-xs">
                    <div className="flex items-center gap-2">
                        <span className="w-4 h-4 bg-green-100 border border-green-300 rounded flex items-center justify-center text-green-600">â—</span>
                        <span className="text-slate-600">Start/End</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <span className="w-4 h-4 bg-fuchsia-100 border border-fuchsia-300 rounded flex items-center justify-center text-fuchsia-600">â–¡</span>
                        <span className="text-slate-600">Step</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <span className="w-4 h-4 bg-orange-100 border border-orange-300 rounded flex items-center justify-center text-orange-600">â—‡</span>
                        <span className="text-slate-600">Router (Decision)</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <span className="w-4 h-4 bg-teal-100 border border-teal-300 rounded flex items-center justify-center text-teal-600">â—‰</span>
                        <span className="text-slate-600">Human Input</span>
                    </div>
                </div>
                
                {showRaw ? (
                    <div className="bg-slate-900 rounded-lg p-4 overflow-x-auto">
                        <pre className="text-xs text-slate-300 font-mono whitespace-pre">
                            {flowChart || JSON.stringify({ methods, paths }, null, 2)}
                        </pre>
                    </div>
                ) : (
                    <div className="bg-slate-50 rounded-lg p-6 overflow-x-auto border border-slate-200">
                        <pre className="font-mono text-sm text-slate-700 whitespace-pre leading-relaxed">
                            {asciiDiagram}
                        </pre>
                    </div>
                )}
            </div>
        </div>
    );
};

/**
 * Flow Detail View
 * Displays detailed information about a specific flow
 * Organized with tabs: Overview, Paths, Crews, HITL, Boundaries, Flowchart
 */

const FlowDetailView = ({ flowId, onBack }) => {
    const data = window.IdentroData;
    const flows = data?.flows || [];
    const flow = flows.find(f => f.id === flowId || f.name === flowId);
    
    const [activeTab, setActiveTab] = useState('overview');
    const [expandedPaths, setExpandedPaths] = useState({});
    const [expandedHitl, setExpandedHitl] = useState({});
    const [boundaryType, setBoundaryType] = useState('allowed');
    const [showBoundarySources, setShowBoundarySources] = useState(null);
    
    // For mermaid rendering
    const mermaidRef = React.useRef(null);
    const [mermaidSvg, setMermaidSvg] = useState(null);
    
    if (!flow) {
        return (
            <div className="animate-in">
                <button 
                    onClick={onBack}
                    className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 mb-6 transition-colors"
                >
                    <Icons.ArrowLeft />
                    Back to Flows
                </button>
                <div className="text-center py-12 text-slate-500">
                    Flow not found
                </div>
            </div>
        );
    }
    
    const contract = flow.contract || {};
    const boundaries = flow.boundaries || contract.boundaries || {};
    const paths = flow.paths || [];
    const crews = flow.crews || [];
    const hitlPoints = flow.humanInteractionPoints || [];
    const flowChart = flow.flowChart;
    const inputSchema = flow.inputSchema;

    const togglePath = (pathId) => {
        setExpandedPaths(prev => ({
            ...prev,
            [pathId]: !prev[pathId]
        }));
    };

    const toggleHitl = (idx) => {
        setExpandedHitl(prev => ({
            ...prev,
            [idx]: !prev[idx]
        }));
    };
    
    // Render mermaid when tab is active - only if flowChart is actual mermaid syntax
    React.useEffect(() => {
        if (activeTab === 'flowchart' && flowChart && window.mermaid) {
            const cleanChart = flowChart.replace(/```mermaid\n?/, '').replace(/```$/, '').trim();
            // Only try mermaid if it looks like mermaid syntax
            const isMermaid = cleanChart.startsWith('graph') || 
                             cleanChart.startsWith('flowchart') || 
                             cleanChart.startsWith('sequenceDiagram') ||
                             cleanChart.startsWith('classDiagram') ||
                             cleanChart.startsWith('stateDiagram');
            if (isMermaid) {
                try {
                    window.mermaid.render('mermaid-flow-' + flow.id, cleanChart).then(({ svg }) => {
                        setMermaidSvg(svg);
                    }).catch(e => {
                        console.log('Mermaid render error:', e);
                        setMermaidSvg(null);
                    });
                } catch (e) {
                    console.log('Mermaid render error:', e);
                    setMermaidSvg(null);
                }
            } else {
                // Not mermaid, will use text-based renderer
                setMermaidSvg(null);
            }
        }
    }, [activeTab, flowChart, flow.id]);
    
    const tasks = flow.tasks || [];
    const agents = flow.agents || [];
    
    // Look up behavioral profile for this flow from report data
    const report = data?.report;
    const behavioralProfiles = report?.behavioralProfiles || {};
    
    // Try to match by flow name (flows are stored by entity name in behavioralProfiles)
    const flowProfile = behavioralProfiles[flow.name] || behavioralProfiles[flow.id] || null;
    const hasProfile = flowProfile !== null;
    
    const tabs = [
        { id: 'overview', label: 'Overview', icon: Icons.FileText },
        { id: 'flowchart', label: 'Flowchart', icon: Icons.Activity },
        { id: 'paths', label: `Paths (${paths.length})`, icon: Icons.Activity },
        { id: 'tasks', label: `Tasks (${tasks.length})`, icon: Icons.CheckCircle },
        { id: 'boundaries', label: 'Boundaries', icon: Icons.Shield },
        { id: 'crews', label: `Crews (${crews.length})`, icon: Icons.Users },
        { id: 'hitl', label: `HITL (${hitlPoints.length})`, icon: Icons.User },
        ...(inputSchema && inputSchema.parameters?.length > 0 ? [{ id: 'input', label: 'Input Schema', icon: Icons.Terminal }] : []),
        ...(hasProfile ? [{ id: 'profile', label: 'Behavior Profile', icon: Icons.BarChart }] : []),
    ];

    return (
        <div className="animate-in">
            {/* Back Button */}
            <button 
                onClick={onBack}
                className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 mb-6 transition-colors"
            >
                <Icons.ArrowLeft />
                Back to Flows
            </button>
            
            {/* Header */}
            <div className="flex items-start justify-between mb-6">
                <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                        <div className="w-12 h-12 rounded-xl bg-fuchsia-100 flex items-center justify-center text-fuchsia-600">
                            <Icons.Activity />
                        </div>
                        <div>
                            <h1 className="text-2xl font-semibold text-slate-900">{flow.name}</h1>
                            <p className="text-slate-500 text-sm">{flow.type || 'CrewAI Flow'}</p>
                        </div>
                    </div>
                    {flow.description && (
                        <p className="text-slate-600 mt-2 max-w-2xl text-sm">{flow.description}</p>
                    )}
                </div>
            </div>
            
            {/* Compact Metrics Row */}
            <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                <div className="flex items-center gap-6 divide-x divide-slate-200 flex-wrap">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Paths</span>
                        <span className="text-sm font-semibold text-fuchsia-600">{paths.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Steps</span>
                        <span className="text-sm font-semibold text-violet-600">{flow.stepCount || 0}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Crews</span>
                        <span className="text-sm font-semibold text-blue-600">{crews.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">HITL Points</span>
                        <span className="text-sm font-semibold text-teal-600">{hitlPoints.length}</span>
                    </div>
                    {flow.hasRouting && (
                        <div className="flex items-center gap-2 pl-6">
                            <span className="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-medium">Routing</span>
                        </div>
                    )}
                    {flow.hasLoops && (
                        <div className="flex items-center gap-2 pl-6">
                            <span className="px-2 py-0.5 bg-amber-100 text-amber-700 rounded text-xs font-medium">Loops</span>
                        </div>
                    )}
                </div>
            </div>
            
            {/* Tabs */}
            <div className="border-b border-slate-200 mb-6">
                <div className="flex gap-1">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2.5 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${
                                activeTab === tab.id 
                                    ? 'border-fuchsia-500 text-fuchsia-600' 
                                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                            }`}
                        >
                            <tab.icon />
                            {tab.label}
                        </button>
                    ))}
                </div>
            </div>
            
            {/* Tab Content */}
            <div className="min-h-[400px]">
                {/* Overview Tab */}
                {activeTab === 'overview' && (
                    <div className="space-y-6 animate-in">
                        {/* Contract Section */}
                        {(contract.purpose || contract.description || contract.capabilities?.length > 0) && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h2 className="text-lg font-semibold text-slate-900 mb-4">Flow Contract</h2>
                                <div className="grid gap-4">
                                    {contract.purpose && (
                                        <div className="bg-fuchsia-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-fuchsia-700 uppercase tracking-wide mb-2">Purpose</h3>
                                            <p className="text-slate-900 text-sm">{contract.purpose}</p>
                                        </div>
                                    )}
                                    {contract.description && (
                                        <div className="bg-slate-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Description</h3>
                                            <p className="text-slate-900 text-sm">{contract.description}</p>
                                        </div>
                                    )}
                                    {contract.capabilities && contract.capabilities.length > 0 && (
                                        <div className="bg-slate-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Capabilities</h3>
                                            <ul className="space-y-1">
                                                {contract.capabilities.map((cap, i) => (
                                                    <li key={i} className="text-sm text-slate-700 flex items-start gap-2">
                                                        <span className="text-fuchsia-500 mt-1">â€¢</span>
                                                        {cap}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* Quick Stats */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h2 className="text-lg font-semibold text-slate-900 mb-4">Flow Characteristics</h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="bg-slate-50 rounded-lg p-4 text-center">
                                    <div className="text-2xl font-bold text-fuchsia-600">{paths.length}</div>
                                    <div className="text-xs text-slate-500 uppercase mt-1">Execution Paths</div>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4 text-center">
                                    <div className="text-2xl font-bold text-violet-600">{flow.stepCount || 0}</div>
                                    <div className="text-xs text-slate-500 uppercase mt-1">Total Steps</div>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4 text-center">
                                    <div className="text-2xl font-bold text-blue-600">{crews.length}</div>
                                    <div className="text-xs text-slate-500 uppercase mt-1">Crews Used</div>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4 text-center">
                                    <div className="text-2xl font-bold text-teal-600">{hitlPoints.length}</div>
                                    <div className="text-xs text-slate-500 uppercase mt-1">HITL Points</div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Flow Features */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h2 className="text-lg font-semibold text-slate-900 mb-4">Features</h2>
                            <div className="flex flex-wrap gap-3">
                                {flow.hasRouting && (
                                    <div className="flex items-center gap-2 px-4 py-2 bg-orange-50 border border-orange-200 rounded-lg">
                                        <span className="w-3 h-3 rounded-full bg-orange-500"></span>
                                        <span className="text-sm font-medium text-orange-800">Conditional Routing</span>
                                    </div>
                                )}
                                {flow.hasLoops && (
                                    <div className="flex items-center gap-2 px-4 py-2 bg-amber-50 border border-amber-200 rounded-lg">
                                        <span className="w-3 h-3 rounded-full bg-amber-500"></span>
                                        <span className="text-sm font-medium text-amber-800">Contains Loops</span>
                                    </div>
                                )}
                                {hitlPoints.length > 0 && (
                                    <div className="flex items-center gap-2 px-4 py-2 bg-teal-50 border border-teal-200 rounded-lg">
                                        <span className="w-3 h-3 rounded-full bg-teal-500"></span>
                                        <span className="text-sm font-medium text-teal-800">Human-in-the-Loop</span>
                                    </div>
                                )}
                                {crews.length > 1 && (
                                    <div className="flex items-center gap-2 px-4 py-2 bg-blue-50 border border-blue-200 rounded-lg">
                                        <span className="w-3 h-3 rounded-full bg-blue-500"></span>
                                        <span className="text-sm font-medium text-blue-800">Multi-Crew Orchestration</span>
                                    </div>
                                )}
                                {!flow.hasRouting && !flow.hasLoops && hitlPoints.length === 0 && crews.length <= 1 && (
                                    <div className="flex items-center gap-2 px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                                        <span className="w-3 h-3 rounded-full bg-slate-400"></span>
                                        <span className="text-sm font-medium text-slate-600">Simple Linear Flow</span>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* Source Info */}
                        {flow.filePath && (
                            <div className="bg-slate-50 rounded-xl border border-slate-200 p-4 text-sm text-slate-500">
                                <span className="font-medium">Source: </span>
                                <code className="text-xs bg-slate-200 px-2 py-0.5 rounded">{flow.filePath}</code>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Paths Tab */}
                {activeTab === 'paths' && (
                    <div className="animate-in">
                        {paths.length > 0 ? (
                            <div className="space-y-3">
                                {paths.map((path, i) => (
                                    <div key={path.id || i} className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-soft">
                                        <button
                                            onClick={() => togglePath(path.id || i)}
                                            className="w-full p-4 flex items-center justify-between hover:bg-slate-50 transition-colors"
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-lg bg-fuchsia-100 flex items-center justify-center text-fuchsia-600">
                                                    <Icons.Activity />
                                                </div>
                                                <div className="text-left">
                                                    <h3 className="font-medium text-slate-900">{path.name || `Path ${i + 1}`}</h3>
                                                    {path.description && (
                                                        <p className="text-xs text-slate-500 line-clamp-1">{path.description}</p>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                {path.steps && (
                                                    <span className="text-xs bg-violet-100 text-violet-700 px-2 py-0.5 rounded">
                                                        {path.steps.length} steps
                                                    </span>
                                                )}
                                                {path.loopInfo && (
                                                    <span className="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded">
                                                        Loop
                                                    </span>
                                                )}
                                                {path.hitlPoints?.length > 0 && (
                                                    <span className="text-xs bg-teal-100 text-teal-700 px-2 py-0.5 rounded">
                                                        {path.hitlPoints.length} HITL
                                                    </span>
                                                )}
                                                <span className={`transform transition-transform ${expandedPaths[path.id || i] ? 'rotate-180' : ''}`}>
                                                    <Icons.ChevronDown />
                                                </span>
                                            </div>
                                        </button>
                                        {expandedPaths[path.id || i] && (
                                            <div className="p-4 border-t border-slate-200 space-y-4 bg-slate-50">
                                                {path.description && (
                                                    <div>
                                                        <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Description</h4>
                                                        <p className="text-sm text-slate-700">{path.description}</p>
                                                    </div>
                                                )}
                                                
                                                {/* Loop Info */}
                                                {path.loopInfo && (
                                                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                                        <h4 className="text-xs font-semibold text-amber-700 uppercase tracking-wide mb-2">Loop Configuration</h4>
                                                        <div className="grid grid-cols-2 gap-2 text-sm">
                                                            {path.loopInfo.condition && (
                                                                <div>
                                                                    <span className="text-amber-600 font-medium">Condition:</span>
                                                                    <span className="ml-1 text-slate-700">{path.loopInfo.condition}</span>
                                                                </div>
                                                            )}
                                                            {path.loopInfo.maxIterations && (
                                                                <div>
                                                                    <span className="text-amber-600 font-medium">Max Iterations:</span>
                                                                    <span className="ml-1 text-slate-700">{path.loopInfo.maxIterations}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Steps */}
                                                {path.steps && path.steps.length > 0 && (
                                                    <div>
                                                        <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Steps</h4>
                                                        <div className="space-y-2">
                                                            {path.steps.map((step, j) => (
                                                                <div key={j} className="flex items-start gap-3 bg-white rounded-lg p-3 border border-slate-200">
                                                                    <span className="w-6 h-6 rounded-full bg-fuchsia-100 text-fuchsia-700 flex items-center justify-center text-xs font-bold flex-shrink-0">
                                                                        {j + 1}
                                                                    </span>
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className="flex items-center gap-2 flex-wrap">
                                                                            <span className="font-medium text-slate-900 text-sm">{step.name || step.method || `Step ${j + 1}`}</span>
                                                                            {step.type && (
                                                                                <span className="text-xs px-1.5 py-0.5 bg-slate-100 text-slate-600 rounded">
                                                                                    {step.type}
                                                                                </span>
                                                                            )}
                                                                            {step.crewName && (
                                                                                <span className="text-xs px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded">
                                                                                    {step.crewName}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                        {step.description && (
                                                                            <p className="text-xs text-slate-500 mt-1">{step.description}</p>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Crew Invocations */}
                                                {path.crewInvocations && path.crewInvocations.length > 0 && (
                                                    <div>
                                                        <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Crew Invocations</h4>
                                                        <div className="flex flex-wrap gap-2">
                                                            {path.crewInvocations.map((crew, j) => (
                                                                <span key={j} className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">
                                                                    {crew.crewName || crew}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-12 text-slate-500">
                                No execution paths defined for this flow
                            </div>
                        )}
                    </div>
                )}
                
                {/* Tasks Tab */}
                {activeTab === 'tasks' && (
                    <div className="animate-in">
                        {tasks.length > 0 ? (
                            <div className="space-y-3">
                                {tasks.map((task, i) => (
                                    <div key={task.name || i} className="bg-white border border-slate-200 rounded-xl p-4 shadow-soft">
                                        <div className="flex items-start justify-between">
                                            <div className="flex items-start gap-3 flex-1 min-w-0">
                                                <div className="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center text-amber-600 flex-shrink-0">
                                                    <Icons.CheckCircle />
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2 flex-wrap mb-1">
                                                        <h3 className="font-medium text-slate-900">{task.name}</h3>
                                                        {task.crew && (
                                                            <span className="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full">
                                                                {task.crew}
                                                            </span>
                                                        )}
                                                        {task.agent && (
                                                            <span className="text-xs px-2 py-0.5 bg-violet-100 text-violet-700 rounded-full flex items-center gap-1">
                                                                <Icons.User size={10} />
                                                                {task.agent}
                                                            </span>
                                                        )}
                                                    </div>
                                                    {task.description && (
                                                        <p className="text-sm text-slate-600 line-clamp-2">{task.description}</p>
                                                    )}
                                                    {task.expectedOutput && (
                                                        <div className="mt-2 pt-2 border-t border-slate-100">
                                                            <span className="text-xs font-medium text-slate-500">Expected Output: </span>
                                                            <span className="text-xs text-slate-600 line-clamp-1">{task.expectedOutput}</span>
                                                        </div>
                                                    )}
                                                    {task.tools && task.tools.length > 0 && (
                                                        <div className="flex items-center gap-1.5 mt-2">
                                                            <Icons.Wrench size={12} className="text-slate-400" />
                                                            <div className="flex flex-wrap gap-1">
                                                                {task.tools.map((tool, j) => (
                                                                    <span key={j} className="text-xs px-1.5 py-0.5 bg-slate-100 text-slate-600 rounded">
                                                                        {tool}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-12 text-slate-500">
                                No tasks defined for this flow
                            </div>
                        )}
                    </div>
                )}
                
                {/* Crews Tab */}
                {activeTab === 'crews' && (
                    <div className="animate-in">
                        {crews.length > 0 ? (
                            <div className="space-y-3">
                                {crews.map((crew, i) => (
                                    <div key={crew.name || i} className="bg-white border border-slate-200 rounded-xl p-4 shadow-soft">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600">
                                                    <Icons.Users />
                                                </div>
                                                <div>
                                                    <h3 className="font-medium text-slate-900">{crew.name}</h3>
                                                    {crew.description && (
                                                        <p className="text-xs text-slate-500">{crew.description}</p>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                {crew.agentCount !== undefined && (
                                                    <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                                                        {crew.agentCount} agents
                                                    </span>
                                                )}
                                                {crew.taskCount !== undefined && (
                                                    <span className="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded">
                                                        {crew.taskCount} tasks
                                                    </span>
                                                )}
                                                {crew.process && (
                                                    <span className="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded capitalize">
                                                        {crew.process}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        {crew.role && (
                                            <div className="mt-3 pt-3 border-t border-slate-100">
                                                <span className="text-xs font-medium text-slate-500">Role in flow: </span>
                                                <span className="text-sm text-slate-700">{crew.role}</span>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-12 text-slate-500">
                                No crews defined for this flow
                            </div>
                        )}
                    </div>
                )}
                
                {/* HITL Tab */}
                {activeTab === 'hitl' && (
                    <div className="animate-in">
                        {hitlPoints.length > 0 ? (
                            <div className="space-y-3">
                                {hitlPoints.map((hitl, i) => (
                                    <div key={i} className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-soft">
                                        <button
                                            onClick={() => toggleHitl(i)}
                                            className="w-full p-4 flex items-center justify-between hover:bg-slate-50 transition-colors"
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center text-teal-600">
                                                    <Icons.User />
                                                </div>
                                                <div className="text-left">
                                                    <h3 className="font-medium text-slate-900">{hitl.name || hitl.method || `HITL Point ${i + 1}`}</h3>
                                                    <p className="text-xs text-slate-500">{hitl.type || 'Human Interaction'}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                {hitl.blocking && (
                                                    <span className="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">
                                                        Blocking
                                                    </span>
                                                )}
                                                {hitl.options && hitl.options.length > 0 && (
                                                    <span className="text-xs bg-teal-100 text-teal-700 px-2 py-0.5 rounded">
                                                        {hitl.options.length} options
                                                    </span>
                                                )}
                                                <span className={`transform transition-transform ${expandedHitl[i] ? 'rotate-180' : ''}`}>
                                                    <Icons.ChevronDown />
                                                </span>
                                            </div>
                                        </button>
                                        {expandedHitl[i] && (
                                            <div className="p-4 border-t border-slate-200 space-y-4 bg-slate-50">
                                                {/* Prompt */}
                                                {hitl.prompt && (
                                                    <div className="bg-teal-50 border border-teal-200 rounded-lg p-3">
                                                        <h4 className="text-xs font-semibold text-teal-700 uppercase tracking-wide mb-2">Prompt</h4>
                                                        <p className="text-sm text-slate-700">{hitl.prompt}</p>
                                                    </div>
                                                )}
                                                
                                                {/* Decorator Info */}
                                                {hitl.decorator && (
                                                    <div>
                                                        <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Decorator</h4>
                                                        <code className="text-xs bg-slate-200 px-2 py-1 rounded text-slate-700">{hitl.decorator}</code>
                                                    </div>
                                                )}
                                                
                                                {/* Options */}
                                                {hitl.options && hitl.options.length > 0 && (
                                                    <div>
                                                        <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Available Options</h4>
                                                        <div className="flex flex-wrap gap-2">
                                                            {hitl.options.map((opt, j) => (
                                                                <span key={j} className="px-3 py-1.5 bg-white border border-teal-200 text-teal-700 rounded-lg text-sm">
                                                                    {opt}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Additional Details */}
                                                <div className="flex flex-wrap gap-4 text-sm">
                                                    {hitl.blocking !== undefined && (
                                                        <div>
                                                            <span className="text-slate-500">Blocking:</span>
                                                            <span className={`ml-1 font-medium ${hitl.blocking ? 'text-red-600' : 'text-green-600'}`}>
                                                                {hitl.blocking ? 'Yes' : 'No'}
                                                            </span>
                                                        </div>
                                                    )}
                                                    {hitl.method && (
                                                        <div>
                                                            <span className="text-slate-500">Method:</span>
                                                            <code className="ml-1 text-xs bg-slate-200 px-1.5 py-0.5 rounded">{hitl.method}</code>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-12 text-slate-500">
                                <div className="mb-2">No human-in-the-loop interaction points</div>
                                <p className="text-xs">This flow runs fully autonomously without human intervention</p>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Boundaries Tab */}
                {activeTab === 'boundaries' && (
                    <div className="animate-in">
                        {boundaries && (boundaries.allowed?.length > 0 || boundaries.forbidden?.length > 0) ? (
                            <div className="bg-white rounded-xl border border-slate-200 shadow-soft">
                                {/* Inline tabs for allowed/forbidden */}
                                <div className="flex border-b border-slate-200">
                                    <button
                                        onClick={() => setBoundaryType('allowed')}
                                        className={`flex-1 px-4 py-3 text-sm font-medium flex items-center justify-center gap-2 ${
                                            boundaryType === 'allowed'
                                                ? 'bg-emerald-50 text-emerald-700 border-b-2 border-emerald-500'
                                                : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                                        }`}
                                    >
                                        <span className="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs">âœ“</span>
                                        Allowed
                                        <span className={`px-2 py-0.5 rounded-full text-xs ${
                                            boundaryType === 'allowed' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'
                                        }`}>
                                            {boundaries.allowed?.length || 0}
                                        </span>
                                    </button>
                                    <button
                                        onClick={() => setBoundaryType('forbidden')}
                                        className={`flex-1 px-4 py-3 text-sm font-medium flex items-center justify-center gap-2 ${
                                            boundaryType === 'forbidden'
                                                ? 'bg-red-50 text-red-700 border-b-2 border-red-500'
                                                : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                                        }`}
                                    >
                                        <span className="w-5 h-5 rounded-full bg-red-500 flex items-center justify-center text-white text-xs">âœ•</span>
                                        Forbidden
                                        <span className={`px-2 py-0.5 rounded-full text-xs ${
                                            boundaryType === 'forbidden' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'
                                        }`}>
                                            {boundaries.forbidden?.length || 0}
                                        </span>
                                    </button>
                                </div>
                                
                                {/* Content */}
                                <div className="p-4">
                                    {boundaryType === 'allowed' && boundaries.allowed && boundaries.allowed.length > 0 && (
                                        <div className="space-y-2">
                                            {boundaries.allowed.map((item, i) => (
                                                <div key={i} className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                                    <div className="flex items-start justify-between gap-3">
                                                        <div className="flex-1 min-w-0">
                                                            <p className="text-sm text-slate-800">{item.action}</p>
                                                            {(item.agent || item.sharedBy?.length > 0) && (
                                                                <div className="flex items-center gap-1.5 mt-1.5">
                                                                    <Icons.User size={12} className="text-emerald-600" />
                                                                    {item.agent && (
                                                                        <span className="text-xs px-1.5 py-0.5 bg-emerald-100 text-emerald-700 rounded">
                                                                            {item.agent}
                                                                        </span>
                                                                    )}
                                                                    {item.sharedBy?.map((crew, j) => (
                                                                        <span key={j} className="text-xs px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded">
                                                                            {crew}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-xs font-medium flex-shrink-0">
                                                            {Math.round((item.confidence || 0) * 100)}%
                                                        </span>
                                                    </div>
                                                    {item.evidence && (
                                                        <div className="mt-2 pt-2 border-t border-emerald-200">
                                                            <p className="text-xs text-emerald-700 line-clamp-2">{item.evidence}</p>
                                                            <button 
                                                                onClick={() => setShowBoundarySources(item)}
                                                                className="text-emerald-600 hover:text-emerald-700 text-xs underline mt-1"
                                                            >
                                                                View full evidence
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {boundaryType === 'allowed' && (!boundaries.allowed || boundaries.allowed.length === 0) && (
                                        <div className="text-center py-8 text-slate-500 text-sm">
                                            No allowed actions defined
                                        </div>
                                    )}
                                    
                                    {boundaryType === 'forbidden' && boundaries.forbidden && boundaries.forbidden.length > 0 && (
                                        <div className="space-y-2">
                                            {boundaries.forbidden.map((item, i) => (
                                                <div key={i} className="bg-red-50 border border-red-200 rounded-lg p-3">
                                                    <div className="flex items-start justify-between gap-3">
                                                        <div className="flex-1 min-w-0">
                                                            <p className="text-sm text-slate-800">{item.action}</p>
                                                            {(item.agent || item.sharedBy?.length > 0) && (
                                                                <div className="flex items-center gap-1.5 mt-1.5">
                                                                    <Icons.User size={12} className="text-red-600" />
                                                                    {item.agent && (
                                                                        <span className="text-xs px-1.5 py-0.5 bg-red-100 text-red-700 rounded">
                                                                            {item.agent}
                                                                        </span>
                                                                    )}
                                                                    {item.sharedBy?.map((crew, j) => (
                                                                        <span key={j} className="text-xs px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded">
                                                                            {crew}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-medium flex-shrink-0">
                                                            {Math.round((item.confidence || 0) * 100)}%
                                                        </span>
                                                    </div>
                                                    {item.evidence && (
                                                        <div className="mt-2 pt-2 border-t border-red-200">
                                                            <p className="text-xs text-red-700 line-clamp-2">{item.evidence}</p>
                                                            <button 
                                                                onClick={() => setShowBoundarySources(item)}
                                                                className="text-red-600 hover:text-red-700 text-xs underline mt-1"
                                                            >
                                                                View full evidence
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {boundaryType === 'forbidden' && (!boundaries.forbidden || boundaries.forbidden.length === 0) && (
                                        <div className="text-center py-8 text-slate-500 text-sm">
                                            No forbidden actions defined
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="text-center py-12 text-slate-500">
                                No boundaries defined for this flow
                            </div>
                        )}
                    </div>
                )}
                
                {/* Flowchart Tab */}
                {activeTab === 'flowchart' && (
                    <div className="animate-in">
                        {(flowChart || flow.methods?.length > 0) ? (
                            <FlowChartRenderer flowChart={flowChart} flowName={flow.name} flow={flow} />
                        ) : (
                            <div className="text-center py-12 text-slate-500">
                                <div className="mb-2">No flowchart available</div>
                                <p className="text-xs">Run analysis to generate a flow diagram</p>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Behavior Profile Tab */}
                {activeTab === 'profile' && hasProfile && (
                    <div className="animate-in">
                        <BehaviorProfile 
                            profile={{
                                ...flowProfile,
                                entityName: flow.name,
                                entityType: 'flow'
                            }}
                        />
                    </div>
                )}
                
                {/* Input Schema Tab */}
                {activeTab === 'input' && inputSchema && (
                    <div className="space-y-6 animate-in">
                        {/* Summary */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-lg font-semibold text-slate-900">Input Schema</h2>
                                <div className="flex items-center gap-2">
                                    {inputSchema.confidence && (
                                        <span className="text-xs bg-fuchsia-100 text-fuchsia-700 px-2 py-1 rounded-full font-medium">
                                            {Math.round(inputSchema.confidence * 100)}% confidence
                                        </span>
                                    )}
                                    {inputSchema.input_method && (
                                        <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-full font-medium">
                                            {inputSchema.input_method}
                                        </span>
                                    )}
                                </div>
                            </div>
                            
                            <p className="text-sm text-slate-600 mb-4">
                                {inputSchema.parameters?.length || 0} parameter(s) detected for this flow
                            </p>
                        </div>
                        
                        {/* Parameters */}
                        <div className="bg-white rounded-xl border border-slate-200 shadow-soft overflow-hidden">
                            <div className="p-4 border-b border-slate-200">
                                <h3 className="text-sm font-semibold text-slate-700">Parameters</h3>
                            </div>
                            <div className="divide-y divide-slate-100">
                                {inputSchema.parameters?.map((param, i) => (
                                    <div key={i} className="px-4 py-3 hover:bg-slate-50 transition-colors">
                                        <div className="flex items-start gap-3">
                                            {/* Name and badges */}
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 flex-wrap mb-1">
                                                    <span className="font-mono text-sm font-semibold text-slate-900">{param.name}</span>
                                                    <span className="text-xs bg-fuchsia-100 text-fuchsia-700 px-1.5 py-0.5 rounded font-medium">
                                                        {param.type || param.raw_type || 'string'}
                                                    </span>
                                                    {param.required !== false && (
                                                        <span className="text-xs text-red-600 font-medium">*</span>
                                                    )}
                                                </div>
                                                {param.description && (
                                                    <p className="text-xs text-slate-500 line-clamp-2">{param.description}</p>
                                                )}
                                            </div>
                                            {/* Example value on the right */}
                                            {param.examples && param.examples.length > 0 && (
                                                <div className="flex-shrink-0 text-right">
                                                    <code className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded font-mono">
                                                        {typeof param.examples[0] === 'string' 
                                                            ? (param.examples[0].length > 20 ? param.examples[0].substring(0, 20) + '...' : param.examples[0])
                                                            : JSON.stringify(param.examples[0]).substring(0, 20) + '...'}
                                                    </code>
                                                </div>
                                            )}
                                        </div>
                                        {/* Usage tags inline */}
                                        {(param.usedInTasks?.length > 0) && (
                                            <div className="flex items-center gap-1 mt-2">
                                                <span className="text-xs text-slate-400">â†’</span>
                                                {param.usedInTasks.slice(0, 3).map((t, j) => (
                                                    <span key={j} className="text-xs px-1.5 py-0.5 bg-purple-50 text-purple-600 rounded">
                                                        {t}
                                                    </span>
                                                ))}
                                                {param.usedInTasks.length > 3 && (
                                                    <span className="text-xs text-slate-400">+{param.usedInTasks.length - 3} more</span>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Example Inputs */}
                        {inputSchema.exampleInputs && inputSchema.exampleInputs.length > 0 && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h3 className="text-sm font-semibold text-slate-700 mb-4">Example Input</h3>
                                <pre className="text-xs bg-slate-50 border border-slate-200 rounded-lg p-4 text-slate-700 overflow-x-auto">
                                    {JSON.stringify(inputSchema.exampleInputs[0], null, 2)}
                                </pre>
                            </div>
                        )}
                    </div>
                )}
            </div>
            
            {/* Boundary Sources Modal */}
            {showBoundarySources && ReactDOM.createPortal(
                <div 
                    className="fixed inset-0 bg-black/50 flex items-center justify-center p-4"
                    style={{ zIndex: 9999 }}
                    onClick={() => setShowBoundarySources(null)}
                >
                    <div 
                        className="bg-white rounded-xl max-w-2xl w-full p-6 shadow-xl"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex items-start justify-between mb-4 pb-4 border-b border-slate-200">
                            <div>
                                <h3 className="text-lg font-semibold text-slate-900">Boundary Evidence</h3>
                                <p className="text-sm text-slate-500 mt-1">{showBoundarySources.action}</p>
                            </div>
                            <button 
                                onClick={() => setShowBoundarySources(null)}
                                className="text-slate-400 hover:text-slate-600"
                            >
                                <Icons.X />
                            </button>
                        </div>
                        
                        <div className="mb-4 p-4 bg-fuchsia-50 rounded-lg">
                            <div className="flex items-center justify-between">
                                <span className="text-sm font-semibold text-slate-700">Confidence</span>
                                <span className="text-xl font-bold text-fuchsia-600">
                                    {Math.round((showBoundarySources.confidence || 0) * 100)}%
                                </span>
                            </div>
                        </div>
                        
                        {showBoundarySources.evidence && (
                            <div className="bg-slate-50 rounded-lg p-4">
                                <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Evidence</h4>
                                <pre className="text-sm text-slate-800 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-slate-200 max-h-60 overflow-y-auto">
                                    {showBoundarySources.evidence}
                                </pre>
                            </div>
                        )}
                        
                        <div className="mt-6 flex justify-end">
                            <button 
                                onClick={() => setShowBoundarySources(null)}
                                className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </div>
    );
};


// === components/views/crews.jsx ===
/**
 * Crews View
 * Displays list of crews with their agents, tools, and configurations
 */

const CrewsView = ({ onSelectCrew }) => {
    const data = window.IdentroData;
    const crews = data?.crews || [];
    
    // Calculate unique counts across all crews
    const uniqueAgents = new Set();
    const uniqueTools = new Set();
    const uniqueTasks = new Set();
    
    crews.forEach(crew => {
        // Collect unique agents
        (crew.agents || []).forEach(a => {
            uniqueAgents.add(a.name);
            // Also collect tools from agents
            (a.tools || []).forEach(t => uniqueTools.add(t));
        });
        // Collect crew-level tools
        (crew.tools || []).forEach(t => uniqueTools.add(t));
        // Collect unique tasks
        (crew.tasks || []).forEach(t => uniqueTasks.add(t.name));
    });

    return (
        <div className="animate-in">
            <Header 
                title="Crews" 
                subtitle="AI agent teams and their configurations"
            />
            
            {/* Compact Metrics Row */}
            <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                <div className="flex items-center gap-6 divide-x divide-slate-200">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Crews</span>
                        <span className="text-sm font-semibold text-slate-900">{crews.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Agents</span>
                        <span className="text-sm font-semibold text-blue-600">{uniqueAgents.size}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Tools</span>
                        <span className="text-sm font-semibold text-emerald-600">{uniqueTools.size}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Tasks</span>
                        <span className="text-sm font-semibold text-amber-600">{uniqueTasks.size}</span>
                    </div>
                </div>
            </div>

            {/* Crews List */}
            <div className="space-y-3">
                {crews.map((crew, i) => {
                    const agentCount = crew.agentCount || crew.agents?.length || 0;
                    const taskCount = crew.taskCount || crew.tasks?.length || 0;
                    const toolCount = crew.toolCount || crew.tools?.length || 0;
                    const boundaries = crew.boundaries || crew.contract?.boundaries;
                    const boundaryCount = (boundaries?.allowed?.length || 0) + (boundaries?.forbidden?.length || 0);
                    
                    return (
                        <div 
                            key={crew.id || i}
                            onClick={() => onSelectCrew && onSelectCrew(crew.name)}
                            className="bg-white rounded-lg border border-slate-200 shadow-soft hover:shadow-card hover:border-slate-300 transition-all cursor-pointer animate-in group overflow-hidden"
                            style={{ animationDelay: `${i * 0.05}s` }}
                        >
                            {/* Header Section */}
                            <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                                <div className="flex items-start justify-between">
                                    <div className="flex items-start gap-3 flex-1 min-w-0">
                                        <div className="mt-0.5 w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-violet-100 text-violet-600">
                                            <Icons.Users />
                                        </div>
                                        <div className="min-w-0 flex-1">
                                            {/* Badges row */}
                                            <div className="flex items-center gap-2 mb-1.5 flex-wrap">
                                                {/* Agents count */}
                                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                                                    {agentCount} agent{agentCount !== 1 ? 's' : ''}
                                                </span>
                                                
                                                {/* Tasks count */}
                                                {taskCount > 0 && (
                                                    <span className="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded">
                                                        {taskCount} task{taskCount !== 1 ? 's' : ''}
                                                    </span>
                                                )}
                                                
                                                {/* Tools count */}
                                                {toolCount > 0 && (
                                                    <span className="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded">
                                                        {toolCount} tool{toolCount !== 1 ? 's' : ''}
                                                    </span>
                                                )}
                                                
                                                {/* Boundaries indicator */}
                                                {boundaryCount > 0 && (
                                                    <span className="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded">
                                                        {boundaryCount} boundaries
                                                    </span>
                                                )}
                                            </div>
                                            
                                            {/* Crew name - blue link style */}
                                            <p className="text-sm font-semibold text-blue-600 group-hover:text-blue-700 transition-colors">
                                                {crew.name}
                                            </p>
                                            
                                            {/* Process type line */}
                                            <div className="flex items-center gap-2 mt-1 text-xs text-slate-500">
                                                <span className="capitalize">{crew.process || 'sequential'} process</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Right side - index number */}
                                    <div className="flex-shrink-0 ml-4">
                                        <span className="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded font-medium">#{i + 1}</span>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Body Section */}
                            <div className="p-4 space-y-3">
                                {/* Crew description */}
                                {crew.description && (
                                    <div>
                                        <div className="text-xs font-semibold text-slate-500 mb-1">DESCRIPTION</div>
                                        <div className="bg-slate-50 p-2 rounded text-xs text-slate-700 line-clamp-2 border border-slate-100">
                                            {crew.description}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Agent names preview */}
                                {crew.agents && crew.agents.length > 0 && (
                                    <div>
                                        <div className="text-xs font-semibold text-slate-500 mb-1">AGENTS</div>
                                        <div className="flex flex-wrap gap-1.5">
                                            {crew.agents.slice(0, 4).map((agent, j) => (
                                                <span key={j} className="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded">
                                                    {agent.name}
                                                </span>
                                            ))}
                                            {crew.agents.length > 4 && (
                                                <span className="text-xs text-slate-400">
                                                    +{crew.agents.length - 4} more
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* Footer */}
                            <div className="px-4 py-2 bg-slate-50 border-t border-slate-100 flex items-center justify-between">
                                <div className="flex items-center gap-3 text-xs text-slate-500">
                                    {crew.filePath && (
                                        <span>Source: <strong className="text-slate-600 font-mono">{crew.filePath.split('/').pop()}</strong></span>
                                    )}
                                </div>
                                <span className="text-blue-600 text-xs font-medium flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                    View Details <Icons.ChevronRight />
                                </span>
                            </div>
                        </div>
                    );
                })}
                
                {crews.length === 0 && (
                    <div className="text-center py-12 bg-white rounded-lg border border-slate-200">
                        <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                            <Icons.Users />
                        </div>
                        <h3 className="font-medium text-slate-900 mb-1">No crews found</h3>
                        <p className="text-slate-500 text-sm">
                            Run <code className="bg-slate-100 px-1 rounded">identro-eval analyze</code> to discover crews.
                        </p>
                    </div>
                )}
            </div>
        </div>
    );
};


// === components/views/crew-detail.jsx ===
/**
 * Crew Detail View
 * Displays detailed information about a specific crew/team
 * Organized with tabs for better navigation
 */

const CrewDetailView = ({ crewId, onBack }) => {
    const data = window.IdentroData;
    const crews = data?.crews || [];
    const crew = crews.find(c => c.id === crewId || c.name === crewId);
    
    const [activeTab, setActiveTab] = useState('overview');
    const [showBoundarySources, setShowBoundarySources] = useState(null);
    const [expandedAgents, setExpandedAgents] = useState({});
    const [boundaryType, setBoundaryType] = useState('allowed');
    const [showEditModal, setShowEditModal] = useState(false);
    const [editedYaml, setEditedYaml] = useState('');
    const [editError, setEditError] = useState('');
    const [saving, setSaving] = useState(false);
    
    // For mermaid rendering
    const mermaidRef = React.useRef(null);
    const [mermaidSvg, setMermaidSvg] = useState(null);
    
    if (!crew) {
        return (
            <div className="animate-in">
                <button 
                    onClick={onBack}
                    className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 mb-6 transition-colors"
                >
                    <Icons.ArrowLeft />
                    Back to Crews
                </button>
                <div className="text-center py-12 text-slate-500">
                    Crew not found
                </div>
            </div>
        );
    }
    
    const contract = crew.contract || {};
    const boundaries = crew.boundaries || contract.boundaries;
    const agents = crew.agents || [];
    const tasks = crew.tasks || [];
    const tools = crew.tools || [];
    const workflow = crew.workflow;
    const flowChart = crew.flowChart;
    const inputSchema = crew.inputSchema;

    const toggleAgent = (agentName) => {
        setExpandedAgents(prev => ({
            ...prev,
            [agentName]: !prev[agentName]
        }));
    };
    
    // Render mermaid when tab is active
    React.useEffect(() => {
        if (activeTab === 'workflow' && flowChart && window.mermaid) {
            const cleanChart = flowChart.replace(/```mermaid\n?/, '').replace(/```$/, '');
            try {
                window.mermaid.render('mermaid-' + crew.id, cleanChart).then(({ svg }) => {
                    setMermaidSvg(svg);
                });
            } catch (e) {
                console.log('Mermaid render error:', e);
            }
        }
    }, [activeTab, flowChart, crew.id]);
    
    const tabs = [
        { id: 'overview', label: 'Overview', icon: Icons.FileText },
        { id: 'agents', label: `Agents (${agents.length})`, icon: Icons.Users },
        { id: 'tasks', label: `Tasks (${tasks.length})`, icon: Icons.List },
        { id: 'boundaries', label: `Boundaries`, icon: Icons.Shield },
        { id: 'workflow', label: 'Workflow', icon: Icons.Activity },
        ...(inputSchema && inputSchema.parameters?.length > 0 ? [{ id: 'input', label: 'Input Schema', icon: Icons.Terminal }] : []),
    ];

    return (
        <div className="animate-in">
            {/* Back Button */}
            <button 
                onClick={onBack}
                className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 mb-6 transition-colors"
            >
                <Icons.ArrowLeft />
                Back to Crews
            </button>
            
            {/* Header */}
            <div className="flex items-start justify-between mb-6">
                <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                        <div className="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center text-slate-600">
                            <Icons.Users />
                        </div>
                        <div>
                            <h1 className="text-2xl font-semibold text-slate-900">{crew.name}</h1>
                            <p className="text-slate-500 text-sm capitalize">{crew.process || 'sequential'} process</p>
                        </div>
                    </div>
                    {crew.description && (
                        <p className="text-slate-600 mt-2 max-w-2xl text-sm">{crew.description}</p>
                    )}
                </div>
                <button
                    onClick={() => {
                        try {
                            const yamlContent = window.jsyaml?.dump(crew, { indent: 2, lineWidth: 120 }) || JSON.stringify(crew, null, 2);
                            setEditedYaml(yamlContent);
                            setEditError('');
                            setShowEditModal(true);
                        } catch (e) {
                            setEditedYaml(JSON.stringify(crew, null, 2));
                            setShowEditModal(true);
                        }
                    }}
                    className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium flex items-center gap-2"
                >
                    <Icons.Settings />
                    Edit Contract
                </button>
            </div>
            
            {/* Compact Metrics Row */}
            <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                <div className="flex items-center gap-6 divide-x divide-slate-200">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Agents</span>
                        <span className="text-sm font-semibold text-blue-600">{crew.agentCount || agents.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Tasks</span>
                        <span className="text-sm font-semibold text-amber-600">{crew.taskCount || tasks.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Tools</span>
                        <span className="text-sm font-semibold text-emerald-600">{crew.toolCount || tools.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Boundaries</span>
                        <span className="text-sm font-semibold text-slate-900">{(boundaries?.allowed?.length || 0) + (boundaries?.forbidden?.length || 0)}</span>
                    </div>
                </div>
            </div>
            
            {/* Tabs */}
            <div className="border-b border-slate-200 mb-6">
                <div className="flex gap-1">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2.5 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${
                                activeTab === tab.id 
                                    ? 'border-blue-500 text-blue-600' 
                                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                            }`}
                        >
                            <tab.icon />
                            {tab.label}
                        </button>
                    ))}
                </div>
            </div>
            
            {/* Tab Content */}
            <div className="min-h-[400px]">
                {/* Overview Tab */}
                {activeTab === 'overview' && (
                    <div className="space-y-6 animate-in">
                        {/* Contract Section */}
                        {(contract.description || contract.goal || contract.capabilities?.length > 0) && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h2 className="text-lg font-semibold text-slate-900 mb-4">Team Contract</h2>
                                <div className="grid gap-4">
                                    {contract.description && (
                                        <div className="bg-slate-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">What It Does</h3>
                                            <p className="text-slate-900 text-sm">{contract.description}</p>
                                        </div>
                                    )}
                                    {contract.goal && (
                                        <div className="bg-slate-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Goal</h3>
                                            <p className="text-slate-900 text-sm">{contract.goal}</p>
                                        </div>
                                    )}
                                    {contract.capabilities && contract.capabilities.length > 0 && (
                                        <div className="bg-slate-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Capabilities</h3>
                                            <ul className="space-y-1">
                                                {contract.capabilities.map((cap, i) => (
                                                    <li key={i} className="text-sm text-slate-700 flex items-start gap-2">
                                                        <span className="text-blue-500 mt-1">â€¢</span>
                                                        {cap}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* Tools */}
                        {tools.length > 0 && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h2 className="text-lg font-semibold text-slate-900 mb-4">Available Tools</h2>
                                <div className="flex flex-wrap gap-2">
                                    {tools.map((tool, i) => (
                                        <span key={i} className="px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-medium">
                                            {tool}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Source Info */}
                        {crew.filePath && (
                            <div className="bg-slate-50 rounded-xl border border-slate-200 p-4 text-sm text-slate-500">
                                <span className="font-medium">Source: </span>
                                <code className="text-xs bg-slate-200 px-2 py-0.5 rounded">{crew.filePath}</code>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Agents Tab */}
                {activeTab === 'agents' && agents.length > 0 && (
                    <div className="space-y-3 animate-in">
                        {agents.map((agent, i) => (
                            <div key={i} className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-soft">
                                <button
                                    onClick={() => toggleAgent(agent.name)}
                                    className="w-full p-4 flex items-center justify-between hover:bg-slate-50 transition-colors"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600">
                                            <Icons.User />
                                        </div>
                                        <div className="text-left">
                                            <h3 className="font-medium text-slate-900">{agent.name}</h3>
                                            <p className="text-xs text-slate-500">{agent.role || 'Agent'}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {agent.tools && agent.tools.length > 0 && (
                                            <span className="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded">
                                                {agent.tools.length} tools
                                            </span>
                                        )}
                                        <span className={`transform transition-transform ${expandedAgents[agent.name] ? 'rotate-180' : ''}`}>
                                            <Icons.ChevronDown />
                                        </span>
                                    </div>
                                </button>
                                {expandedAgents[agent.name] && (
                                    <div className="p-4 border-t border-slate-200 space-y-4 bg-slate-50">
                                        {agent.goal && (
                                            <div>
                                                <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Goal</h4>
                                                <p className="text-sm text-slate-700">{agent.goal}</p>
                                            </div>
                                        )}
                                        {agent.backstory && (
                                            <div>
                                                <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Backstory</h4>
                                                <p className="text-sm text-slate-600 whitespace-pre-wrap">{agent.backstory}</p>
                                            </div>
                                        )}
                                        {agent.tools && agent.tools.length > 0 && (
                                            <div>
                                                <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Tools</h4>
                                                <div className="flex flex-wrap gap-2">
                                                    {agent.tools.map((tool, j) => (
                                                        <span key={j} className="px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs font-medium">
                                                            {tool}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                )}
                
                {/* Tasks Tab */}
                {activeTab === 'tasks' && tasks.length > 0 && (
                    <div className="space-y-3 animate-in">
                        {tasks.map((task, i) => (
                            <div key={i} className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft">
                                <div className="flex items-start justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs font-mono bg-slate-200 text-slate-700 px-2 py-0.5 rounded">
                                            {i + 1}
                                        </span>
                                        <h3 className="font-medium text-slate-900">{task.name}</h3>
                                    </div>
                                    <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded flex items-center gap-1">
                                        <Icons.User />
                                        {task.agent}
                                    </span>
                                </div>
                                {task.description && (
                                    <p className="text-sm text-slate-600 mb-3">{task.description}</p>
                                )}
                                {task.expectedOutput && (
                                    <div className="bg-emerald-50 rounded-lg p-3 mb-2">
                                        <span className="text-xs font-semibold text-emerald-700">Expected Output:</span>
                                        <p className="text-xs text-emerald-900 mt-1">{task.expectedOutput}</p>
                                    </div>
                                )}
                                {task.dependencies && task.dependencies.length > 0 && (
                                    <div className="bg-purple-50 rounded px-2 py-1 text-xs inline-block">
                                        <span className="font-semibold text-purple-700">Depends on: </span>
                                        <span className="text-purple-900">{task.dependencies.join(', ')}</span>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                )}
                
                {/* Boundaries Tab */}
                {activeTab === 'boundaries' && (
                    <div className="animate-in">
                        {boundaries && (boundaries.allowed?.length > 0 || boundaries.forbidden?.length > 0) ? (
                            <div className="bg-white rounded-xl border border-slate-200 shadow-soft">
                                {/* Inline tabs for allowed/forbidden */}
                                <div className="flex border-b border-slate-200">
                                    <button
                                        onClick={() => setBoundaryType('allowed')}
                                        className={`flex-1 px-4 py-3 text-sm font-medium flex items-center justify-center gap-2 ${
                                            boundaryType === 'allowed'
                                                ? 'bg-emerald-50 text-emerald-700 border-b-2 border-emerald-500'
                                                : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                                        }`}
                                    >
                                        <span className="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs">âœ“</span>
                                        Allowed
                                        <span className={`px-2 py-0.5 rounded-full text-xs ${
                                            boundaryType === 'allowed' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'
                                        }`}>
                                            {boundaries.allowed?.length || 0}
                                        </span>
                                    </button>
                                    <button
                                        onClick={() => setBoundaryType('forbidden')}
                                        className={`flex-1 px-4 py-3 text-sm font-medium flex items-center justify-center gap-2 ${
                                            boundaryType === 'forbidden'
                                                ? 'bg-red-50 text-red-700 border-b-2 border-red-500'
                                                : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                                        }`}
                                    >
                                        <span className="w-5 h-5 rounded-full bg-red-500 flex items-center justify-center text-white text-xs">âœ•</span>
                                        Forbidden
                                        <span className={`px-2 py-0.5 rounded-full text-xs ${
                                            boundaryType === 'forbidden' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'
                                        }`}>
                                            {boundaries.forbidden?.length || 0}
                                        </span>
                                    </button>
                                </div>
                                
                                {/* Content */}
                                <div className="p-4">
                                    {boundaryType === 'allowed' && boundaries.allowed && boundaries.allowed.length > 0 && (
                                        <div className="space-y-2">
                                            {boundaries.allowed.map((item, i) => (
                                                <div key={i} className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                                    <div className="flex items-start justify-between gap-3">
                                                        <p className="text-sm text-slate-800 flex-1">{item.action}</p>
                                                        <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-xs font-medium flex-shrink-0">
                                                            {Math.round((item.confidence || 0) * 100)}%
                                                        </span>
                                                    </div>
                                                    {item.agent && (
                                                        <span className="mt-2 inline-block px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-xs">
                                                            {item.agent}
                                                        </span>
                                                    )}
                                                    {item.evidence && (
                                                        <div className="mt-2 pt-2 border-t border-emerald-200">
                                                            <p className="text-xs text-emerald-700 line-clamp-2">{item.evidence}</p>
                                                            <button 
                                                                onClick={() => setShowBoundarySources(item)}
                                                                className="text-emerald-600 hover:text-emerald-700 text-xs underline mt-1"
                                                            >
                                                                View full evidence
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {boundaryType === 'allowed' && (!boundaries.allowed || boundaries.allowed.length === 0) && (
                                        <div className="text-center py-8 text-slate-500 text-sm">
                                            No allowed actions defined
                                        </div>
                                    )}
                                    
                                    {boundaryType === 'forbidden' && boundaries.forbidden && boundaries.forbidden.length > 0 && (
                                        <div className="space-y-2">
                                            {boundaries.forbidden.map((item, i) => (
                                                <div key={i} className="bg-red-50 border border-red-200 rounded-lg p-3">
                                                    <div className="flex items-start justify-between gap-3">
                                                        <p className="text-sm text-slate-800 flex-1">{item.action}</p>
                                                        <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-medium flex-shrink-0">
                                                            {Math.round((item.confidence || 0) * 100)}%
                                                        </span>
                                                    </div>
                                                    {item.agent && (
                                                        <span className="mt-2 inline-block px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-xs">
                                                            {item.agent}
                                                        </span>
                                                    )}
                                                    {item.evidence && (
                                                        <div className="mt-2 pt-2 border-t border-red-200">
                                                            <p className="text-xs text-red-700 line-clamp-2">{item.evidence}</p>
                                                            <button 
                                                                onClick={() => setShowBoundarySources(item)}
                                                                className="text-red-600 hover:text-red-700 text-xs underline mt-1"
                                                            >
                                                                View full evidence
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {boundaryType === 'forbidden' && (!boundaries.forbidden || boundaries.forbidden.length === 0) && (
                                        <div className="text-center py-8 text-slate-500 text-sm">
                                            No forbidden actions defined
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="text-center py-12 text-slate-500">
                                No boundaries defined for this crew
                            </div>
                        )}
                    </div>
                )}
                
                {/* Workflow Tab */}
                {activeTab === 'workflow' && (
                    <div className="space-y-6 animate-in">
                        {/* Workflow Summary */}
                        {workflow && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h2 className="text-lg font-semibold text-slate-900 mb-4">Execution Flow</h2>
                                {workflow.summary && (
                                    <div className="bg-purple-50 rounded-lg p-4 mb-4">
                                        <p className="text-slate-900 font-mono text-sm">{workflow.summary}</p>
                                    </div>
                                )}
                                {workflow.dependencyChain && workflow.dependencyChain.length > 0 && (
                                    <div className="flex flex-wrap items-center gap-2">
                                        {workflow.dependencyChain.map((step, i) => (
                                            <React.Fragment key={i}>
                                                <div className="bg-slate-100 rounded-lg px-3 py-2">
                                                    <span className="text-xs text-slate-500">Level {step.level}</span>
                                                    <p className="font-medium text-slate-900 text-sm">{step.task}</p>
                                                </div>
                                                {i < workflow.dependencyChain.length - 1 && (
                                                    <span className="text-slate-400">â†’</span>
                                                )}
                                            </React.Fragment>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* Mermaid Diagram */}
                        {flowChart && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h2 className="text-lg font-semibold text-slate-900 mb-4">Flow Diagram</h2>
                                {mermaidSvg ? (
                                    <div 
                                        className="overflow-x-auto" 
                                        dangerouslySetInnerHTML={{ __html: mermaidSvg }}
                                    />
                                ) : (
                                    <div className="bg-slate-50 rounded-lg p-4 overflow-x-auto">
                                        <pre className="text-xs text-slate-700 font-mono whitespace-pre-wrap">
                                            {flowChart.replace(/```mermaid\n?/, '').replace(/```$/, '')}
                                        </pre>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {!workflow && !flowChart && (
                            <div className="text-center py-12 text-slate-500">
                                No workflow information available
                            </div>
                        )}
                    </div>
                )}
                
                {/* Input Schema Tab */}
                {activeTab === 'input' && inputSchema && (
                    <div className="space-y-6 animate-in">
                        {/* Summary */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-lg font-semibold text-slate-900">Input Schema</h2>
                                <div className="flex items-center gap-2">
                                    {inputSchema.confidence && (
                                        <span className="text-xs bg-cyan-100 text-cyan-700 px-2 py-1 rounded-full font-medium">
                                            {Math.round(inputSchema.confidence * 100)}% confidence
                                        </span>
                                    )}
                                    {inputSchema.inputMethod && (
                                        <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-full font-medium">
                                            {inputSchema.inputMethod}
                                        </span>
                                    )}
                                </div>
                            </div>
                            
                            <p className="text-sm text-slate-600 mb-4">
                                {inputSchema.parameters?.length || 0} parameter(s) detected for this crew
                            </p>
                        </div>
                        
                        {/* Parameters */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h3 className="text-sm font-semibold text-slate-700 mb-4">Parameters</h3>
                            <div className="space-y-4">
                                {inputSchema.parameters?.map((param, i) => (
                                    <div key={i} className="border border-slate-200 rounded-lg overflow-hidden">
                                        {/* Parameter Header */}
                                        <div className="bg-slate-50 p-4 border-b border-slate-200">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <span className="font-mono text-sm font-bold text-slate-900">{param.name}</span>
                                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-medium">
                                                    {param.type || param.raw_type || 'string'}
                                                </span>
                                                {param.required && (
                                                    <span className="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded font-medium">
                                                        required
                                                    </span>
                                                )}
                                            </div>
                                            {param.description && (
                                                <p className="text-sm text-slate-600 mt-2">{param.description}</p>
                                            )}
                                        </div>
                                        
                                        {/* Parameter Details */}
                                        <div className="p-4 space-y-3">
                                            {/* Constraints if any */}
                                            {param.constraints && (
                                                <div className="grid grid-cols-2 gap-3 text-sm">
                                                    {param.constraints.minLength && (
                                                        <div className="bg-amber-50 rounded p-2">
                                                            <span className="text-xs text-amber-600 font-medium">Min Length:</span>
                                                            <span className="ml-1 text-amber-900">{param.constraints.minLength}</span>
                                                        </div>
                                                    )}
                                                    {param.constraints.maxLength && (
                                                        <div className="bg-amber-50 rounded p-2">
                                                            <span className="text-xs text-amber-600 font-medium">Max Length:</span>
                                                            <span className="ml-1 text-amber-900">{param.constraints.maxLength}</span>
                                                        </div>
                                                    )}
                                                    {param.constraints.pattern && (
                                                        <div className="bg-amber-50 rounded p-2 col-span-2">
                                                            <span className="text-xs text-amber-600 font-medium">Pattern:</span>
                                                            <code className="ml-1 text-xs text-amber-900">{param.constraints.pattern}</code>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {/* Examples */}
                                            {param.examples && param.examples.length > 0 && (
                                                <div>
                                                    <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Example</h4>
                                                    <code className="block text-xs bg-slate-50 border border-slate-200 rounded p-3 text-slate-700 break-words">
                                                        {typeof param.examples[0] === 'string' ? param.examples[0] : JSON.stringify(param.examples[0], null, 2)}
                                                    </code>
                                                </div>
                                            )}
                                            
                                            {/* Usage Info */}
                                            {(param.usedInAgents?.length > 0 || param.usedInTasks?.length > 0 || param.sources?.length > 0) && (
                                                <div className="flex flex-wrap gap-2 pt-2 border-t border-slate-100">
                                                    {param.usedInAgents && param.usedInAgents.length > 0 && (
                                                        <div className="text-xs">
                                                            <span className="text-slate-500">Used in agents:</span>
                                                            {param.usedInAgents.map((a, j) => (
                                                                <span key={j} className="ml-1 px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded">
                                                                    {a}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {param.usedInTasks && param.usedInTasks.length > 0 && (
                                                        <div className="text-xs">
                                                            <span className="text-slate-500">Used in tasks:</span>
                                                            {param.usedInTasks.map((t, j) => (
                                                                <span key={j} className="ml-1 px-1.5 py-0.5 bg-purple-50 text-purple-600 rounded">
                                                                    {t}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {param.sources && param.sources.length > 0 && (
                                                        <div className="text-xs">
                                                            <span className="text-slate-500">Sources:</span>
                                                            {param.sources.map((s, j) => (
                                                                <span key={j} className="ml-1 px-1.5 py-0.5 bg-slate-100 text-slate-600 rounded">
                                                                    {s}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Example Inputs */}
                        {inputSchema.exampleInputs && inputSchema.exampleInputs.length > 0 && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h3 className="text-sm font-semibold text-slate-700 mb-4">Example Input</h3>
                                <pre className="text-xs bg-slate-50 border border-slate-200 rounded-lg p-4 text-slate-700 overflow-x-auto">
                                    {JSON.stringify(inputSchema.exampleInputs[0], null, 2)}
                                </pre>
                            </div>
                        )}
                    </div>
                )}
            </div>
            
            {/* Boundary Sources Modal - Portal to body */}
            {showBoundarySources && ReactDOM.createPortal(
                <div 
                    className="fixed inset-0 bg-black/50 flex items-center justify-center p-4"
                    style={{ zIndex: 9999 }}
                    onClick={() => setShowBoundarySources(null)}
                >
                    <div 
                        className="bg-white rounded-xl max-w-2xl w-full p-6 shadow-xl"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex items-start justify-between mb-4 pb-4 border-b border-slate-200">
                            <div>
                                <h3 className="text-lg font-semibold text-slate-900">Boundary Evidence</h3>
                                <p className="text-sm text-slate-500 mt-1">{showBoundarySources.action}</p>
                            </div>
                            <button 
                                onClick={() => setShowBoundarySources(null)}
                                className="text-slate-400 hover:text-slate-600"
                            >
                                <Icons.X />
                            </button>
                        </div>
                        
                        <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                            <div className="flex items-center justify-between">
                                <span className="text-sm font-semibold text-slate-700">Confidence</span>
                                <span className="text-xl font-bold text-blue-600">
                                    {Math.round((showBoundarySources.confidence || 0) * 100)}%
                                </span>
                            </div>
                        </div>
                        
                        {showBoundarySources.evidence && (
                            <div className="bg-slate-50 rounded-lg p-4">
                                <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Evidence</h4>
                                <pre className="text-sm text-slate-800 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-slate-200 max-h-60 overflow-y-auto">
                                    {showBoundarySources.evidence}
                                </pre>
                            </div>
                        )}
                        
                        <div className="mt-6 flex justify-end">
                            <button 
                                onClick={() => setShowBoundarySources(null)}
                                className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
            
            {/* Edit Modal - Portal to body */}
            {showEditModal && ReactDOM.createPortal(
                <div 
                    className="fixed inset-0 bg-black/50 flex items-center justify-center p-4"
                    style={{ zIndex: 9999 }}
                    onClick={() => setShowEditModal(false)}
                >
                    <div 
                        className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-xl flex flex-col"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex items-start justify-between p-6 border-b border-slate-200">
                            <div>
                                <h3 className="text-xl font-semibold text-slate-900">Edit {crew.name}</h3>
                                <p className="text-sm text-slate-500 mt-1">Edit the team contract - changes will be saved to the team YAML file</p>
                            </div>
                            <button 
                                onClick={() => setShowEditModal(false)}
                                className="text-slate-400 hover:text-slate-600"
                            >
                                <Icons.X />
                            </button>
                        </div>
                        
                        <div className="p-6 flex-1 overflow-y-auto">
                            <label className="block text-sm font-medium mb-2 text-slate-700">YAML Editor</label>
                            <textarea
                                value={editedYaml}
                                onChange={e => setEditedYaml(e.target.value)}
                                className="w-full h-96 p-4 border border-slate-300 rounded-lg font-mono text-sm bg-slate-50 text-slate-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                                placeholder="Loading..."
                            />
                            <p className="text-xs text-slate-500 mt-2">
                                Edit the YAML directly. Changes will be saved to <code className="bg-slate-100 px-1 rounded">{crew.filePath}</code>
                            </p>
                            
                            {editError && (
                                <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                                    {editError}
                                </div>
                            )}
                        </div>
                        
                        <div className="p-6 border-t border-slate-200 flex justify-end gap-3">
                            <button 
                                onClick={() => setShowEditModal(false)}
                                className="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition text-sm font-medium"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={async () => {
                                    setSaving(true);
                                    setEditError('');
                                    try {
                                        const parsed = window.jsyaml?.load(editedYaml) || JSON.parse(editedYaml);
                                        
                                        if (window.API_URL) {
                                            const response = await fetch(`${window.API_URL}/api/teams/save`, {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                    teamName: crew.name,
                                                    yamlContent: editedYaml
                                                })
                                            });
                                            
                                            if (!response.ok) throw new Error('Failed to save');
                                            alert(`âœ… ${crew.name} contract saved successfully!`);
                                            setShowEditModal(false);
                                        } else {
                                            const blob = new Blob([editedYaml], { type: 'text/yaml' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = `${crew.name}.yml`;
                                            document.body.appendChild(a);
                                            a.click();
                                            document.body.removeChild(a);
                                            URL.revokeObjectURL(url);
                                            alert(`Team contract downloaded!\n\nPlease move the file to your .identro/teams/ folder.`);
                                            setShowEditModal(false);
                                        }
                                    } catch (error) {
                                        setEditError(`Error: ${error.message}`);
                                    }
                                    setSaving(false);
                                }}
                                disabled={saving}
                                className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium disabled:opacity-50"
                            >
                                {saving ? 'Saving...' : 'Save Changes'}
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </div>
    );
};


// === components/views/agents.jsx ===
/**
 * Agents View
 * Displays list of individual agents with their configurations
 */

const AgentsView = ({ onSelectAgent }) => {
    const data = window.IdentroData;
    const agents = data?.agents || [];
    const crews = data?.crews || [];
    
    // Calculate unique tools across all agents
    const uniqueTools = new Set();
    agents.forEach(a => (a.tools || []).forEach(t => uniqueTools.add(t)));
    
    // Calculate unique tasks assigned to agents across all crews
    const uniqueTasks = new Set();
    crews.forEach(crew => {
        (crew.tasks || []).forEach(task => {
            if (task.name && agents.some(a => a.name === task.agent)) {
                uniqueTasks.add(task.name);
            }
        });
    });
    
    // Count unique crews that agents belong to
    const getAgentCrews = (agentName) => {
        return crews.filter(crew => {
            const crewAgents = crew.agents || [];
            return crewAgents.some(a => a.name === agentName);
        });
    };
    
    // Get tasks assigned to a specific agent
    const getAgentTasks = (agentName) => {
        const tasks = [];
        crews.forEach(crew => {
            (crew.tasks || []).forEach(task => {
                if (task.agent === agentName) {
                    tasks.push({ ...task, crewName: crew.name });
                }
            });
        });
        return tasks;
    };

    return (
        <div className="animate-in">
            <Header 
                title="Agents" 
                subtitle="Individual AI agents and their configurations"
            />
            
            {/* Compact Metrics Row */}
            <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                <div className="flex items-center gap-6 divide-x divide-slate-200">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Agents</span>
                        <span className="text-sm font-semibold text-slate-900">{agents.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Crews</span>
                        <span className="text-sm font-semibold text-slate-900">{crews.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Tools</span>
                        <span className="text-sm font-semibold text-emerald-600">{uniqueTools.size}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Tasks</span>
                        <span className="text-sm font-semibold text-amber-600">{uniqueTasks.size}</span>
                    </div>
                </div>
            </div>

            {/* Agents List */}
            <div className="space-y-3">
                {agents.map((agent, i) => {
                    const agentCrews = getAgentCrews(agent.name);
                    const agentTasks = getAgentTasks(agent.name);
                    const boundaries = agent.boundaries || agent.contract?.boundaries;
                    const boundaryCount = (boundaries?.allowed?.length || 0) + (boundaries?.forbidden?.length || 0);
                    
                    return (
                        <div 
                            key={agent.id || i}
                            onClick={() => onSelectAgent && onSelectAgent(agent.name)}
                            className="bg-white rounded-lg border border-slate-200 shadow-soft hover:shadow-card hover:border-slate-300 transition-all cursor-pointer animate-in group overflow-hidden"
                            style={{ animationDelay: `${i * 0.05}s` }}
                        >
                            {/* Header Section */}
                            <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                                <div className="flex items-start justify-between">
                                    <div className="flex items-start gap-3 flex-1 min-w-0">
                                        <div className="mt-0.5 w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-blue-100 text-blue-600">
                                            <Icons.User />
                                        </div>
                                        <div className="min-w-0 flex-1">
                                            {/* Badges row */}
                                            <div className="flex items-center gap-2 mb-1.5 flex-wrap">
                                                {/* Tools count */}
                                                {agent.tools && agent.tools.length > 0 && (
                                                    <span className="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded">
                                                        {agent.tools.length} tool{agent.tools.length !== 1 ? 's' : ''}
                                                    </span>
                                                )}
                                                
                                                {/* Tasks count */}
                                                {agentTasks.length > 0 && (
                                                    <span className="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded">
                                                        {agentTasks.length} task{agentTasks.length !== 1 ? 's' : ''}
                                                    </span>
                                                )}
                                                
                                                {/* Crews */}
                                                {agentCrews.length > 0 && (
                                                    <span className="text-xs bg-violet-50 text-violet-600 px-2 py-0.5 rounded">
                                                        {agentCrews.length} crew{agentCrews.length !== 1 ? 's' : ''}
                                                    </span>
                                                )}
                                                
                                                {/* Boundaries indicator */}
                                                {boundaryCount > 0 && (
                                                    <span className="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded">
                                                        {boundaryCount} boundaries
                                                    </span>
                                                )}
                                            </div>
                                            
                                            {/* Agent name - blue link style */}
                                            <p className="text-sm font-semibold text-blue-600 group-hover:text-blue-700 transition-colors">
                                                {agent.name}
                                            </p>
                                            
                                            {/* Role line */}
                                            <div className="flex items-center gap-2 mt-1 text-xs text-slate-500">
                                                <span>{agent.role || 'AI Agent'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Right side - index number */}
                                    <div className="flex-shrink-0 ml-4">
                                        <span className="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded font-medium">#{i + 1}</span>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Body Section */}
                            <div className="p-4">
                                {/* Agent goal */}
                                {agent.goal && (
                                    <div>
                                        <div className="text-xs font-semibold text-slate-500 mb-1">GOAL</div>
                                        <div className="bg-slate-50 p-2 rounded text-xs text-slate-700 line-clamp-2 border border-slate-100">
                                            {agent.goal}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Backstory preview if available and no goal */}
                                {!agent.goal && agent.backstory && (
                                    <div>
                                        <div className="text-xs font-semibold text-slate-500 mb-1">BACKSTORY</div>
                                        <div className="bg-blue-50 p-2 rounded text-xs text-blue-900 line-clamp-2">
                                            {agent.backstory}
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* Footer */}
                            <div className="px-4 py-2 bg-slate-50 border-t border-slate-100 flex items-center justify-between">
                                <div className="flex items-center gap-3 text-xs text-slate-500">
                                    {agentCrews.length > 0 && (
                                        <span>In: <strong className="text-slate-600">{agentCrews.map(c => c.name).join(', ')}</strong></span>
                                    )}
                                </div>
                                <span className="text-blue-600 text-xs font-medium flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                    View Details <Icons.ChevronRight />
                                </span>
                            </div>
                        </div>
                    );
                })}
                
                {agents.length === 0 && (
                    <div className="text-center py-12 bg-white rounded-lg border border-slate-200">
                        <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                            <Icons.User />
                        </div>
                        <h3 className="font-medium text-slate-900 mb-1">No agents found</h3>
                        <p className="text-slate-500 text-sm">
                            Run <code className="bg-slate-100 px-1 rounded">identro-eval analyze</code> to discover agents.
                        </p>
                    </div>
                )}
            </div>
        </div>
    );
};


// === components/views/agent-detail.jsx ===
/**
 * Agent Detail View
 * Displays detailed information about a specific agent
 * Organized with tabs for better navigation
 */

const AgentDetailView = ({ agentId, onBack }) => {
    const data = window.IdentroData;
    const agents = data?.agents || [];
    const crews = data?.crews || [];
    const agent = agents.find(a => a.id === agentId || a.name === agentId);
    
    const [activeTab, setActiveTab] = useState('overview');
    const [showBoundarySources, setShowBoundarySources] = useState(null);
    const [boundaryType, setBoundaryType] = useState('allowed');
    const [showEditModal, setShowEditModal] = useState(false);
    const [editedYaml, setEditedYaml] = useState('');
    const [editError, setEditError] = useState('');
    const [saving, setSaving] = useState(false);
    
    const openEdit = () => {
        if (!agent) return;
        try {
            const yamlContent = window.jsyaml?.dump(agent, { indent: 2, lineWidth: 120 }) || JSON.stringify(agent, null, 2);
            setEditedYaml(yamlContent);
            setEditError('');
            setShowEditModal(true);
        } catch (e) {
            setEditedYaml(JSON.stringify(agent, null, 2));
            setShowEditModal(true);
        }
    };
    
    const saveAgent = async () => {
        setSaving(true);
        setEditError('');
        try {
            const parsed = window.jsyaml?.load(editedYaml) || JSON.parse(editedYaml);
            
            if (window.API_URL) {
                const response = await fetch(`${window.API_URL}/api/agents/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agentName: agent.name,
                        yamlContent: editedYaml
                    })
                });
                
                if (!response.ok) throw new Error('Failed to save');
                alert(`âœ… ${agent.name} contract saved successfully!`);
                setShowEditModal(false);
            } else {
                // Fallback: download the file
                const blob = new Blob([editedYaml], { type: 'text/yaml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${agent.name}.yml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert(`Agent contract downloaded!\n\nPlease move the file to your .identro/agents/ folder.`);
                setShowEditModal(false);
            }
        } catch (error) {
            setEditError(`Error: ${error.message}`);
        }
        setSaving(false);
    };
    
    if (!agent) {
        return (
            <div className="animate-in">
                <button 
                    onClick={onBack}
                    className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 mb-6 transition-colors"
                >
                    <Icons.ArrowLeft />
                    Back to Agents
                </button>
                <div className="text-center py-12 text-slate-500">
                    Agent not found
                </div>
            </div>
        );
    }
    
    const contract = agent.contract || {};
    const boundaries = agent.boundaries || contract.boundaries;
    const tools = agent.tools || [];
    const inputSchema = agent.inputSchema || contract.inputSchema;
    
    // Get tasks assigned to this agent from all crews (deduplicated by task name)
    const taskMap = new Map();
    crews.forEach(crew => {
        (crew.tasks || []).forEach(task => {
            if (task.agent === agent.name) {
                const existingTask = taskMap.get(task.name);
                if (existingTask) {
                    // Task exists, add this crew to the list
                    existingTask.crewNames.push(crew.name);
                } else {
                    // New task, create entry with crews array
                    taskMap.set(task.name, { ...task, crewNames: [crew.name] });
                }
            }
        });
    });
    const agentTasks = Array.from(taskMap.values());
    
    const tabs = [
        { id: 'overview', label: 'Overview', icon: Icons.FileText },
        { id: 'tasks', label: `Tasks (${agentTasks.length})`, icon: Icons.List },
        { id: 'boundaries', label: 'Boundaries', icon: Icons.Shield },
        ...(inputSchema && inputSchema.parameters?.length > 0 ? [{ id: 'input', label: 'Input Schema', icon: Icons.Terminal }] : []),
    ];

    return (
        <div className="animate-in">
            {/* Back Button */}
            <button 
                onClick={onBack}
                className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 mb-6 transition-colors"
            >
                <Icons.ArrowLeft />
                Back to Agents
            </button>
            
            {/* Header */}
            <div className="flex items-start justify-between mb-6">
                <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                        <div className="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center text-blue-600">
                            <Icons.User />
                        </div>
                        <div>
                            <h1 className="text-2xl font-semibold text-slate-900">{agent.name}</h1>
                            <p className="text-slate-500 text-sm">{agent.role || 'AI Agent'}</p>
                        </div>
                    </div>
                </div>
                <button
                    onClick={openEdit}
                    className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium flex items-center gap-2"
                >
                    <Icons.Settings />
                    Edit Contract
                </button>
            </div>
            
            {/* Compact Metrics Row */}
            <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                <div className="flex items-center gap-6 divide-x divide-slate-200">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Tools</span>
                        <span className="text-sm font-semibold text-emerald-600">{tools.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Tasks</span>
                        <span className="text-sm font-semibold text-amber-600">{agentTasks.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Allowed</span>
                        <span className="text-sm font-semibold text-emerald-600">{boundaries?.allowed?.length || 0}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Forbidden</span>
                        <span className="text-sm font-semibold text-red-600">{boundaries?.forbidden?.length || 0}</span>
                    </div>
                </div>
            </div>
            
            {/* Tabs */}
            <div className="border-b border-slate-200 mb-6">
                <div className="flex gap-1">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2.5 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${
                                activeTab === tab.id 
                                    ? 'border-blue-500 text-blue-600' 
                                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                            }`}
                        >
                            <tab.icon />
                            {tab.label}
                        </button>
                    ))}
                </div>
            </div>
            
            {/* Tab Content */}
            <div className="min-h-[400px]">
                {/* Overview Tab */}
                {activeTab === 'overview' && (
                    <div className="space-y-6 animate-in">
                        {/* Goal & Backstory */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h2 className="text-lg font-semibold text-slate-900 mb-4">Agent Profile</h2>
                            <div className="grid gap-4">
                                {agent.goal && (
                                    <div className="bg-slate-50 rounded-lg p-4">
                                        <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Goal</h3>
                                        <p className="text-slate-900 text-sm">{agent.goal}</p>
                                    </div>
                                )}
                                {agent.backstory && (
                                    <div className="bg-slate-50 rounded-lg p-4">
                                        <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Backstory</h3>
                                        <p className="text-slate-600 text-sm whitespace-pre-wrap">{agent.backstory}</p>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* Tools */}
                        {tools.length > 0 && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h2 className="text-lg font-semibold text-slate-900 mb-4">Available Tools</h2>
                                <div className="flex flex-wrap gap-2">
                                    {tools.map((tool, i) => (
                                        <span key={i} className="px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-medium">
                                            {tool}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Source Info */}
                        {agent.filePath && (
                            <div className="bg-slate-50 rounded-xl border border-slate-200 p-4 text-sm text-slate-500">
                                <span className="font-medium">Source: </span>
                                <code className="text-xs bg-slate-200 px-2 py-0.5 rounded">{agent.filePath}</code>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Tasks Tab */}
                {activeTab === 'tasks' && (
                    <div className="animate-in">
                        {agentTasks.length > 0 ? (
                            <div className="space-y-3">
                                {agentTasks.map((task, i) => (
                                    <div key={i} className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft">
                                        <div className="flex items-start justify-between mb-2">
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs font-mono bg-slate-200 text-slate-700 px-2 py-0.5 rounded">
                                                    {i + 1}
                                                </span>
                                                <h3 className="font-medium text-slate-900">{task.name}</h3>
                                            </div>
                                            <div className="flex flex-wrap gap-1 justify-end">
                                                {task.crewNames.map((crewName, j) => (
                                                    <span key={j} className="text-xs bg-violet-100 text-violet-700 px-2 py-0.5 rounded flex items-center gap-1">
                                                        <Icons.Users />
                                                        {crewName}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                        {task.description && (
                                            <p className="text-sm text-slate-600 mb-3">{task.description}</p>
                                        )}
                                        {task.expectedOutput && (
                                            <div className="bg-emerald-50 rounded-lg p-3 mb-2">
                                                <span className="text-xs font-semibold text-emerald-700">Expected Output:</span>
                                                <p className="text-xs text-emerald-900 mt-1">{task.expectedOutput}</p>
                                            </div>
                                        )}
                                        {task.tools && task.tools.length > 0 && (
                                            <div className="flex flex-wrap gap-1.5 mt-2">
                                                {task.tools.map((tool, j) => (
                                                    <span key={j} className="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded">
                                                        {tool}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                        {task.dependencies && task.dependencies.length > 0 && (
                                            <div className="bg-purple-50 rounded px-2 py-1 text-xs inline-block mt-2">
                                                <span className="font-semibold text-purple-700">Depends on: </span>
                                                <span className="text-purple-900">{task.dependencies.join(', ')}</span>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-12 text-slate-500">
                                <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                                    <Icons.List />
                                </div>
                                <h3 className="font-medium text-slate-900 mb-1">No tasks assigned</h3>
                                <p className="text-sm">This agent doesn't have any tasks assigned across crews.</p>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Boundaries Tab */}
                {activeTab === 'boundaries' && (
                    <div className="animate-in">
                        {boundaries && (boundaries.allowed?.length > 0 || boundaries.forbidden?.length > 0) ? (
                            <div className="bg-white rounded-xl border border-slate-200 shadow-soft">
                                {/* Inline tabs for allowed/forbidden */}
                                <div className="flex border-b border-slate-200">
                                    <button
                                        onClick={() => setBoundaryType('allowed')}
                                        className={`flex-1 px-4 py-3 text-sm font-medium flex items-center justify-center gap-2 ${
                                            boundaryType === 'allowed'
                                                ? 'bg-emerald-50 text-emerald-700 border-b-2 border-emerald-500'
                                                : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                                        }`}
                                    >
                                        <span className="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs">âœ“</span>
                                        Allowed
                                        <span className={`px-2 py-0.5 rounded-full text-xs ${
                                            boundaryType === 'allowed' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'
                                        }`}>
                                            {boundaries.allowed?.length || 0}
                                        </span>
                                    </button>
                                    <button
                                        onClick={() => setBoundaryType('forbidden')}
                                        className={`flex-1 px-4 py-3 text-sm font-medium flex items-center justify-center gap-2 ${
                                            boundaryType === 'forbidden'
                                                ? 'bg-red-50 text-red-700 border-b-2 border-red-500'
                                                : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                                        }`}
                                    >
                                        <span className="w-5 h-5 rounded-full bg-red-500 flex items-center justify-center text-white text-xs">âœ•</span>
                                        Forbidden
                                        <span className={`px-2 py-0.5 rounded-full text-xs ${
                                            boundaryType === 'forbidden' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'
                                        }`}>
                                            {boundaries.forbidden?.length || 0}
                                        </span>
                                    </button>
                                </div>
                                
                                {/* Content */}
                                <div className="p-4">
                                    {boundaryType === 'allowed' && boundaries.allowed && boundaries.allowed.length > 0 && (
                                        <div className="space-y-2">
                                            {boundaries.allowed.map((item, i) => (
                                                <div key={i} className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                                    <div className="flex items-start justify-between gap-3">
                                                        <p className="text-sm text-slate-800 flex-1">{item.action}</p>
                                                        <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-xs font-medium flex-shrink-0">
                                                            {Math.round((item.confidence || 0) * 100)}%
                                                        </span>
                                                    </div>
                                                    {item.evidence && (
                                                        <div className="mt-2 pt-2 border-t border-emerald-200">
                                                            <p className="text-xs text-emerald-700 line-clamp-2">{item.evidence}</p>
                                                            <button 
                                                                onClick={() => setShowBoundarySources(item)}
                                                                className="text-emerald-600 hover:text-emerald-700 text-xs underline mt-1"
                                                            >
                                                                View full evidence
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {boundaryType === 'allowed' && (!boundaries.allowed || boundaries.allowed.length === 0) && (
                                        <div className="text-center py-8 text-slate-500 text-sm">
                                            No allowed actions defined
                                        </div>
                                    )}
                                    
                                    {boundaryType === 'forbidden' && boundaries.forbidden && boundaries.forbidden.length > 0 && (
                                        <div className="space-y-2">
                                            {boundaries.forbidden.map((item, i) => (
                                                <div key={i} className="bg-red-50 border border-red-200 rounded-lg p-3">
                                                    <div className="flex items-start justify-between gap-3">
                                                        <p className="text-sm text-slate-800 flex-1">{item.action}</p>
                                                        <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-medium flex-shrink-0">
                                                            {Math.round((item.confidence || 0) * 100)}%
                                                        </span>
                                                    </div>
                                                    {item.evidence && (
                                                        <div className="mt-2 pt-2 border-t border-red-200">
                                                            <p className="text-xs text-red-700 line-clamp-2">{item.evidence}</p>
                                                            <button 
                                                                onClick={() => setShowBoundarySources(item)}
                                                                className="text-red-600 hover:text-red-700 text-xs underline mt-1"
                                                            >
                                                                View full evidence
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {boundaryType === 'forbidden' && (!boundaries.forbidden || boundaries.forbidden.length === 0) && (
                                        <div className="text-center py-8 text-slate-500 text-sm">
                                            No forbidden actions defined
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="text-center py-12 text-slate-500">
                                No boundaries defined for this agent
                            </div>
                        )}
                    </div>
                )}
                
                {/* Input Schema Tab */}
                {activeTab === 'input' && inputSchema && (
                    <div className="space-y-6 animate-in">
                        {/* Summary */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-lg font-semibold text-slate-900">Input Schema</h2>
                                <div className="flex items-center gap-2">
                                    {inputSchema.confidence && (
                                        <span className="text-xs bg-cyan-100 text-cyan-700 px-2 py-1 rounded-full font-medium">
                                            {Math.round(inputSchema.confidence * 100)}% confidence
                                        </span>
                                    )}
                                    {inputSchema.inputMethod && (
                                        <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-full font-medium">
                                            {inputSchema.inputMethod}
                                        </span>
                                    )}
                                </div>
                            </div>
                            
                            <p className="text-sm text-slate-600 mb-4">
                                {inputSchema.parameters?.length || 0} parameter(s) detected for this agent
                            </p>
                        </div>
                        
                        {/* Parameters */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h3 className="text-sm font-semibold text-slate-700 mb-4">Parameters</h3>
                            <div className="space-y-4">
                                {inputSchema.parameters?.map((param, i) => (
                                    <div key={i} className="border border-slate-200 rounded-lg overflow-hidden">
                                        {/* Parameter Header */}
                                        <div className="bg-slate-50 p-4 border-b border-slate-200">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <span className="font-mono text-sm font-bold text-slate-900">{param.name}</span>
                                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-medium">
                                                    {param.type || param.raw_type || 'string'}
                                                </span>
                                                {param.required && (
                                                    <span className="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded font-medium">
                                                        required
                                                    </span>
                                                )}
                                            </div>
                                            {param.description && (
                                                <p className="text-sm text-slate-600 mt-2">{param.description}</p>
                                            )}
                                        </div>
                                        
                                        {/* Parameter Details */}
                                        <div className="p-4 space-y-3">
                                            {/* Examples */}
                                            {param.examples && param.examples.length > 0 && (
                                                <div>
                                                    <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Example</h4>
                                                    <code className="block text-xs bg-slate-50 border border-slate-200 rounded p-3 text-slate-700 break-words">
                                                        {typeof param.examples[0] === 'string' ? param.examples[0] : JSON.stringify(param.examples[0], null, 2)}
                                                    </code>
                                                </div>
                                            )}
                                            
                                            {/* Usage Info */}
                                            {(param.usedInAgents?.length > 0 || param.usedInTasks?.length > 0 || param.sources?.length > 0) && (
                                                <div className="flex flex-wrap gap-2 pt-2 border-t border-slate-100">
                                                    {param.sources && param.sources.length > 0 && (
                                                        <div className="text-xs">
                                                            <span className="text-slate-500">Sources:</span>
                                                            {param.sources.map((s, j) => (
                                                                <span key={j} className="ml-1 px-1.5 py-0.5 bg-slate-100 text-slate-600 rounded">
                                                                    {s}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Example Inputs */}
                        {inputSchema.exampleInputs && inputSchema.exampleInputs.length > 0 && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h3 className="text-sm font-semibold text-slate-700 mb-4">Example Input</h3>
                                <pre className="text-xs bg-slate-50 border border-slate-200 rounded-lg p-4 text-slate-700 overflow-x-auto">
                                    {JSON.stringify(inputSchema.exampleInputs[0], null, 2)}
                                </pre>
                            </div>
                        )}
                    </div>
                )}
            </div>
            
            {/* Boundary Sources Modal - Portal to body */}
            {showBoundarySources && ReactDOM.createPortal(
                <div 
                    className="fixed inset-0 bg-black/50 flex items-center justify-center p-4"
                    style={{ zIndex: 9999 }}
                    onClick={() => setShowBoundarySources(null)}
                >
                    <div 
                        className="bg-white rounded-xl max-w-2xl w-full p-6 shadow-xl"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex items-start justify-between mb-4 pb-4 border-b border-slate-200">
                            <div>
                                <h3 className="text-lg font-semibold text-slate-900">Boundary Evidence</h3>
                                <p className="text-sm text-slate-500 mt-1">{showBoundarySources.action}</p>
                            </div>
                            <button 
                                onClick={() => setShowBoundarySources(null)}
                                className="text-slate-400 hover:text-slate-600"
                            >
                                <Icons.X />
                            </button>
                        </div>
                        
                        <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                            <div className="flex items-center justify-between">
                                <span className="text-sm font-semibold text-slate-700">Confidence</span>
                                <span className="text-xl font-bold text-blue-600">
                                    {Math.round((showBoundarySources.confidence || 0) * 100)}%
                                </span>
                            </div>
                        </div>
                        
                        {showBoundarySources.evidence && (
                            <div className="bg-slate-50 rounded-lg p-4">
                                <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Evidence</h4>
                                <pre className="text-sm text-slate-800 whitespace-pre-wrap font-mono bg-white p-3 rounded border border-slate-200 max-h-60 overflow-y-auto">
                                    {showBoundarySources.evidence}
                                </pre>
                            </div>
                        )}
                        
                        <div className="mt-6 flex justify-end">
                            <button 
                                onClick={() => setShowBoundarySources(null)}
                                className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
            
            {/* Edit Modal - Portal to body */}
            {showEditModal && ReactDOM.createPortal(
                <div 
                    className="fixed inset-0 bg-black/50 flex items-center justify-center p-4"
                    style={{ zIndex: 9999 }}
                    onClick={() => setShowEditModal(false)}
                >
                    <div 
                        className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-xl flex flex-col"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex items-start justify-between p-6 border-b border-slate-200">
                            <div>
                                <h3 className="text-xl font-semibold text-slate-900">Edit {agent.name}</h3>
                                <p className="text-sm text-slate-500 mt-1">Edit the agent contract - changes will be saved to the agent YAML file</p>
                            </div>
                            <button 
                                onClick={() => setShowEditModal(false)}
                                className="text-slate-400 hover:text-slate-600"
                            >
                                <Icons.X />
                            </button>
                        </div>
                        
                        <div className="p-6 flex-1 overflow-y-auto">
                            <label className="block text-sm font-medium mb-2 text-slate-700">YAML Editor</label>
                            <textarea
                                value={editedYaml}
                                onChange={e => setEditedYaml(e.target.value)}
                                className="w-full h-96 p-4 border border-slate-300 rounded-lg font-mono text-sm bg-slate-50 text-slate-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                                placeholder="Loading..."
                            />
                            <p className="text-xs text-slate-500 mt-2">
                                Edit the YAML directly. Changes will be saved to <code className="bg-slate-100 px-1 rounded">{agent.filePath}</code>
                            </p>
                            
                            {editError && (
                                <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                                    {editError}
                                </div>
                            )}
                        </div>
                        
                        <div className="p-6 border-t border-slate-200 flex justify-end gap-3">
                            <button 
                                onClick={() => setShowEditModal(false)}
                                className="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition text-sm font-medium"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={saveAgent}
                                disabled={saving}
                                className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium disabled:opacity-50"
                            >
                                {saving ? 'Saving...' : 'Save Changes'}
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </div>
    );
};


// === components/views/dimensions.jsx ===
/**
 * Dimensions View
 * Displays list of evaluation dimensions with their configurations
 */

const DimensionsView = ({ onSelectDimension }) => {
    const data = window.IdentroData;
    const dimensions = data?.dimensions || [];
    
    // Calculate totals
    const enabledCount = dimensions.filter(d => d.enabled).length;
    const totalTests = dimensions.reduce((sum, d) => sum + (d.testCount || 0), 0);
    
    // Get dimension icon based on name
    const getDimensionIcon = (name) => {
        const icons = {
            Safety: Icons.Shield,
            safety: Icons.Shield,
            Consistency: Icons.Activity,
            consistency: Icons.Activity,
            Bias: Icons.Target,
            bias: Icons.Target,
            Privacy: Icons.Shield,
            privacy: Icons.Shield,
            Compliance: Icons.CheckCircle,
            compliance: Icons.CheckCircle,
            Hallucination: Icons.AlertTriangle,
            hallucination: Icons.AlertTriangle,
            Relevance: Icons.Target,
            relevance: Icons.Target,
            Toxicity: Icons.XCircle,
            toxicity: Icons.XCircle,
        };
        return icons[name] || Icons.Grid;
    };
    
    // Get dimension color based on name
    const getDimensionColor = (name) => {
        const colors = {
            Safety: { bg: 'bg-red-50', icon: 'bg-red-100 text-red-600', badge: 'bg-red-100 text-red-700' },
            safety: { bg: 'bg-red-50', icon: 'bg-red-100 text-red-600', badge: 'bg-red-100 text-red-700' },
            Consistency: { bg: 'bg-blue-50', icon: 'bg-blue-100 text-blue-600', badge: 'bg-blue-100 text-blue-700' },
            consistency: { bg: 'bg-blue-50', icon: 'bg-blue-100 text-blue-600', badge: 'bg-blue-100 text-blue-700' },
            Bias: { bg: 'bg-purple-50', icon: 'bg-purple-100 text-purple-600', badge: 'bg-purple-100 text-purple-700' },
            bias: { bg: 'bg-purple-50', icon: 'bg-purple-100 text-purple-600', badge: 'bg-purple-100 text-purple-700' },
            Privacy: { bg: 'bg-emerald-50', icon: 'bg-emerald-100 text-emerald-600', badge: 'bg-emerald-100 text-emerald-700' },
            privacy: { bg: 'bg-emerald-50', icon: 'bg-emerald-100 text-emerald-600', badge: 'bg-emerald-100 text-emerald-700' },
            Compliance: { bg: 'bg-amber-50', icon: 'bg-amber-100 text-amber-600', badge: 'bg-amber-100 text-amber-700' },
            compliance: { bg: 'bg-amber-50', icon: 'bg-amber-100 text-amber-600', badge: 'bg-amber-100 text-amber-700' },
            Hallucination: { bg: 'bg-orange-50', icon: 'bg-orange-100 text-orange-600', badge: 'bg-orange-100 text-orange-700' },
            hallucination: { bg: 'bg-orange-50', icon: 'bg-orange-100 text-orange-600', badge: 'bg-orange-100 text-orange-700' },
            Relevance: { bg: 'bg-cyan-50', icon: 'bg-cyan-100 text-cyan-600', badge: 'bg-cyan-100 text-cyan-700' },
            relevance: { bg: 'bg-cyan-50', icon: 'bg-cyan-100 text-cyan-600', badge: 'bg-cyan-100 text-cyan-700' },
            Toxicity: { bg: 'bg-pink-50', icon: 'bg-pink-100 text-pink-600', badge: 'bg-pink-100 text-pink-700' },
            toxicity: { bg: 'bg-pink-50', icon: 'bg-pink-100 text-pink-600', badge: 'bg-pink-100 text-pink-700' },
        };
        return colors[name] || { bg: 'bg-slate-50', icon: 'bg-slate-100 text-slate-600', badge: 'bg-slate-100 text-slate-700' };
    };

    return (
        <div className="animate-in">
            <Header 
                title="Dimensions" 
                subtitle="Evaluation criteria and their configurations"
            />
            
            {/* Compact Metrics Row */}
            <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                <div className="flex items-center gap-6 divide-x divide-slate-200">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Total</span>
                        <span className="text-sm font-semibold text-slate-900">{dimensions.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Enabled</span>
                        <span className="text-sm font-semibold text-emerald-600">{enabledCount}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Tests</span>
                        <span className="text-sm font-semibold text-slate-900">{totalTests}</span>
                    </div>
                </div>
            </div>

            {/* Dimensions List */}
            <div className="space-y-3">
                {dimensions.map((dim, i) => {
                    const DimIcon = getDimensionIcon(dim.name);
                    const colors = getDimensionColor(dim.name);
                    const priority = dim.spec?.priority;
                    const complexity = dim.spec?.metadata?.complexity;
                    
                    return (
                        <div 
                            key={dim.id || i}
                            onClick={() => onSelectDimension && onSelectDimension(dim.name)}
                            className="bg-white rounded-lg border border-slate-200 shadow-soft hover:shadow-card hover:border-slate-300 transition-all cursor-pointer animate-in group overflow-hidden"
                            style={{ animationDelay: `${i * 0.05}s` }}
                        >
                            {/* Header Section */}
                            <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                                <div className="flex items-start justify-between">
                                    <div className="flex items-start gap-3 flex-1 min-w-0">
                                        <div className={`mt-0.5 w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${colors.icon}`}>
                                            <DimIcon />
                                        </div>
                                        <div className="min-w-0 flex-1">
                                            {/* Badges row */}
                                            <div className="flex items-center gap-2 mb-1.5 flex-wrap">
                                                {/* Enabled/Disabled badge */}
                                                <span className={`text-xs px-2 py-0.5 rounded ${dim.enabled ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}`}>
                                                    {dim.enabled ? 'Enabled' : 'Disabled'}
                                                </span>
                                                
                                                {/* Priority */}
                                                {priority && (
                                                    <span className={`text-xs px-2 py-0.5 rounded ${colors.badge}`}>
                                                        P{priority}
                                                    </span>
                                                )}
                                                
                                                {/* Complexity */}
                                                {complexity && (
                                                    <span className="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded capitalize">
                                                        {complexity}
                                                    </span>
                                                )}
                                                
                                                {/* Test count */}
                                                {dim.testCount > 0 && (
                                                    <span className="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded">
                                                        {dim.testCount} test{dim.testCount !== 1 ? 's' : ''}
                                                    </span>
                                                )}
                                            </div>
                                            
                                            {/* Dimension name - blue link style */}
                                            <p className="text-sm font-semibold text-blue-600 group-hover:text-blue-700 transition-colors capitalize">
                                                {dim.name}
                                            </p>
                                            
                                            {/* Short description line */}
                                            <div className="flex items-center gap-2 mt-1 text-xs text-slate-500">
                                                <span>{dim.spec?.short_description || 'Evaluation dimension'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Right side - index number */}
                                    <div className="flex-shrink-0 ml-4">
                                        <span className="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded font-medium">#{i + 1}</span>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Body Section */}
                            <div className="p-4 space-y-3">
                                {/* Full description */}
                                {(dim.description || dim.spec?.description) && (
                                    <div>
                                        <div className="text-xs font-semibold text-slate-500 mb-1">DESCRIPTION</div>
                                        <div className="bg-slate-50 p-2 rounded text-xs text-slate-700 line-clamp-2 border border-slate-100">
                                            {dim.description || dim.spec?.description}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Tags preview */}
                                {dim.spec?.metadata?.tags && dim.spec.metadata.tags.length > 0 && (
                                    <div>
                                        <div className="text-xs font-semibold text-slate-500 mb-1">TAGS</div>
                                        <div className="flex flex-wrap gap-1.5">
                                            {dim.spec.metadata.tags.slice(0, 5).map((tag, j) => (
                                                <span key={j} className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded">
                                                    {tag}
                                                </span>
                                            ))}
                                            {dim.spec.metadata.tags.length > 5 && (
                                                <span className="text-xs text-slate-400">
                                                    +{dim.spec.metadata.tags.length - 5} more
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* Footer */}
                            <div className="px-4 py-2 bg-slate-50 border-t border-slate-100 flex items-center justify-between">
                                <div className="flex items-center gap-3 text-xs text-slate-500">
                                    {dim.filePath && (
                                        <span>Source: <strong className="text-slate-600 font-mono">{dim.filePath.split('/').pop()}</strong></span>
                                    )}
                                </div>
                                <span className="text-blue-600 text-xs font-medium flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                    View Details <Icons.ChevronRight />
                                </span>
                            </div>
                        </div>
                    );
                })}
                
                {dimensions.length === 0 && (
                    <div className="text-center py-12 bg-white rounded-lg border border-slate-200">
                        <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                            <Icons.Grid />
                        </div>
                        <h3 className="font-medium text-slate-900 mb-1">No dimensions found</h3>
                        <p className="text-slate-500 text-sm">
                            Run <code className="bg-slate-100 px-1 rounded">identro-eval init</code> to create default dimensions.
                        </p>
                    </div>
                )}
            </div>
        </div>
    );
};


// === components/views/dimension-detail.jsx ===
/**
 * Dimension Detail View
 * Displays detailed information about a specific dimension
 * Organized with tabs for better navigation
 */

const DimensionDetailView = ({ dimensionId, onBack }) => {
    const data = window.IdentroData;
    const dimensions = data?.dimensions || [];
    const dimension = dimensions.find(d => d.id === dimensionId || d.name === dimensionId);
    
    const [activeTab, setActiveTab] = useState('overview');
    const [showEditModal, setShowEditModal] = useState(false);
    const [editedYaml, setEditedYaml] = useState('');
    const [editError, setEditError] = useState('');
    const [saving, setSaving] = useState(false);
    const [isEnabled, setIsEnabled] = useState(dimension?.enabled || false);
    const [instructionType, setInstructionType] = useState('agent');
    
    // Get dimension icon based on name
    const getDimensionIcon = (name) => {
        const icons = {
            Safety: Icons.Shield,
            Consistency: Icons.Activity,
            Bias: Icons.Target,
            Privacy: Icons.Shield,
            Compliance: Icons.CheckCircle,
            Hallucination: Icons.AlertTriangle,
            Relevance: Icons.Target,
            Toxicity: Icons.XCircle,
        };
        return icons[name] || Icons.Grid;
    };
    
    // Get dimension color based on name
    const getDimensionColor = (name) => {
        const colors = {
            Safety: 'bg-red-100 text-red-600',
            Consistency: 'bg-blue-100 text-blue-600',
            Bias: 'bg-purple-100 text-purple-600',
            Privacy: 'bg-emerald-100 text-emerald-600',
            Compliance: 'bg-amber-100 text-amber-600',
            Hallucination: 'bg-orange-100 text-orange-600',
            Relevance: 'bg-cyan-100 text-cyan-600',
            Toxicity: 'bg-pink-100 text-pink-600',
        };
        return colors[name] || 'bg-slate-100 text-slate-600';
    };
    
    const openEdit = () => {
        if (!dimension) return;
        try {
            const yamlContent = window.jsyaml?.dump(dimension.spec, { indent: 2, lineWidth: 120 }) || JSON.stringify(dimension.spec, null, 2);
            setEditedYaml(yamlContent);
            setEditError('');
            setShowEditModal(true);
        } catch (e) {
            setEditedYaml(JSON.stringify(dimension.spec, null, 2));
            setShowEditModal(true);
        }
    };
    
    const saveDimension = async () => {
        setSaving(true);
        setEditError('');
        try {
            const parsed = window.jsyaml?.load(editedYaml) || JSON.parse(editedYaml);
            
            if (window.API_URL) {
                const response = await fetch(`${window.API_URL}/api/dimensions/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dimensionName: dimension.name,
                        yamlContent: editedYaml
                    })
                });
                
                if (!response.ok) throw new Error('Failed to save');
                alert(`${dimension.name} saved successfully!`);
                setShowEditModal(false);
            } else {
                // Fallback: download the file
                const blob = new Blob([editedYaml], { type: 'text/yaml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${dimension.name}.yml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert(`Dimension saved!\n\nPlease move the downloaded file to:\n${dimension.filePath}`);
                setShowEditModal(false);
            }
        } catch (error) {
            setEditError(`Error: ${error.message}`);
        }
        setSaving(false);
    };
    
    const toggleEnabled = async () => {
        const newState = !isEnabled;
        setIsEnabled(newState);
        
        if (window.API_URL) {
            try {
                const response = await fetch(`${window.API_URL}/api/dimensions/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dimensionName: dimension.name,
                        enabled: newState
                    })
                });
                
                if (!response.ok) {
                    setIsEnabled(!newState);
                    throw new Error('Failed to save');
                }
            } catch (error) {
                setIsEnabled(!newState);
                alert('Failed to save configuration. Please try again.');
            }
        } else {
            alert('API server not available. Start the dashboard with the API server for instant saves.');
            setIsEnabled(!newState);
        }
    };
    
    if (!dimension) {
        return (
            <div className="animate-in">
                <button 
                    onClick={onBack}
                    className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 mb-6 transition-colors"
                >
                    <Icons.ArrowLeft />
                    Back to Dimensions
                </button>
                <div className="text-center py-12 text-slate-500">
                    Dimension not found
                </div>
            </div>
        );
    }
    
    const spec = dimension.spec || {};
    const config = spec.configuration || {};
    const prompts = spec.prompts || {};
    const metadata = spec.metadata || {};
    const context = spec.context || {};
    const DimIcon = getDimensionIcon(dimension.name);
    
    const tabs = [
        { id: 'overview', label: 'Overview', icon: Icons.FileText },
        { id: 'configuration', label: 'Configuration', icon: Icons.Settings },
        { id: 'instructions', label: 'Test Instructions', icon: Icons.Terminal },
    ];

    return (
        <div className="animate-in">
            {/* Back Button */}
            <button 
                onClick={onBack}
                className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 mb-6 transition-colors"
            >
                <Icons.ArrowLeft />
                Back to Dimensions
            </button>
            
            {/* Header */}
            <div className="flex items-start justify-between mb-6">
                <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${getDimensionColor(dimension.name)}`}>
                            <DimIcon />
                        </div>
                        <div>
                            <div className="flex items-center gap-2">
                                <h1 className="text-2xl font-semibold text-slate-900">{dimension.name}</h1>
                                <span className={`w-2.5 h-2.5 rounded-full ${isEnabled ? 'bg-emerald-500' : 'bg-slate-300'}`} />
                            </div>
                            <p className="text-slate-500 text-sm">{spec.short_description || dimension.description}</p>
                        </div>
                    </div>
                </div>
                <div className="flex items-center gap-3">
                    {/* Enable/Disable Toggle */}
                    <div className="flex items-center gap-2">
                        <button 
                            onClick={toggleEnabled}
                            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 ${
                                isEnabled ? 'bg-emerald-600' : 'bg-slate-300'
                            }`}
                        >
                            <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                isEnabled ? 'translate-x-6' : 'translate-x-1'
                            }`} />
                        </button>
                        <span className={`text-sm font-medium ${isEnabled ? 'text-emerald-700' : 'text-slate-500'}`}>
                            {isEnabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </div>
                    
                    <button
                        onClick={openEdit}
                        className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium flex items-center gap-2"
                    >
                        <Icons.Settings />
                        Edit Dimension
                    </button>
                </div>
            </div>
            
            {/* Compact Metrics Row */}
            <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                <div className="flex items-center gap-6 divide-x divide-slate-200">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Priority</span>
                        <span className="text-sm font-semibold text-slate-900">{spec.priority ? `P${spec.priority}` : 'N/A'}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Complexity</span>
                        <span className="text-sm font-semibold text-slate-900 capitalize">{metadata.complexity || 'N/A'}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Test Count</span>
                        <span className="text-sm font-semibold text-slate-900">{config.test_count || 3}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Runs/Input</span>
                        <span className="text-sm font-semibold text-slate-900">{config.runs_per_input || 1}</span>
                    </div>
                </div>
            </div>
            
            {/* Tabs */}
            <div className="border-b border-slate-200 mb-6">
                <div className="flex gap-1">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2.5 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${
                                activeTab === tab.id 
                                    ? 'border-blue-500 text-blue-600' 
                                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                            }`}
                        >
                            <tab.icon />
                            {tab.label}
                        </button>
                    ))}
                </div>
            </div>
            
            {/* Tab Content */}
            <div className="min-h-[400px]">
                {/* Overview Tab */}
                {activeTab === 'overview' && (
                    <div className="space-y-6 animate-in">
                        {/* Description */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h2 className="text-lg font-semibold text-slate-900 mb-4">Description</h2>
                            <p className="text-slate-700">{spec.description || dimension.description || 'No description available'}</p>
                        </div>
                        
                        {/* Business Context */}
                        {(context.why_it_matters || context.when_to_prioritize) && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h2 className="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2">
                                    <Icons.Info />
                                    Business Context
                                </h2>
                                
                                <div className="space-y-4">
                                    {context.why_it_matters && (
                                        <div>
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center text-white">
                                                    <Icons.AlertTriangle />
                                                </span>
                                                <h3 className="text-sm font-semibold text-slate-700">Why It Matters</h3>
                                            </div>
                                            <div className="bg-slate-900 text-slate-100 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap overflow-x-auto">
                                                {context.why_it_matters}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {context.when_to_prioritize && (
                                        <div>
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="w-5 h-5 rounded-full bg-blue-500 flex items-center justify-center text-white">
                                                    <Icons.Target />
                                                </span>
                                                <h3 className="text-sm font-semibold text-slate-700">When to Prioritize</h3>
                                            </div>
                                            <div className="bg-slate-900 text-slate-100 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap overflow-x-auto">
                                                {context.when_to_prioritize}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* Metadata */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h2 className="text-lg font-semibold text-slate-900 mb-4">Metadata</h2>
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Version</h3>
                                    <p className="text-slate-900 font-medium">{metadata.version || 'N/A'}</p>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Author</h3>
                                    <p className="text-slate-900 font-medium">{metadata.author || 'Unknown'}</p>
                                </div>
                            </div>
                            
                            {metadata.tags && metadata.tags.length > 0 && (
                                <div className="mt-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Tags</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {metadata.tags.map((tag, i) => (
                                            <span key={i} className="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs">
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* Source Info */}
                        {dimension.filePath && (
                            <div className="bg-slate-50 rounded-xl border border-slate-200 p-4 text-sm text-slate-500">
                                <span className="font-medium">Source: </span>
                                <code className="text-xs bg-slate-200 px-2 py-0.5 rounded">{dimension.filePath}</code>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Configuration Tab */}
                {activeTab === 'configuration' && (
                    <div className="space-y-6 animate-in">
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h2 className="text-lg font-semibold text-slate-900 mb-4">Test Configuration</h2>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Test Count</h3>
                                    <p className="text-2xl font-bold text-slate-900">{config.test_count || 3}</p>
                                    <p className="text-xs text-slate-500 mt-1">Number of test cases to generate</p>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Runs Per Input</h3>
                                    <p className="text-2xl font-bold text-slate-900">{config.runs_per_input || 1}</p>
                                    <p className="text-xs text-slate-500 mt-1">Times to run each test case</p>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Similarity Threshold</h3>
                                    <p className="text-2xl font-bold text-slate-900">{config.similarity_threshold || 0.8}</p>
                                    <p className="text-xs text-slate-500 mt-1">Minimum similarity for consistency</p>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Timeout (ms)</h3>
                                    <p className="text-2xl font-bold text-slate-900">{config.timeout_ms || 60000}</p>
                                    <p className="text-xs text-slate-500 mt-1">Maximum execution time</p>
                                </div>
                            </div>
                        </div>
                        
                        {/* Thresholds */}
                        {config.thresholds && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h2 className="text-lg font-semibold text-slate-900 mb-4">Thresholds</h2>
                                <div className="grid grid-cols-3 gap-4">
                                    {Object.entries(config.thresholds).map(([key, value], i) => (
                                        <div key={i} className="bg-slate-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">{key}</h3>
                                            <p className="text-xl font-bold text-slate-900">{value}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Test Instructions Tab */}
                {activeTab === 'instructions' && (
                    <div className="animate-in">
                        {(prompts.agent_requirements || prompts.team_requirements) ? (
                            <div className="bg-white rounded-xl border border-slate-200 shadow-soft">
                                {/* Inline tabs for agent/team */}
                                <div className="flex border-b border-slate-200">
                                    <button
                                        onClick={() => setInstructionType('agent')}
                                        className={`flex-1 px-4 py-3 text-sm font-medium flex items-center justify-center gap-2 ${
                                            instructionType === 'agent'
                                                ? 'bg-blue-50 text-blue-700 border-b-2 border-blue-500'
                                                : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                                        }`}
                                    >
                                        <Icons.User />
                                        Agent Instructions
                                    </button>
                                    <button
                                        onClick={() => setInstructionType('team')}
                                        className={`flex-1 px-4 py-3 text-sm font-medium flex items-center justify-center gap-2 ${
                                            instructionType === 'team'
                                                ? 'bg-blue-50 text-blue-700 border-b-2 border-blue-500'
                                                : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                                        }`}
                                    >
                                        <Icons.Users />
                                        Team Instructions
                                    </button>
                                </div>
                                
                                {/* Content */}
                                <div className="p-4">
                                    {instructionType === 'agent' && (
                                        <div>
                                            {prompts.agent_requirements ? (
                                                <div className="bg-slate-900 text-slate-100 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap overflow-x-auto">
                                                    {prompts.agent_requirements}
                                                </div>
                                            ) : (
                                                <div className="text-center py-8 text-slate-500 text-sm">
                                                    No agent instructions defined
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    {instructionType === 'team' && (
                                        <div>
                                            {prompts.team_requirements ? (
                                                <div className="bg-slate-900 text-slate-100 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap overflow-x-auto">
                                                    {prompts.team_requirements}
                                                </div>
                                            ) : (
                                                <div className="text-center py-8 text-slate-500 text-sm">
                                                    No team instructions defined
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="text-center py-12 text-slate-500">
                                No test instructions configured for this dimension
                            </div>
                        )}
                        
                        {/* Evaluation Criteria */}
                        {prompts.evaluation_criteria && prompts.evaluation_criteria.length > 0 && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft mt-6">
                                <h2 className="text-lg font-semibold text-slate-900 mb-4">Evaluation Criteria</h2>
                                <ul className="space-y-2">
                                    {prompts.evaluation_criteria.map((criterion, i) => (
                                        <li key={i} className="flex items-start gap-3 p-3 bg-slate-50 rounded-lg">
                                            <span className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">
                                                {i + 1}
                                            </span>
                                            <span className="text-sm text-slate-700">{criterion}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </div>
                )}
            </div>
            
            {/* Edit Modal - Portal to body */}
            {showEditModal && ReactDOM.createPortal(
                <div 
                    className="fixed inset-0 bg-black/50 flex items-center justify-center p-4"
                    style={{ zIndex: 9999 }}
                    onClick={() => setShowEditModal(false)}
                >
                    <div 
                        className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-xl flex flex-col"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex items-start justify-between p-6 border-b border-slate-200">
                            <div>
                                <h3 className="text-xl font-semibold text-slate-900">Edit {dimension.name}</h3>
                                <p className="text-sm text-slate-500 mt-1">Edit the dimension specification - changes will be saved to the YAML file</p>
                            </div>
                            <button 
                                onClick={() => setShowEditModal(false)}
                                className="text-slate-400 hover:text-slate-600"
                            >
                                <Icons.X />
                            </button>
                        </div>
                        
                        <div className="p-6 flex-1 overflow-y-auto">
                            <label className="block text-sm font-medium mb-2 text-slate-700">YAML Editor</label>
                            <textarea
                                value={editedYaml}
                                onChange={e => setEditedYaml(e.target.value)}
                                className="w-full h-96 p-4 border border-slate-300 rounded-lg font-mono text-sm bg-slate-50 text-slate-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                                placeholder="Loading..."
                            />
                            <p className="text-xs text-slate-500 mt-2">
                                Edit the YAML directly. Changes will be saved to <code className="bg-slate-100 px-1 rounded">{dimension.filePath}</code>
                            </p>
                            
                            {editError && (
                                <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                                    {editError}
                                </div>
                            )}
                        </div>
                        
                        <div className="p-6 border-t border-slate-200 flex justify-end gap-3">
                            <button 
                                onClick={() => setShowEditModal(false)}
                                className="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition text-sm font-medium"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={saveDimension}
                                disabled={saving}
                                className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium disabled:opacity-50"
                            >
                                {saving ? 'Saving...' : 'Save Changes'}
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </div>
    );
};


// === components/views/tests.jsx ===
/**
 * Tests View
 * Displays all tests with filtering and detailed view capabilities
 * Follows the new design pattern with clickable cards and detail navigation
 */

const TestsView = ({ onSelectTest }) => {
    const [filters, setFilters] = useState({ dimension: '', entity: '', entityType: '', result: '' });
    const [groupBy, setGroupBy] = useState('none'); // 'none', 'entity', 'dimension'
    
    const data = window.IdentroData;
    
    // Get dimension settings for defaults
    const getDimensionSettings = (dimName) => {
        const dim = data?.dimensions?.find(d => d.name === dimName);
        return dim?.spec?.configuration || {};
    };
    
    // Get tests from multiple sources - dashboard data tests array and full test specs from entities
    const getFullTests = () => {
        const tests = [];
        
        // Extract tests from agents testSpecs (richer data)
        for (const agent of data?.agents || []) {
            for (const [dimension, dimSpec] of Object.entries(agent.testSpecs || {})) {
                const dimData = dimSpec;
                for (const test of dimData.tests || []) {
                    tests.push({
                        id: test.id || `test-${agent.name}-${dimension}-${test.name}`,
                        name: test.name,
                        ui_description: test.ui_description || test.description,
                        entityName: agent.name,
                        entityType: 'agent',
                        dimension,
                        priority: test.priority,
                        generated_by: test.generated_by,
                        generated_at: test.generated_at,
                        input: test.input,
                        expected: test.expected,
                        evaluation_criteria: test.evaluation_criteria || [],
                        multi_run: test.multi_run,
                        pass_threshold: test.pass_threshold,
                        status: test.status || 'pending',
                        filePath: dimData.path || agent.filePath,
                        rawSpec: test,
                    });
                }
            }
        }
        
        // Extract tests from crews/teams testSpecs (richer data)
        for (const crew of data?.crews || []) {
            for (const [dimension, dimSpec] of Object.entries(crew.testSpecs || {})) {
                const dimData = dimSpec;
                for (const test of dimData.tests || []) {
                    tests.push({
                        id: test.id || `test-${crew.name}-${dimension}-${test.name}`,
                        name: test.name,
                        ui_description: test.ui_description || test.description,
                        entityName: crew.name,
                        entityType: 'team',
                        dimension,
                        priority: test.priority,
                        generated_by: test.generated_by,
                        generated_at: test.generated_at,
                        input: test.input,
                        expected: test.expected,
                        evaluation_criteria: test.evaluation_criteria || [],
                        multi_run: test.multi_run,
                        pass_threshold: test.pass_threshold,
                        status: test.status || 'pending',
                        filePath: dimData.path || crew.filePath,
                        rawSpec: test,
                    });
                }
            }
        }
        
        // Extract tests from flows testSpecs (normalize camelCase to snake_case)
        for (const flow of data?.flows || []) {
            for (const [dimension, dimSpec] of Object.entries(flow.testSpecs || {})) {
                const dimData = dimSpec;
                for (const test of dimData.tests || []) {
                    // Normalize flow test property names (camelCase -> snake_case)
                    const multiRun = test.multiRun || test.multi_run;
                    tests.push({
                        id: test.id || `test-${flow.name}-${dimension}-${test.name}`,
                        name: test.name,
                        ui_description: test.ui_description || test.name,
                        entityName: flow.name,
                        entityType: 'flow',
                        dimension,
                        priority: test.priority,
                        generated_by: test.generatedBy || test.generated_by,
                        generated_at: test.generatedAt || test.generated_at,
                        input: test.input,
                        expected: test.expected,
                        evaluation_criteria: test.evaluationCriteria || test.evaluation_criteria || [],
                        multi_run: multiRun ? {
                            run_count: multiRun.runCount || multiRun.run_count,
                            run_type: multiRun.runType || multiRun.run_type,
                            aggregation_strategy: multiRun.aggregationStrategy || multiRun.aggregation_strategy,
                            execution_mode: multiRun.executionMode || multiRun.execution_mode,
                        } : null,
                        pass_threshold: test.passThreshold || test.pass_threshold,
                        status: test.status || 'pending',
                        filePath: dimData.path || flow.filePath,
                        rawSpec: test,
                    });
                }
            }
        }
        
        // Fallback to basic tests array if no testSpecs found
        if (tests.length === 0 && data?.tests?.length > 0) {
            return data.tests.map(t => ({
                ...t,
                ui_description: t.description,
                evaluation_criteria: [],
                rawSpec: t,
            }));
        }
        
        return tests;
    };
    
    const tests = getFullTests();
    
    // Get unique values for filters
    const allDimensions = [...new Set(tests.map(t => t.dimension).filter(Boolean))];
    const allEntities = [...new Set(tests.map(t => t.entityName).filter(Boolean))];
    const allEntityTypes = ['agent', 'team', 'flow'];
    const allResults = ['pending', 'passed', 'failed', 'skipped'];
    
    // Apply filters
    const filteredTests = tests.filter(test => {
        if (filters.dimension && test.dimension !== filters.dimension) return false;
        if (filters.entity && test.entityName !== filters.entity) return false;
        if (filters.entityType && test.entityType !== filters.entityType) return false;
        if (filters.result && test.status !== filters.result) return false;
        return true;
    });
    
    // Group tests if grouping is enabled
    const groupedTests = () => {
        if (groupBy === 'entity') {
            const groups = {};
            filteredTests.forEach(test => {
                const key = test.entityName;
                if (!groups[key]) groups[key] = { name: key, type: test.entityType, tests: [] };
                groups[key].tests.push(test);
            });
            return Object.values(groups);
        }
        if (groupBy === 'dimension') {
            const groups = {};
            filteredTests.forEach(test => {
                const key = test.dimension;
                if (!groups[key]) groups[key] = { name: key, tests: [] };
                groups[key].tests.push(test);
            });
            return Object.values(groups);
        }
        return null;
    };
    
    const hasActiveFilters = Object.values(filters).some(v => v);
    const clearFilters = () => setFilters({ dimension: '', entity: '', entityType: '', result: '' });
    
    // Calculate metrics
    const passedCount = tests.filter(t => t.status === 'passed').length;
    const failedCount = tests.filter(t => t.status === 'failed').length;
    const pendingCount = tests.filter(t => t.status === 'pending').length;
    
    // Get status icon and color
    const getStatusIcon = (status) => {
        switch(status) {
            case 'passed': return Icons.CheckCircle;
            case 'failed': return Icons.XCircle;
            default: return Icons.Target;
        }
    };
    
    const getStatusColor = (status) => {
        switch(status) {
            case 'passed': return 'bg-emerald-100 text-emerald-600';
            case 'failed': return 'bg-red-100 text-red-600';
            case 'skipped': return 'bg-slate-100 text-slate-500';
            default: return 'bg-amber-100 text-amber-600';
        }
    };
    
    const getDimensionColor = (name) => {
        const colors = {
            safety: 'bg-red-100 text-red-700',
            Safety: 'bg-red-100 text-red-700',
            consistency: 'bg-blue-100 text-blue-700',
            Consistency: 'bg-blue-100 text-blue-700',
            bias: 'bg-purple-100 text-purple-700',
            Bias: 'bg-purple-100 text-purple-700',
            privacy: 'bg-emerald-100 text-emerald-700',
            Privacy: 'bg-emerald-100 text-emerald-700',
            compliance: 'bg-amber-100 text-amber-700',
            Compliance: 'bg-amber-100 text-amber-700',
            hallucination: 'bg-orange-100 text-orange-700',
            Hallucination: 'bg-orange-100 text-orange-700',
            relevance: 'bg-cyan-100 text-cyan-700',
            Relevance: 'bg-cyan-100 text-cyan-700',
            toxicity: 'bg-pink-100 text-pink-700',
            Toxicity: 'bg-pink-100 text-pink-700',
        };
        return colors[name] || 'bg-violet-100 text-violet-700';
    };
    
    // Format test input for display
    const formatTestInput = (input, maxLength = 120) => {
        if (!input) return null;
        if (typeof input === 'string') {
            return input.length > maxLength ? input.slice(0, maxLength) + '...' : input;
        }
        if (typeof input === 'object') {
            // Handle flow test structure: input.flowInputs
            if (input.flowInputs) {
                if (input.flowInputs.scenario) {
                    const text = input.flowInputs.scenario;
                    return text.length > maxLength ? text.slice(0, maxLength) + '...' : text;
                }
                if (input.flowInputs.parameters) {
                    // Show key parameters
                    const params = input.flowInputs.parameters;
                    const keys = Object.keys(params).slice(0, 4);
                    const preview = keys.map(k => `${k}: ${typeof params[k] === 'string' ? params[k].slice(0, 30) : params[k]}`).join(' | ');
                    return preview.length > maxLength ? preview.slice(0, maxLength) + '...' : preview;
                }
                if (input.flowInputs.raw) {
                    const text = input.flowInputs.raw;
                    return text.length > maxLength ? text.slice(0, maxLength) + '...' : text;
                }
            }
            // Handle agent/team test structure
            if (input.scenario) return input.scenario.slice(0, maxLength) + (input.scenario.length > maxLength ? '...' : '');
            if (input.raw) return input.raw.slice(0, maxLength) + (input.raw.length > maxLength ? '...' : '');
            const str = JSON.stringify(input);
            return str.length > maxLength ? str.slice(0, maxLength) + '...' : str;
        }
        return String(input);
    };
    
    // Format test title/name - convert underscore names to human readable
    // e.g., "Injection_Safety_Test_Malicious_Complaint_Text" -> "Testing: Injection Safety Test Malicious Complaint Text"
    const formatTestTitle = (name) => {
        if (!name) return 'Unnamed Test';
        // Check if it already starts with "Testing:" - return as is
        if (name.startsWith('Testing:')) return name;
        // Check if it's an underscore-separated name (flow tests)
        if (name.includes('_') && !name.includes(' ')) {
            const humanReadable = name.replace(/_/g, ' ');
            return `Testing: ${humanReadable}`;
        }
        // Otherwise return as is (already human readable)
        return name;
    };
    
    // Format expected behavior for display
    const formatExpected = (expected, maxLength = 150) => {
        if (!expected) return null;
        if (typeof expected === 'string') {
            return expected.length > maxLength ? expected.slice(0, maxLength) + '...' : expected;
        }
        if (typeof expected === 'object') {
            // Handle flow expected structure: { endStep, stateAssertions }
            if (expected.endStep) {
                const endStepText = `End Step: ${expected.endStep}`;
                const assertions = expected.stateAssertions?.length || 0;
                return assertions > 0 
                    ? `${endStepText} | ${assertions} state assertion(s)`
                    : endStepText;
            }
            const str = JSON.stringify(expected);
            return str.length > maxLength ? str.slice(0, maxLength) + '...' : str;
        }
        return String(expected);
    };
    
    // Get pass threshold for test
    const getPassThreshold = (test) => {
        if (test.pass_threshold !== undefined) return test.pass_threshold;
        const dimSettings = getDimensionSettings(test.dimension);
        if (dimSettings?.passing_criteria_percentage) return dimSettings.passing_criteria_percentage;
        return 100;
    };
    
    // Get default strictness for dimension
    const getDefaultStrictness = (dimName) => {
        const dimSettings = getDimensionSettings(dimName);
        return dimSettings?.default_strictness || 95;
    };
    
    const groups = groupedTests();

    return (
        <div className="animate-in">
            <Header 
                title="Tests" 
                subtitle="All evaluation tests across dimensions and entities"
            />
            
            {/* Compact Metrics Row */}
            <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                <div className="flex items-center gap-6 divide-x divide-slate-200">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Total</span>
                        <span className="text-sm font-semibold text-slate-900">{tests.length}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Passed</span>
                        <span className="text-sm font-semibold text-emerald-600">{passedCount}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Failed</span>
                        <span className="text-sm font-semibold text-red-600">{failedCount}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Pending</span>
                        <span className="text-sm font-semibold text-amber-600">{pendingCount}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Dimensions</span>
                        <span className="text-sm font-semibold text-slate-900">{allDimensions.length}</span>
                    </div>
                </div>
            </div>

            {/* Filters */}
            <div className="flex items-center gap-2 mb-4 flex-wrap">
                <FilterDropdown 
                    label="Dimension" 
                    options={allDimensions} 
                    value={filters.dimension} 
                    onChange={(v) => setFilters(prev => ({ ...prev, dimension: v }))} 
                />
                <FilterDropdown 
                    label="Entity" 
                    options={allEntities} 
                    value={filters.entity} 
                    onChange={(v) => setFilters(prev => ({ ...prev, entity: v }))} 
                />
                <FilterDropdown 
                    label="Type" 
                    options={allEntityTypes} 
                    value={filters.entityType} 
                    onChange={(v) => setFilters(prev => ({ ...prev, entityType: v }))} 
                />
                <FilterDropdown 
                    label="Status" 
                    options={allResults} 
                    value={filters.result} 
                    onChange={(v) => setFilters(prev => ({ ...prev, result: v }))} 
                />
                
                {/* Group By */}
                <div className="ml-auto flex items-center gap-2">
                    <span className="text-xs text-slate-500">Group by:</span>
                    <select 
                        value={groupBy}
                        onChange={(e) => setGroupBy(e.target.value)}
                        className="text-sm border border-slate-200 rounded-md px-2 py-1 text-slate-600"
                    >
                        <option value="none">None</option>
                        <option value="entity">Entity</option>
                        <option value="dimension">Dimension</option>
                    </select>
                </div>
                
                {hasActiveFilters && (
                    <button 
                        onClick={clearFilters}
                        className="text-sm text-slate-500 hover:text-slate-700 ml-2"
                    >
                        Clear all
                    </button>
                )}
                
                <span className="text-sm text-slate-500">
                    {filteredTests.length} of {tests.length} tests
                </span>
            </div>

            {/* Tests List */}
            {groups ? (
                // Grouped view
                <div className="space-y-6">
                    {groups.map((group, gi) => (
                        <div key={group.name} className="animate-in" style={{ animationDelay: `${gi * 0.05}s` }}>
                            <div className="flex items-center gap-2 mb-3">
                                <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
                                    groupBy === 'entity' 
                                        ? (group.type === 'team' ? 'bg-violet-100 text-violet-600' : 'bg-blue-100 text-blue-600')
                                        : getDimensionColor(group.name)
                                }`}>
                                    {groupBy === 'entity' 
                                        ? (group.type === 'team' ? <Icons.Users /> : <Icons.User />)
                                        : <Icons.Grid />
                                    }
                                </div>
                                <h3 className="font-medium text-slate-900">{group.name}</h3>
                                <span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded">
                                    {group.tests.length} tests
                                </span>
                            </div>
                            <div className="space-y-3 ml-10">
                                {group.tests.map((test, i) => (
                                    <TestCard 
                                        key={test.id || i} 
                                        test={test} 
                                        index={i}
                                        groupBy={groupBy}
                                        onSelect={() => onSelectTest && onSelectTest(test.id)}
                                        getStatusIcon={getStatusIcon}
                                        getStatusColor={getStatusColor}
                                        getDimensionColor={getDimensionColor}
                                        formatTestInput={formatTestInput}
                                        formatExpected={formatExpected}
                                        formatTestTitle={formatTestTitle}
                                        getPassThreshold={getPassThreshold}
                                        getDefaultStrictness={getDefaultStrictness}
                                    />
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                // Flat list view
                <div className="space-y-3">
                    {filteredTests.map((test, i) => (
                        <TestCard 
                            key={test.id || i} 
                            test={test} 
                            index={i}
                            groupBy={groupBy}
                            onSelect={() => onSelectTest && onSelectTest(test.id)}
                            getStatusIcon={getStatusIcon}
                            getStatusColor={getStatusColor}
                            getDimensionColor={getDimensionColor}
                            formatTestInput={formatTestInput}
                            formatExpected={formatExpected}
                            formatTestTitle={formatTestTitle}
                            getPassThreshold={getPassThreshold}
                            getDefaultStrictness={getDefaultStrictness}
                        />
                    ))}
                    
                    {filteredTests.length === 0 && (
                        <div className="text-center py-12 bg-white rounded-lg border border-slate-200">
                            <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                                <Icons.TestTube />
                            </div>
                            <h3 className="font-medium text-slate-900 mb-1">
                                {tests.length === 0 ? 'No tests found' : 'No tests match filters'}
                            </h3>
                            <p className="text-slate-500 text-sm">
                                {tests.length === 0 
                                    ? <>Run <code className="bg-slate-100 px-1 rounded">identro-eval generate</code> to generate tests.</>
                                    : 'Try adjusting your filters.'}
                            </p>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
};

// Test Card Component - With separated header and body sections
const TestCard = ({ test, index, groupBy, onSelect, getDimensionColor, formatTestInput, formatExpected, formatTestTitle }) => {
    const inputPreview = formatTestInput(test.input);
    const expectedPreview = formatExpected ? formatExpected(test.expected) : null;
    // Use formatTestTitle if available, otherwise use raw name
    const displayTitle = formatTestTitle 
        ? formatTestTitle(test.ui_description || test.name) 
        : (test.ui_description || test.name);
    
    return (
        <div 
            onClick={onSelect}
            className="bg-white rounded-lg border border-slate-200 shadow-soft hover:shadow-card hover:border-slate-300 transition-all cursor-pointer animate-in group overflow-hidden"
            style={{ animationDelay: `${index * 0.02}s` }}
        >
            {/* Header Section */}
            <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                <div className="flex items-start justify-between">
                    <div className="flex items-start gap-3 flex-1 min-w-0">
                        {/* Test icon */}
                        <div className="mt-0.5 w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-amber-100 text-amber-600">
                            <Icons.Target />
                        </div>
                        
                        <div className="min-w-0 flex-1">
                            {/* Badges row */}
                            <div className="flex items-center gap-2 mb-1.5 flex-wrap">
                                {/* Dimension badge */}
                                <span className={`text-xs px-2 py-0.5 rounded font-medium capitalize ${getDimensionColor(test.dimension)}`}>
                                    {test.dimension}
                                </span>
                                
                                {/* Entity badge (only show if not grouped by entity) */}
                                {groupBy !== 'entity' && (
                                    <span className={`text-xs px-2 py-0.5 rounded flex items-center gap-1 ${
                                        test.entityType === 'team' 
                                            ? 'bg-violet-50 text-violet-600' 
                                            : test.entityType === 'flow'
                                            ? 'bg-indigo-50 text-indigo-600'
                                            : 'bg-blue-50 text-blue-600'
                                    }`}>
                                        {test.entityType === 'team' 
                                            ? <Icons.Users /> 
                                            : test.entityType === 'flow'
                                            ? <Icons.Activity />
                                            : <Icons.User />
                                        } {test.entityName}
                                    </span>
                                )}
                                
                                {/* Priority badge */}
                                {test.priority && (
                                    <span className="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded">
                                        P{test.priority}
                                    </span>
                                )}
                                
                                {/* Criteria count badge */}
                                {test.evaluation_criteria?.length > 0 && (
                                    <span className="text-xs bg-orange-50 text-orange-600 px-2 py-0.5 rounded">
                                        {test.evaluation_criteria.length} criteria
                                    </span>
                                )}
                                
                                {/* Multi-run badge */}
                                {test.multi_run && (
                                    <span className="text-xs bg-purple-50 text-purple-600 px-2 py-0.5 rounded">
                                        {test.multi_run.run_count}x runs
                                    </span>
                                )}
                            </div>
                            
                            {/* Test title - blue link style */}
                            <p className="text-sm font-semibold text-blue-600 group-hover:text-blue-700 transition-colors">
                                {displayTitle}
                            </p>
                            
                            {/* Test ID line */}
                            <div className="flex items-center gap-2 mt-1 text-xs text-slate-500">
                                <span>Test ID:</span>
                                <code className="font-mono text-slate-600">{test.id}</code>
                            </div>
                        </div>
                    </div>
                    
                    {/* Right side - index number */}
                    <div className="flex-shrink-0 ml-4">
                        <span className="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded font-medium">#{index + 1}</span>
                    </div>
                </div>
            </div>
            
            {/* Body Section */}
            <div className="p-4 space-y-3">
                {/* Test Input Preview */}
                {inputPreview && (
                    <div>
                        <div className="text-xs font-semibold text-slate-500 mb-1">TEST INPUT</div>
                        <div className="bg-slate-50 p-2 rounded text-xs text-slate-700 font-mono truncate border border-slate-100">
                            {inputPreview}
                        </div>
                    </div>
                )}
                
                {/* Expected Behavior */}
                {expectedPreview && (
                    <div>
                        <div className="text-xs font-semibold text-slate-500 mb-1">EXPECTED BEHAVIOR</div>
                        <div className="bg-blue-50 p-2 rounded text-xs text-blue-900 line-clamp-2">
                            {expectedPreview}
                        </div>
                    </div>
                )}
            </div>
            
            {/* Footer */}
            <div className="px-4 py-2 bg-slate-50 border-t border-slate-100 flex items-center justify-between">
                <div className="flex items-center gap-3 text-xs text-slate-500">
                    {test.generated_by && (
                        <span>Model: <strong className="text-slate-600">{test.generated_by}</strong></span>
                    )}
                    {test.generated_at && (
                        <span>{new Date(test.generated_at).toLocaleDateString()}</span>
                    )}
                </div>
                <span className="text-blue-600 text-xs font-medium flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                    View Details <Icons.ChevronRight />
                </span>
            </div>
        </div>
    );
};


// === components/views/test-detail.jsx ===
/**
 * Test Detail View
 * Displays detailed information about a specific test
 * Organized with tabs for better navigation: Overview, Criteria, Configuration
 */

const TestDetailView = ({ testId, onBack }) => {
    const data = window.IdentroData;
    
    const [activeTab, setActiveTab] = useState('overview');
    const [showEditModal, setShowEditModal] = useState(false);
    const [editedYaml, setEditedYaml] = useState('');
    const [editError, setEditError] = useState('');
    const [saving, setSaving] = useState(false);
    
    // Find the test by UUID across all entities
    const findTest = () => {
        // Search in agents - match by UUID
        for (const agent of data?.agents || []) {
            for (const [dimension, dimSpec] of Object.entries(agent.testSpecs || {})) {
                for (const test of dimSpec.tests || []) {
                    if (test.id === testId) {
                        return {
                            ...test,
                            entityName: agent.name,
                            entityType: 'agent',
                            dimension,
                            filePath: dimSpec.path || agent.filePath,
                            dimSpec,
                        };
                    }
                }
            }
        }
        
        // Search in crews - match by UUID
        for (const crew of data?.crews || []) {
            for (const [dimension, dimSpec] of Object.entries(crew.testSpecs || {})) {
                for (const test of dimSpec.tests || []) {
                    if (test.id === testId) {
                        return {
                            ...test,
                            entityName: crew.name,
                            entityType: 'team',
                            dimension,
                            filePath: dimSpec.path || crew.filePath,
                            dimSpec,
                        };
                    }
                }
            }
        }
        
        // Search in flows - match by UUID
        for (const flow of data?.flows || []) {
            for (const [dimension, dimSpec] of Object.entries(flow.testSpecs || {})) {
                for (const test of dimSpec.tests || []) {
                    if (test.id === testId) {
                        // Normalize flow test structure to match agent/team test structure
                        const multiRun = test.multiRun || test.multi_run;
                        return {
                            ...test,
                            entityName: flow.name,
                            entityType: 'flow',
                            dimension,
                            filePath: dimSpec.path || flow.filePath,
                            dimSpec,
                            // Normalize flow-specific fields
                            evaluation_criteria: test.evaluationCriteria || test.evaluation_criteria || [],
                            // Keep full input structure for formatTestInput to handle
                            input: test.input,
                            // Normalize multi_run with consistent property names
                            multi_run: multiRun ? {
                                run_count: multiRun.runCount || multiRun.run_count,
                                run_type: multiRun.runType || multiRun.run_type,
                                aggregation_strategy: multiRun.aggregationStrategy || multiRun.aggregation_strategy,
                                execution_mode: multiRun.executionMode || multiRun.execution_mode,
                            } : null,
                            ui_description: test.ui_description || test.name,
                            generated_by: test.generatedBy || test.generated_by,
                            generated_at: test.generatedAt || test.generated_at,
                        };
                    }
                }
            }
        }
        
        // Fallback to basic tests array
        const basicTest = data?.tests?.find(t => t.id === testId);
        if (basicTest) {
            return {
                ...basicTest,
                entityName: basicTest.entityName || 'Unknown',
                entityType: basicTest.entityType || 'unknown',
                dimension: basicTest.dimension || 'Unknown',
            };
        }
        
        return null;
    };
    
    const test = findTest();
    
    // Get dimension settings for pass threshold defaults
    const getDimensionSettings = () => {
        const dim = data?.dimensions?.find(d => d.name === test?.dimension);
        return dim?.spec?.configuration || {};
    };
    
    const dimSettings = getDimensionSettings();
    
    // Format test title/name - convert underscore names to human readable
    // e.g., "Injection_Safety_Test_Malicious_Complaint_Text" -> "Testing: Injection Safety Test Malicious Complaint Text"
    const formatTestTitle = (name) => {
        if (!name) return 'Unnamed Test';
        // Check if it already starts with "Testing:" - return as is
        if (name.startsWith('Testing:')) return name;
        // Check if it's an underscore-separated name (flow tests)
        if (name.includes('_') && !name.includes(' ')) {
            const humanReadable = name.replace(/_/g, ' ');
            return `Testing: ${humanReadable}`;
        }
        // Otherwise return as is (already human readable)
        return name;
    };
    
    const getDimensionColor = (name) => {
        const colors = {
            safety: 'bg-red-100 text-red-600',
            Safety: 'bg-red-100 text-red-600',
            consistency: 'bg-blue-100 text-blue-600',
            Consistency: 'bg-blue-100 text-blue-600',
            bias: 'bg-purple-100 text-purple-600',
            Bias: 'bg-purple-100 text-purple-600',
            privacy: 'bg-emerald-100 text-emerald-600',
            Privacy: 'bg-emerald-100 text-emerald-600',
            compliance: 'bg-amber-100 text-amber-600',
            Compliance: 'bg-amber-100 text-amber-600',
            hallucination: 'bg-orange-100 text-orange-600',
            Hallucination: 'bg-orange-100 text-orange-600',
            relevance: 'bg-cyan-100 text-cyan-600',
            Relevance: 'bg-cyan-100 text-cyan-600',
            toxicity: 'bg-pink-100 text-pink-600',
            Toxicity: 'bg-pink-100 text-pink-600',
        };
        return colors[name] || 'bg-violet-100 text-violet-600';
    };
    
    // Render test input as formatted key-value pairs with styling
    const renderTestInput = (input) => {
        if (!input) return <span className="text-slate-400 italic">No input defined</span>;
        if (typeof input === 'string') return <span>{input}</span>;
        
        // Extract parameters based on input structure
        let parameters = null;
        let scenario = null;
        let raw = null;
        
        if (typeof input === 'object') {
            // Flow test structure
            if (input.flowInputs) {
                parameters = input.flowInputs.parameters;
                scenario = input.flowInputs.scenario;
                raw = input.flowInputs.raw;
            } else {
                // Agent/team test structure
                parameters = input.parameters;
                scenario = input.scenario;
                raw = input.raw;
            }
        }
        
        // If we have structured parameters, render them nicely
        if (parameters && typeof parameters === 'object') {
            return (
                <div className="space-y-2">
                    {scenario && (
                        <div className="pb-2 mb-2 border-b border-slate-700">
                            <span className="text-cyan-400 font-medium">scenario: </span>
                            <span className="text-slate-300">{scenario}</span>
                        </div>
                    )}
                    {Object.entries(parameters).map(([key, value]) => (
                        <div key={key} className="flex items-start gap-2">
                            <span className="text-emerald-400 font-medium min-w-[140px] shrink-0">{key}:</span>
                            <span className="text-amber-200">
                                {typeof value === 'string' ? value : JSON.stringify(value)}
                            </span>
                        </div>
                    ))}
                </div>
            );
        }
        
        // Fallback to raw or scenario
        if (scenario) return <span>{scenario}</span>;
        if (raw) return <span>{raw}</span>;
        
        // Last resort: JSON stringify
        return <pre className="text-xs">{JSON.stringify(input, null, 2)}</pre>;
    };
    
    // Render expected behavior with proper formatting for flows vs agent/team
    const renderExpectedBehavior = (expected, entityType) => {
        if (!expected) return null;
        
        // String expected (agent/team tests)
        if (typeof expected === 'string') {
            return (
                <div className="bg-blue-50 text-blue-900 rounded-lg p-4 text-sm leading-relaxed">
                    {expected}
                </div>
            );
        }
        
        // Object expected (flow tests with endStep and stateAssertions)
        if (typeof expected === 'object') {
            return (
                <div className="space-y-3">
                    {expected.endStep && (
                        <div className="bg-indigo-50 rounded-lg p-4 border border-indigo-200">
                            <div className="flex items-center gap-2 mb-1">
                                <Icons.Activity />
                                <span className="text-xs font-semibold text-indigo-600 uppercase tracking-wide">Expected End Step</span>
                            </div>
                            <p className="text-lg font-mono font-semibold text-indigo-900">{expected.endStep}</p>
                            <p className="text-xs text-indigo-600 mt-1">Flow should complete at this step</p>
                        </div>
                    )}
                    {expected.stateAssertions && expected.stateAssertions.length > 0 && (
                        <div className="bg-violet-50 rounded-lg p-4 border border-violet-200">
                            <div className="flex items-center gap-2 mb-2">
                                <Icons.CheckCircle />
                                <span className="text-xs font-semibold text-violet-600 uppercase tracking-wide">State Assertions ({expected.stateAssertions.length})</span>
                            </div>
                            <div className="space-y-2">
                                {expected.stateAssertions.map((assertion, i) => (
                                    <div key={i} className="bg-white rounded p-2 text-sm font-mono text-violet-900 border border-violet-100">
                                        {typeof assertion === 'string' ? assertion : JSON.stringify(assertion)}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    {expected.stateAssertions && expected.stateAssertions.length === 0 && (
                        <p className="text-sm text-slate-500 italic">No state assertions defined</p>
                    )}
                </div>
            );
        }
        
        // Fallback
        return (
            <div className="bg-blue-50 text-blue-900 rounded-lg p-4 text-sm">
                <pre>{JSON.stringify(expected, null, 2)}</pre>
            </div>
        );
    };
    
    // Get strictness for a criterion
    const getStrictnessForCriterion = (criterion) => {
        if (criterion.evaluation_strictness !== undefined) {
            return criterion.evaluation_strictness;
        }
        if (dimSettings?.default_strictness) {
            return dimSettings.default_strictness;
        }
        return 85;
    };
    
    // Get pass threshold for the test
    const getPassThreshold = () => {
        if (test?.pass_threshold !== undefined) {
            return test.pass_threshold;
        }
        if (dimSettings?.passing_criteria_percentage) {
            return dimSettings.passing_criteria_percentage;
        }
        return 100;
    };
    
    const openEdit = () => {
        if (!test) return;
        try {
            const yamlContent = window.jsyaml?.dump(test.dimSpec, { indent: 2, lineWidth: 120 }) || JSON.stringify(test.dimSpec, null, 2);
            setEditedYaml(yamlContent);
            setEditError('');
            setShowEditModal(true);
        } catch (e) {
            setEditedYaml(JSON.stringify(test, null, 2));
            setShowEditModal(true);
        }
    };
    
    const saveTest = async () => {
        setSaving(true);
        setEditError('');
        try {
            const parsed = window.jsyaml?.load(editedYaml) || JSON.parse(editedYaml);
            
            if (window.API_URL) {
                const response = await fetch(`${window.API_URL}/api/tests/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: test.filePath,
                        yamlContent: editedYaml
                    })
                });
                
                if (!response.ok) throw new Error('Failed to save');
                alert('Test specification saved successfully!');
                setShowEditModal(false);
            } else {
                // Fallback: download the file
                const blob = new Blob([editedYaml], { type: 'text/yaml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${test.entityName}_${test.dimension}.yml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert(`Test saved!\n\nPlease move the downloaded file to:\n${test.filePath}`);
                setShowEditModal(false);
            }
        } catch (error) {
            setEditError(`Error: ${error.message}`);
        }
        setSaving(false);
    };
    
    if (!test) {
        return (
            <div className="animate-in">
                <button 
                    onClick={onBack}
                    className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 mb-6 transition-colors"
                >
                    <Icons.ArrowLeft />
                    Back to Tests
                </button>
                <div className="text-center py-12 text-slate-500">
                    Test not found
                </div>
            </div>
        );
    }
    
    const tabs = [
        { id: 'overview', label: 'Overview', icon: Icons.FileText },
        { id: 'criteria', label: 'Evaluation Criteria', icon: Icons.Target },
        { id: 'configuration', label: 'Configuration', icon: Icons.Settings },
    ];

    return (
        <div className="animate-in">
            {/* Back Button */}
            <button 
                onClick={onBack}
                className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 mb-6 transition-colors"
            >
                <Icons.ArrowLeft />
                Back to Tests
            </button>
            
            {/* Header */}
            <div className="flex items-start justify-between mb-6">
                <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                        <div className="w-12 h-12 rounded-xl flex items-center justify-center bg-slate-100 text-slate-600">
                            <Icons.TestTube />
                        </div>
                        <div>
                            <h1 className="text-xl font-semibold text-slate-900 mb-1">
                                {formatTestTitle(test.ui_description || test.name)}
                            </h1>
                            <div className="flex items-center gap-2 text-sm text-slate-500">
                                <span className={`px-2 py-0.5 rounded text-xs font-medium capitalize ${getDimensionColor(test.dimension)}`}>
                                    {test.dimension}
                                </span>
                                <span className="text-slate-300">â€¢</span>
                                <span className={`px-2 py-0.5 rounded text-xs flex items-center gap-1 ${
                                    test.entityType === 'team' 
                                        ? 'bg-violet-50 text-violet-600' 
                                        : test.entityType === 'flow'
                                        ? 'bg-indigo-50 text-indigo-600'
                                        : 'bg-blue-50 text-blue-600'
                                }`}>
                                    {test.entityType === 'team' 
                                        ? <Icons.Users /> 
                                        : test.entityType === 'flow'
                                        ? <Icons.Activity />
                                        : <Icons.User />
                                    } {test.entityName}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <button
                    onClick={openEdit}
                    className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium flex items-center gap-2"
                >
                    <Icons.Settings />
                    Edit Test
                </button>
            </div>
            
            {/* Compact Metrics Row */}
            <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                <div className="flex items-center gap-6 divide-x divide-slate-200">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Test ID</span>
                        <code className="text-xs font-mono bg-slate-100 px-2 py-0.5 rounded text-slate-700">{test.id}</code>
                    </div>
                    {test.priority && (
                        <div className="flex items-center gap-2 pl-6">
                            <span className="text-xs font-medium text-slate-500 uppercase">Priority</span>
                            <span className="text-sm font-semibold text-slate-900">P{test.priority}</span>
                        </div>
                    )}
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Criteria</span>
                        <span className="text-sm font-semibold text-orange-600">{test.evaluation_criteria?.length || 0}</span>
                    </div>
                    {test.multi_run && (
                        <div className="flex items-center gap-2 pl-6">
                            <span className="text-xs font-medium text-slate-500 uppercase">Runs</span>
                            <span className="text-sm font-semibold text-purple-600">{test.multi_run.run_count}x</span>
                        </div>
                    )}
                    {test.generated_by && (
                        <div className="flex items-center gap-2 pl-6">
                            <span className="text-xs font-medium text-slate-500 uppercase">Generated By</span>
                            <span className="text-sm font-medium text-slate-700">{test.generated_by}</span>
                        </div>
                    )}
                </div>
            </div>
            
            {/* Tabs */}
            <div className="border-b border-slate-200 mb-6">
                <div className="flex gap-1">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2.5 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${
                                activeTab === tab.id 
                                    ? 'border-blue-500 text-blue-600' 
                                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                            }`}
                        >
                            <tab.icon />
                            {tab.label}
                        </button>
                    ))}
                </div>
            </div>
            
            {/* Tab Content */}
            <div className="min-h-[400px]">
                {/* Overview Tab */}
                {activeTab === 'overview' && (
                    <div className="space-y-6 animate-in">
                        {/* Test Input */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h2 className="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2">
                                <Icons.Terminal />
                                Test Input
                            </h2>
                            <div className="bg-slate-900 text-slate-100 rounded-lg p-4 font-mono text-sm overflow-x-auto">
                                {renderTestInput(test.input)}
                            </div>
                        </div>
                        
                        {/* Expected Behavior */}
                        {test.expected && (
                            <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                                <h2 className="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2">
                                    <Icons.CheckCircle />
                                    Expected Behavior
                                </h2>
                                {renderExpectedBehavior(test.expected, test.entityType)}
                            </div>
                        )}
                        
                        {/* Metadata */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h2 className="text-lg font-semibold text-slate-900 mb-4">Metadata</h2>
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Entity</h3>
                                    <p className="text-slate-900 font-medium">{test.entityName}</p>
                                    <p className="text-slate-500 text-xs capitalize">{test.entityType}</p>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Dimension</h3>
                                    <p className="text-slate-900 font-medium">{test.dimension}</p>
                                </div>
                                {test.generated_at && (
                                    <div className="bg-slate-50 rounded-lg p-4">
                                        <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Generated At</h3>
                                        <p className="text-slate-900 font-medium">{new Date(test.generated_at).toLocaleString()}</p>
                                    </div>
                                )}
                                {test.generated_by && (
                                    <div className="bg-slate-50 rounded-lg p-4">
                                        <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Generated By</h3>
                                        <p className="text-slate-900 font-medium">{test.generated_by}</p>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* Source Info */}
                        {test.filePath && (
                            <div className="bg-slate-50 rounded-xl border border-slate-200 p-4 text-sm text-slate-500">
                                <span className="font-medium">Source: </span>
                                <code className="text-xs bg-slate-200 px-2 py-0.5 rounded">{test.filePath}</code>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Evaluation Criteria Tab */}
                {activeTab === 'criteria' && (
                    <div className="space-y-6 animate-in">
                        {test.evaluation_criteria?.length > 0 ? (
                            <>
                                {/* Pass Threshold Info */}
                                <div className="bg-amber-50 rounded-xl border border-amber-200 p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center text-amber-600">
                                            <Icons.Target />
                                        </div>
                                        <div>
                                            <h3 className="text-sm font-semibold text-amber-900">Pass/Fail Threshold</h3>
                                            <p className="text-sm text-amber-800">
                                                Must pass <strong>{getPassThreshold()}%</strong> of criteria
                                                ({Math.ceil((test.evaluation_criteria.length * getPassThreshold()) / 100)}/{test.evaluation_criteria.length})
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Criteria List */}
                                <div className="bg-white rounded-xl border border-slate-200 shadow-soft overflow-hidden">
                                    <div className="p-4 border-b border-slate-200 bg-slate-50">
                                        <h2 className="text-lg font-semibold text-slate-900">
                                            Evaluation Criteria ({test.evaluation_criteria.length})
                                        </h2>
                                    </div>
                                    <div className="divide-y divide-slate-100">
                                        {test.evaluation_criteria.map((criterion, i) => (
                                            <div key={i} className="p-4 hover:bg-slate-50 transition-colors">
                                                <div className="flex items-start justify-between">
                                                    <div className="flex items-start gap-3 flex-1">
                                                        <div className="flex-shrink-0 w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center font-bold text-sm">
                                                            {i + 1}
                                                        </div>
                                                        <div className="flex-1">
                                                            <h4 className="font-medium text-slate-900 mb-1">
                                                                {criterion.criterion}
                                                            </h4>
                                                            {criterion.ui_description && (
                                                                <p className="text-sm text-slate-600 mb-2">
                                                                    {criterion.ui_description}
                                                                </p>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="ml-4 flex-shrink-0">
                                                        <span className="inline-flex items-center gap-1 text-xs bg-orange-50 text-orange-700 px-2 py-1 rounded-lg font-medium">
                                                            Strictness: {getStrictnessForCriterion(criterion)}%
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="text-center py-12 bg-white rounded-xl border border-slate-200">
                                <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                                    <Icons.Target />
                                </div>
                                <h3 className="font-medium text-slate-900 mb-1">No evaluation criteria defined</h3>
                                <p className="text-slate-500 text-sm">
                                    Add evaluation criteria to specify how this test should be evaluated.
                                </p>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Configuration Tab */}
                {activeTab === 'configuration' && (
                    <div className="space-y-6 animate-in">
                        {/* Combined Configuration */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-soft">
                            <h2 className="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2">
                                <Icons.Settings />
                                Test Configuration
                            </h2>
                            
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Pass Threshold</h3>
                                    <p className="text-2xl font-bold text-slate-900">{getPassThreshold()}%</p>
                                    <p className="text-xs text-slate-500 mt-1">Criteria pass percentage required</p>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Default Strictness</h3>
                                    <p className="text-2xl font-bold text-slate-900">{dimSettings?.default_strictness || 95}%</p>
                                    <p className="text-xs text-slate-500 mt-1">From dimension settings</p>
                                </div>
                            </div>
                            
                            {/* Multi-Run Configuration */}
                            {test.multi_run && (
                                <>
                                    <h3 className="text-md font-semibold text-slate-800 mb-3 flex items-center gap-2">
                                        <Icons.Activity />
                                        Multi-Run Configuration
                                    </h3>
                                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div className="bg-purple-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-purple-700 uppercase tracking-wide mb-1">Run Count</h3>
                                            <p className="text-2xl font-bold text-purple-900">{test.multi_run.run_count}</p>
                                        </div>
                                        <div className="bg-purple-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-purple-700 uppercase tracking-wide mb-1">Execution Mode</h3>
                                            <p className="text-lg font-semibold text-purple-900 capitalize">{test.multi_run.execution_mode || 'sequential'}</p>
                                        </div>
                                        <div className="bg-purple-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-purple-700 uppercase tracking-wide mb-1">Run Type</h3>
                                            <p className="text-lg font-semibold text-purple-900 capitalize">{test.multi_run.run_type || 'consistency'}</p>
                                        </div>
                                        <div className="bg-purple-50 rounded-lg p-4">
                                            <h3 className="text-xs font-semibold text-purple-700 uppercase tracking-wide mb-1">Aggregation</h3>
                                            <p className="text-lg font-semibold text-purple-900 capitalize">{test.multi_run.aggregation_strategy || 'majority'}</p>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                )}
            </div>
            
            {/* Edit Modal - Portal to body */}
            {showEditModal && ReactDOM.createPortal(
                <div 
                    className="fixed inset-0 bg-black/50 flex items-center justify-center p-4"
                    style={{ zIndex: 9999 }}
                    onClick={() => setShowEditModal(false)}
                >
                    <div 
                        className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-xl flex flex-col"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex items-start justify-between p-6 border-b border-slate-200">
                            <div>
                                <h3 className="text-xl font-semibold text-slate-900">Edit Test: {test.name}</h3>
                                <p className="text-sm text-slate-500 mt-1">Edit the test specification - changes will be saved to the YAML file</p>
                            </div>
                            <button 
                                onClick={() => setShowEditModal(false)}
                                className="text-slate-400 hover:text-slate-600"
                            >
                                <Icons.X />
                            </button>
                        </div>
                        
                        <div className="p-6 flex-1 overflow-y-auto">
                            <label className="block text-sm font-medium mb-2 text-slate-700">YAML Editor</label>
                            <textarea
                                value={editedYaml}
                                onChange={e => setEditedYaml(e.target.value)}
                                className="w-full h-96 p-4 border border-slate-300 rounded-lg font-mono text-sm bg-slate-50 text-slate-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                                placeholder="Loading..."
                            />
                            <p className="text-xs text-slate-500 mt-2">
                                Edit the YAML directly. Changes will be saved to <code className="bg-slate-100 px-1 rounded">{test.filePath}</code>
                            </p>
                            
                            {editError && (
                                <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                                    {editError}
                                </div>
                            )}
                        </div>
                        
                        <div className="p-6 border-t border-slate-200 flex justify-end gap-3">
                            <button 
                                onClick={() => setShowEditModal(false)}
                                className="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition text-sm font-medium"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={saveTest}
                                disabled={saving}
                                className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition text-sm font-medium disabled:opacity-50"
                            >
                                {saving ? 'Saving...' : 'Save Changes'}
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
        </div>
    );
};


// === components/views/reports/test-detail-panel.jsx ===
/**
 * Test Detail Panel
 * Slide-out panel showing full test details with multi-run support
 * Handles: single-run tests, multi-run tests with per-run evaluations, and comparative mode
 */

const TestDetailPanel = ({ test, onClose }) => {
    const [activeRunIndex, setActiveRunIndex] = useState(0);
    const [currentCriteriaIndex, setCurrentCriteriaIndex] = useState(0);
    const [expandedSections, setExpandedSections] = useState({ input: false, output: false });

    const toggleSection = (section) => {
        setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
    };

    if (!test) {
        return null;
    }

    // Determine if this is a multi-run test
    const isMultiRun = test.isMultiRun || (test.totalRuns && test.totalRuns > 1);
    const isComparativeMode = test.evaluation?.reasoning?.evaluationMode === 'comparative';
    const hasPerRunEvaluations = test.perRunEvaluations && test.perRunEvaluations.length > 0;
    
    // Parse outputs for multi-run tests
    const runOutputs = isMultiRun && test.output 
        ? test.output.split('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n').map((output, i) => {
            return output.replace(/^Run \d+:\n/, '').trim();
          })
        : [test.output];
    
    const totalRuns = isMultiRun ? (test.totalRuns || runOutputs.length) : 1;
    
    // Get criteria to display based on mode
    const getCriteriaToDisplay = () => {
        // For comparative mode, use comparativeData
        if (isComparativeMode && test.comparativeData) {
            return test.comparativeData.map((criterionEval) => ({
                criterion: criterionEval.criterion,
                met: criterionEval.overall_met,
                score: criterionEval.score,
                evidence: criterionEval.evidence || 'No evidence provided',
                reasoning: criterionEval.reasoning || '',
                variations: criterionEval.variations || [],
                strictness: 95,
                isComparative: true
            }));
        }
        
        // For multi-run tests with per-run evaluations, use run-specific criteria
        if (isMultiRun && hasPerRunEvaluations) {
            return test.perRunEvaluations.map((criterionEval) => {
                const runData = criterionEval.runs[activeRunIndex];
                return runData ? {
                    criterion: criterionEval.criterion,
                    met: runData.met,
                    score: runData.score,
                    evidence: runData.evidence || 'No evidence provided',
                    reasoning: runData.reasoning || `Run ${activeRunIndex + 1}: ${runData.met ? 'Passed' : 'Failed'} (${(runData.score * 100).toFixed(0)}%)`,
                    strictness: 95
                } : null;
            }).filter(Boolean);
        }
        
        // For single-run tests, use aggregated criteria from evaluation
        if (test.evaluation?.reasoning?.criterionAnalysis) {
            return test.evaluation.reasoning.criterionAnalysis;
        }
        
        // Fallback: try to extract from evaluationCriteria if present
        if (test.evaluationCriteria && test.evaluationCriteria.length > 0) {
            return test.evaluationCriteria.map(c => ({
                criterion: c.criterion || c.text || c,
                met: test.passed,
                score: test.passed ? 1 : 0,
                evidence: 'See full output',
                reasoning: '',
                strictness: c.strictness || 95
            }));
        }
        
        return [];
    };

    const criteriaToDisplay = getCriteriaToDisplay();
    const currentCriterion = criteriaToDisplay[currentCriteriaIndex];

    // Get score color
    const getScoreColor = (score) => {
        const pct = score * 100;
        if (pct >= 90) return 'text-emerald-600';
        if (pct >= 75) return 'text-amber-600';
        return 'text-red-600';
    };

    const getScoreBarColor = (score) => {
        const pct = score * 100;
        if (pct >= 90) return 'bg-emerald-500';
        if (pct >= 75) return 'bg-amber-500';
        return 'bg-red-500';
    };

    // Calculate run stats for multi-run tests
    const getRunStats = (runIdx) => {
        if (!hasPerRunEvaluations) return { passed: false, score: 0 };
        const runEvals = test.perRunEvaluations.map(c => c.runs[runIdx]).filter(Boolean);
        const passed = runEvals.every(r => r?.met);
        const avgScore = runEvals.length > 0 
            ? runEvals.reduce((sum, r) => sum + (r?.score || 0), 0) / runEvals.length 
            : 0;
        return { passed, score: avgScore };
    };

    return (
        <div className="fixed inset-0 z-50 flex">
            {/* Backdrop */}
            <div className="absolute inset-0 bg-slate-900/20 backdrop-blur-sm" onClick={onClose} />
            
            {/* Panel */}
            <div className="absolute right-0 top-0 bottom-0 w-[800px] max-w-full bg-white shadow-2xl flex flex-col animate-slide-in">
                {/* Panel Header */}
                <div className="flex-shrink-0 border-b border-slate-200 p-5">
                    <div className="flex items-start justify-between gap-4">
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-3 flex-wrap">
                                <span className="text-xs bg-violet-100 text-violet-700 px-2 py-0.5 rounded font-medium">
                                    {test.dimension}
                                </span>
                                <span className="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded font-mono">
                                    {test.agentName}
                                </span>
                                {test.isTeam && (
                                    <span className="text-[10px] text-slate-400 uppercase">TEAM</span>
                                )}
                                {isMultiRun && (
                                    <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">
                                        {test.passedRuns || 0}/{totalRuns} runs
                                    </span>
                                )}
                                {isComparativeMode && (
                                    <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">
                                        Comparative
                                    </span>
                                )}
                            </div>
                            {/* Test Name */}
                            <h2 className="text-lg font-semibold text-slate-900 mb-2">
                                {test.displayName || test.name || `${test.dimension} Test`}
                            </h2>
                            {/* Test Description/Scenario */}
                            <p className="text-sm text-slate-600 leading-relaxed">
                                {test.displayDescription || test.input?.scenario || test.description || test.evaluation?.ui_explanation || `Evaluates ${test.dimension} behavior`}
                            </p>
                        </div>
                        <button 
                            onClick={onClose}
                            className="p-2 hover:bg-slate-100 rounded-lg transition-colors flex-shrink-0 -mr-2 -mt-2"
                        >
                            <Icons.ClosePanel />
                        </button>
                    </div>
                    
                    {/* Test Stats */}
                    <div className="flex items-center gap-6 mt-4 pt-4 border-t border-slate-100">
                        <div className="flex items-center gap-2">
                            {test.passed ? (
                                <span className="text-emerald-600"><Icons.CheckCircle /></span>
                            ) : (
                                <span className="text-red-600"><Icons.XCircle /></span>
                            )}
                            <Badge variant={test.passed ? 'passed' : 'failed'}>{test.passed ? 'PASSED' : 'FAILED'}</Badge>
                        </div>
                        <div className="text-sm">
                            <span className="text-slate-500">Score:</span>
                            <span className={`font-mono font-semibold ml-1 ${test.passed ? 'text-emerald-600' : 'text-red-600'}`}>
                                {test.evaluation?.score !== undefined 
                                    ? `${Math.round(test.evaluation.score * 100)}%`
                                    : `${test.evaluation?.reasoning?.passedPercentage || 0}%`}
                            </span>
                            <span className="text-slate-400 ml-1">
                                / {test.evaluation?.reasoning?.passingThreshold || 100}% required
                            </span>
                        </div>
                        {test.latencyMs && (
                            <div className="text-sm">
                                <span className="text-slate-500">Latency:</span>
                                <span className="font-mono ml-1 text-slate-700">{Math.round(test.latencyMs)}ms</span>
                            </div>
                        )}
                    </div>
                </div>

                {/* Sticky Runs Tabs - outside scrollable area */}
                {isMultiRun && !isComparativeMode && (
                    <div className="flex-shrink-0 border-b border-slate-200 bg-slate-50 sticky top-0 z-10">
                        <div className="flex items-center px-5 overflow-x-auto">
                            <span className="text-xs font-medium text-slate-500 uppercase tracking-wide mr-4 py-3 flex-shrink-0">
                                Runs:
                            </span>
                            {[...Array(totalRuns)].map((_, runIdx) => {
                                const stats = getRunStats(runIdx);
                                return (
                                    <button
                                        key={runIdx}
                                        onClick={() => {
                                            setActiveRunIndex(runIdx);
                                            setCurrentCriteriaIndex(0);
                                        }}
                                        className={`flex flex-col items-center gap-1 px-4 py-3 text-sm font-medium border-b-2 transition-colors flex-shrink-0 min-w-[100px] ${
                                            activeRunIndex === runIdx 
                                                ? 'border-slate-900 text-slate-900 bg-white' 
                                                : 'border-transparent text-slate-500 hover:text-slate-700'
                                        }`}
                                    >
                                        <div className="flex items-center gap-2">
                                            <span>Run {runIdx + 1}</span>
                                            <span className={`w-2 h-2 rounded-full ${stats.passed ? 'bg-emerald-500' : 'bg-red-500'}`}></span>
                                        </div>
                                        <div className="text-xs text-slate-400">
                                            {(stats.score * 100).toFixed(0)}%
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                )}

                {/* Sticky Output Tabs for Comparative Mode */}
                {isComparativeMode && (
                    <div className="flex-shrink-0 border-b border-slate-200 bg-slate-50 sticky top-0 z-10">
                        <div className="flex items-center px-5 overflow-x-auto">
                            <span className="text-xs font-medium text-slate-500 uppercase tracking-wide mr-4 py-3 flex-shrink-0">
                                Outputs:
                            </span>
                            {runOutputs.map((_, runIdx) => (
                                <button
                                    key={runIdx}
                                    onClick={() => setActiveRunIndex(runIdx)}
                                    className={`flex items-center gap-2 px-4 py-3 text-sm font-medium border-b-2 transition-colors flex-shrink-0 ${
                                        activeRunIndex === runIdx 
                                            ? 'border-indigo-600 text-indigo-700 bg-white' 
                                            : 'border-transparent text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    <span>ðŸ“</span>
                                    <span>Output {runIdx + 1}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                )}

                {/* Panel Body - Scrollable */}
                <div className="flex-1 overflow-y-auto scrollbar-thin">
                    {/* Test Input - Collapsible */}
                    {test.input && (
                        <div className="border-b border-slate-200">
                            <button 
                                onClick={() => toggleSection('input')}
                                className="w-full px-5 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors"
                            >
                                <div className="flex items-center gap-3">
                                    <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5 text-blue-500" stroke="currentColor" strokeWidth="1.5">
                                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" strokeLinecap="round" strokeLinejoin="round"/>
                                    </svg>
                                    <span className="text-sm font-semibold text-slate-900">Test Input</span>
                                </div>
                                <span className={`text-slate-400 transition-transform ${expandedSections.input ? '' : '-rotate-90'}`}>
                                    <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5" stroke="currentColor" strokeWidth="2">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </span>
                            </button>
                            
                            {expandedSections.input && (
                                <div className="px-5 pb-5">
                                    <div className="bg-slate-900 rounded-lg overflow-hidden">
                                        <pre className="text-xs font-mono p-4 overflow-x-auto max-h-80 scrollbar-thin">
                                            <JsonHighlight 
                                                data={typeof test.input === 'string' ? test.input : test.input} 
                                            />
                                        </pre>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Comparative Mode Header */}
                    {isComparativeMode && (
                        <div className="p-5 border-b border-slate-200">
                            <div className="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-4">
                                <div className="flex items-center gap-3 mb-2">
                                    <span className="text-xl">ðŸ”„</span>
                                    <div>
                                        <div className="text-sm font-semibold text-indigo-800">
                                            Comparative Evaluation Mode
                                        </div>
                                        <div className="text-xs text-indigo-600">
                                            All {totalRuns} outputs compared for semantic consistency
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Active Output Display - Collapsible */}
                    <div className="border-b border-slate-200">
                        <button 
                            onClick={() => toggleSection('output')}
                            className="w-full px-5 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors"
                        >
                            <div className="flex items-center gap-3">
                                <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5 text-violet-500" stroke="currentColor" strokeWidth="1.5">
                                    <path d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                                <span className="text-sm font-semibold text-slate-900">
                                    {isMultiRun ? `Run ${activeRunIndex + 1} Output` : (test.isTeam ? 'Crew Output' : 'Agent Response')}
                                </span>
                            </div>
                            <span className={`text-slate-400 transition-transform ${expandedSections.output ? '' : '-rotate-90'}`}>
                                <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5" stroke="currentColor" strokeWidth="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </span>
                        </button>
                        
                        {expandedSections.output && (
                            <div className="px-5 pb-5">
                                <div className="bg-slate-900 rounded-lg overflow-hidden">
                                    <pre className="text-xs font-mono p-4 overflow-x-auto max-h-80 scrollbar-thin">
                                        <JsonHighlight 
                                            data={runOutputs[activeRunIndex] || test.output || 'No output recorded'} 
                                        />
                                    </pre>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Evaluation Criteria */}
                    <div className="p-5">
                        <div className="flex items-center gap-2 mb-4">
                            <Icons.Target />
                            <span className="text-xs font-medium text-slate-500 uppercase tracking-wide">
                                Evaluation Criteria ({criteriaToDisplay.length})
                            </span>
                            {isMultiRun && !isComparativeMode && hasPerRunEvaluations && (
                                <span className="text-xs text-slate-400 ml-2">
                                    Showing Run {activeRunIndex + 1} evaluations
                                </span>
                            )}
                        </div>

                        {criteriaToDisplay.length > 0 ? (
                            <div className="space-y-4">
                                {/* Criteria Navigator */}
                                {criteriaToDisplay.length > 1 && (
                                    <div className="flex items-center justify-between bg-slate-50 rounded-lg p-3">
                                        <button
                                            onClick={() => setCurrentCriteriaIndex(Math.max(0, currentCriteriaIndex - 1))}
                                            disabled={currentCriteriaIndex === 0}
                                            className={`p-2 rounded-full ${currentCriteriaIndex === 0 ? 'text-slate-300 cursor-not-allowed' : 'text-slate-600 hover:bg-slate-200'}`}
                                        >
                                            <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5" stroke="currentColor" strokeWidth="2">
                                                <polyline points="15 18 9 12 15 6"/>
                                            </svg>
                                        </button>
                                        <div className="flex items-center gap-2">
                                            {criteriaToDisplay.map((_, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => setCurrentCriteriaIndex(idx)}
                                                    className={`w-2 h-2 rounded-full transition-all ${
                                                        idx === currentCriteriaIndex 
                                                            ? 'w-6 bg-slate-700' 
                                                            : 'bg-slate-300 hover:bg-slate-400'
                                                    }`}
                                                />
                                            ))}
                                        </div>
                                        <button
                                            onClick={() => setCurrentCriteriaIndex(Math.min(criteriaToDisplay.length - 1, currentCriteriaIndex + 1))}
                                            disabled={currentCriteriaIndex === criteriaToDisplay.length - 1}
                                            className={`p-2 rounded-full ${currentCriteriaIndex === criteriaToDisplay.length - 1 ? 'text-slate-300 cursor-not-allowed' : 'text-slate-600 hover:bg-slate-200'}`}
                                        >
                                            <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5" stroke="currentColor" strokeWidth="2">
                                                <polyline points="9 18 15 12 9 6"/>
                                            </svg>
                                        </button>
                                    </div>
                                )}

                                {/* Current Criterion */}
                                {currentCriterion && (
                                    <div className={`border rounded-lg overflow-hidden ${
                                        currentCriterion.met ? 'border-emerald-200' : 'border-red-200'
                                    }`}>
                                        {/* Criterion Header */}
                                        <div className={`px-4 py-3 ${currentCriterion.met ? 'bg-emerald-50' : 'bg-red-50'}`}>
                                            <div className="flex items-center justify-between mb-2">
                                                <div className="flex items-center gap-3">
                                                    {currentCriterion.met ? (
                                                        <span className="text-emerald-600"><Icons.Check /></span>
                                                    ) : (
                                                        <span className="text-red-600"><Icons.X /></span>
                                                    )}
                                                    <span className="text-xs text-slate-500">
                                                        Criterion {currentCriteriaIndex + 1} of {criteriaToDisplay.length}
                                                    </span>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xs text-slate-500">
                                                        Strictness: {currentCriterion.strictness || 95}
                                                    </span>
                                                    <span className={`text-lg font-mono font-bold ${getScoreColor(currentCriterion.score)}`}>
                                                        {Math.round((currentCriterion.score || 0) * 100)}%
                                                    </span>
                                                </div>
                                            </div>
                                            <p className="text-sm font-medium text-slate-900">
                                                {currentCriterion.criterion}
                                            </p>
                                            
                                            {/* Score bar */}
                                            <div className="mt-3 h-2 bg-slate-200 rounded-full relative overflow-hidden">
                                                <div 
                                                    className={`h-full ${getScoreBarColor(currentCriterion.score)} transition-all duration-500`}
                                                    style={{ width: `${(currentCriterion.score || 0) * 100}%` }}
                                                />
                                                <div 
                                                    className="absolute top-0 bottom-0 w-0.5 bg-slate-600"
                                                    style={{ left: `${currentCriterion.strictness || 95}%` }}
                                                />
                                            </div>
                                        </div>
                                        
                                        {/* Criterion Body */}
                                        <div className="p-4 bg-white space-y-4">
                                            {currentCriterion.reasoning && (
                                                <div>
                                                    <div className="text-xs font-medium text-slate-500 mb-1">Reasoning</div>
                                                    <p className="text-sm text-slate-700">{currentCriterion.reasoning}</p>
                                                </div>
                                            )}
                                            {currentCriterion.evidence && (
                                                <div>
                                                    <div className="text-xs font-medium text-slate-500 mb-1">Evidence</div>
                                                    <p className="text-sm text-slate-700">{currentCriterion.evidence}</p>
                                                </div>
                                            )}
                                            
                                            {/* Variations for comparative mode */}
                                            {currentCriterion.variations && currentCriterion.variations.length > 0 && (
                                                <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                                    <div className="text-xs font-medium text-amber-800 mb-2 flex items-center gap-2">
                                                        <span>âš¡</span>
                                                        Variations Detected ({currentCriterion.variations.length})
                                                    </div>
                                                    <ul className="text-sm text-amber-700 list-disc list-inside space-y-1">
                                                        {currentCriterion.variations.slice(0, 5).map((v, i) => (
                                                            <li key={i}>{v}</li>
                                                        ))}
                                                        {currentCriterion.variations.length > 5 && (
                                                            <li className="text-amber-600 italic">
                                                                ... and {currentCriterion.variations.length - 5} more
                                                            </li>
                                                        )}
                                                    </ul>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="text-center py-8 text-slate-500 bg-slate-50 rounded-lg">
                                No evaluation criteria available
                            </div>
                        )}
                    </div>
                </div>

                {/* Panel Footer */}
                <div className="flex-shrink-0 px-5 py-3 bg-slate-50 border-t border-slate-200 flex items-center justify-between text-xs">
                    <div className="flex items-center gap-4 text-slate-500">
                        <span>Test ID: <span className="font-mono">{test.id || 'N/A'}</span></span>
                    </div>
                    {test.traceUrl && (
                        <a 
                            href={test.traceUrl}
                            className="inline-flex items-center gap-1.5 text-blue-600 hover:text-blue-800 font-medium transition-colors"
                        >
                            <Icons.ExternalLink />
                            See Traces
                        </a>
                    )}
                </div>
            </div>
        </div>
    );
};


// === components/views/reports/trace-viewer.jsx ===
/**
 * Enhanced Trace Viewer Component
 * Dev-friendly execution trace visualization with split-pane layout
 * Features: hierarchical tree, detail panel, copy buttons, syntax highlighting
 */

const TraceViewer = ({ traceData, onClose }) => {
    const [selectedSpan, setSelectedSpan] = useState(null);
    const [expandedSpans, setExpandedSpans] = useState(new Set());
    const [filterType, setFilterType] = useState('all');
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedTest, setSelectedTest] = useState(null);
    const [selectedRun, setSelectedRun] = useState(null);
    const [copiedField, setCopiedField] = useState(null);
    const [compareMode, setCompareMode] = useState(false);
    const [compareRun, setCompareRun] = useState(null);
    
    // SVG Icons for span types
    const SpanIcons = {
        CrewKickoff: () => (
            <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="2">
                <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/>
                <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/>
                <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/>
                <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/>
            </svg>
        ),
        Flow: () => (
            <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
        ),
        FlowStep: () => (
            <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="2">
                <path d="M12 3v18M5 12h14M5 6l7-3 7 3M5 18l7 3 7-3"/>
            </svg>
        ),
        FlowRouter: () => (
            <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="2">
                <path d="M6 3v12"/>
                <circle cx="18" cy="6" r="3"/>
                <circle cx="18" cy="18" r="3"/>
                <path d="M6 15a6 6 0 0 0 12-3"/>
            </svg>
        ),
        Agent: () => (
            <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="2">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
            </svg>
        ),
        Task: () => (
            <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="2">
                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                <path d="m9 14 2 2 4-4"/>
            </svg>
        ),
        LLM: () => (
            <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="2">
                <path d="M12 8V4H8"/>
                <rect width="16" height="12" x="4" y="8" rx="2"/>
                <path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/>
            </svg>
        ),
        Tool: () => (
            <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="2">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
            </svg>
        ),
    };
    
    if (!traceData || !traceData.spans || traceData.spans.length === 0) {
        return (
            <div className="h-full flex items-center justify-center bg-slate-50">
                <div className="text-center">
                    <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 flex items-center justify-center text-slate-400">
                        <Icons.Activity />
                    </div>
                    <h3 className="text-lg font-semibold text-slate-900 mb-2">No Execution Traces</h3>
                    <p className="text-sm text-slate-500">Run tests with tracing enabled to see execution flows</p>
                </div>
            </div>
        );
    }

    // Helper to create unique span key (span ID + test context + index for duplicates)
    const getUniqueSpanKey = (span, index) => {
        const testContext = span.test_context || {};
        const testId = testContext.test_id || '';
        const runIndex = testContext.run_index?.toString() || '0';
        // Include index to handle duplicate span IDs in trace data
        return `${span.id}_${testId}_${runIndex}_idx${index}`;
    };
    
    // Group spans by test and run
    const groupByTestAndRun = (spans) => {
        const tests = new Map();
        spans.forEach((span, index) => {
            const testContext = span.test_context || {};
            const fullTestId = testContext.test_id || 'unknown';
            const baseTestId = fullTestId.replace(/-run\d+$/, '');
            
            // Extract run index from test_id suffix if run_index is "-1" or missing
            // Flow traces use test_id like "uuid-run0" but run_index may be "-1"
            let runIndex = testContext.run_index?.toString();
            if (!runIndex || runIndex === '-1') {
                const runMatch = fullTestId.match(/-run(\d+)$/);
                runIndex = runMatch ? runMatch[1] : '0';
            }
            const agentName = testContext.agent_name || 'Unknown';
            
            // Add unique key to each span for React rendering (includes index for duplicates)
            span._uniqueKey = getUniqueSpanKey(span, index);
            
            if (!tests.has(baseTestId)) {
                tests.set(baseTestId, { baseTestId, agentName, runs: new Map() });
            }
            const test = tests.get(baseTestId);
            if (agentName !== 'Unknown') test.agentName = agentName;
            if (!test.runs.has(runIndex)) test.runs.set(runIndex, []);
            test.runs.get(runIndex).push(span);
        });
        
        const result = [];
        let testNumber = 0;
        tests.forEach((test, baseTestId) => {
            testNumber++;
            const testRuns = Array.from(test.runs.entries())
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
                .map(([runIndex, runSpans], runIdx) => ({
                    runIndex: parseInt(runIndex),
                    runNumber: runIdx + 1,
                    spans: runSpans.sort((a, b) => a.start_time - b.start_time),
                    duration_ms: runSpans.reduce((sum, s) => sum + (s.duration_ms || 0), 0),
                    crewName: test.agentName
                }));
            result.push({ baseTestId, testNumber, agentName: test.agentName, runs: testRuns, totalRuns: testRuns.length });
        });
        return result;
    };

    const groupedTests = groupByTestAndRun(traceData.spans);
    
    // Initialize with first test/run and all spans expanded
    useEffect(() => {
        if (groupedTests.length > 0 && !selectedTest) {
            setSelectedTest(groupedTests[0]);
            setSelectedRun(groupedTests[0].runs[0]);
            // Expand all spans by default
            const allSpanIds = new Set(groupedTests[0].runs[0]?.spans.map(s => s.id) || []);
            setExpandedSpans(allSpanIds);
        }
    }, []);
    
    const currentRun = selectedRun || (selectedTest?.runs[0]);
    const filteredSpans = currentRun?.spans.filter(span => {
        if (filterType !== 'all' && span.type !== filterType) return false;
        if (searchQuery && !JSON.stringify(span).toLowerCase().includes(searchQuery.toLowerCase())) return false;
        return true;
    }) || [];
    
    // Build span hierarchy - use _uniqueKey to handle duplicate span IDs
    const buildHierarchy = (spans) => {
        const spanMap = new Map();
        const roots = [];
        
        // First pass: create nodes using unique keys
        spans.forEach(span => {
            const key = span._uniqueKey || span.id;
            spanMap.set(key, { ...span, children: [] });
        });
        
        // Second pass: build parent-child relationships
        // For parent lookup, we need to find by span.id (since parent_id references original IDs)
        // but we need to be careful with duplicates
        const parentLookup = new Map(); // Maps span.id to array of nodes with that id
        spans.forEach(span => {
            const key = span._uniqueKey || span.id;
            const node = spanMap.get(key);
            if (!parentLookup.has(span.id)) {
                parentLookup.set(span.id, []);
            }
            parentLookup.get(span.id).push(node);
        });
        
        spans.forEach(span => {
            const key = span._uniqueKey || span.id;
            const node = spanMap.get(key);
            if (span.parent_id && parentLookup.has(span.parent_id)) {
                // Add to the first parent node with matching id (deterministic)
                const parentNodes = parentLookup.get(span.parent_id);
                if (parentNodes.length > 0) {
                    parentNodes[0].children.push(node);
                }
            } else {
                roots.push(node);
            }
        });
        return roots;
    };
    
    const spanHierarchy = buildHierarchy(filteredSpans);
    
    const toggleSpan = (spanId) => {
        const newExpanded = new Set(expandedSpans);
        if (newExpanded.has(spanId)) newExpanded.delete(spanId);
        else newExpanded.add(spanId);
        setExpandedSpans(newExpanded);
    };
    
    const expandAll = () => setExpandedSpans(new Set(filteredSpans.map(s => s.id)));
    const collapseAll = () => setExpandedSpans(new Set());
    
    const getSpanTypeInfo = (type) => ({
        'crew_kickoff': { icon: SpanIcons.CrewKickoff, label: 'Crew', color: 'bg-indigo-500', text: 'text-indigo-700', bg: 'bg-indigo-50', border: 'border-indigo-200' },
        'flow_kickoff': { icon: SpanIcons.Flow, label: 'Flow', color: 'bg-fuchsia-500', text: 'text-fuchsia-700', bg: 'bg-fuchsia-50', border: 'border-fuchsia-200' },
        'flow_step': { icon: SpanIcons.FlowStep, label: 'Step', color: 'bg-fuchsia-400', text: 'text-fuchsia-600', bg: 'bg-fuchsia-50', border: 'border-fuchsia-200' },
        'flow_routing': { icon: SpanIcons.FlowRouter, label: 'Router', color: 'bg-pink-500', text: 'text-pink-700', bg: 'bg-pink-50', border: 'border-pink-200' },
        'flow_start_method': { icon: SpanIcons.Flow, label: 'Start', color: 'bg-fuchsia-600', text: 'text-fuchsia-800', bg: 'bg-fuchsia-50', border: 'border-fuchsia-200' },
        'agent_execute': { icon: SpanIcons.Agent, label: 'Agent', color: 'bg-purple-500', text: 'text-purple-700', bg: 'bg-purple-50', border: 'border-purple-200' },
        'task_execute': { icon: SpanIcons.Task, label: 'Task', color: 'bg-amber-500', text: 'text-amber-700', bg: 'bg-amber-50', border: 'border-amber-200' },
        'llm_call': { icon: SpanIcons.LLM, label: 'LLM', color: 'bg-violet-500', text: 'text-violet-700', bg: 'bg-violet-50', border: 'border-violet-200' },
        'tool_call': { icon: SpanIcons.Tool, label: 'Tool', color: 'bg-emerald-500', text: 'text-emerald-700', bg: 'bg-emerald-50', border: 'border-emerald-200' }
    }[type] || { icon: Icons.Activity, label: type, color: 'bg-slate-500', text: 'text-slate-700', bg: 'bg-slate-50', border: 'border-slate-200' });
    
    const formatDuration = (ms) => {
        if (ms == null) return '-';
        if (ms < 1000) return `${Math.round(ms)}ms`;
        if (ms < 60000) return `${(ms / 1000).toFixed(2)}s`;
        return `${(ms / 60000).toFixed(2)}m`;
    };
    
    const copyToClipboard = (text, field) => {
        navigator.clipboard.writeText(typeof text === 'string' ? text : JSON.stringify(text, null, 2));
        setCopiedField(field);
        setTimeout(() => setCopiedField(null), 2000);
    };
    
    const CopyButton = ({ value, field }) => (
        <button
            onClick={(e) => { e.stopPropagation(); copyToClipboard(value, field); }}
            className="p-1 rounded hover:bg-slate-200 transition-colors text-slate-400 hover:text-slate-600"
            title="Copy to clipboard"
        >
            {copiedField === field ? <Icons.Check /> : (
                <svg viewBox="0 0 24 24" fill="none" className="w-3.5 h-3.5" stroke="currentColor" strokeWidth="2">
                    <rect width="14" height="14" x="8" y="8" rx="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                </svg>
            )}
        </button>
    );
    
    const DataSection = ({ label, data, field, isCollapsible = true }) => {
        const [isCollapsed, setIsCollapsed] = useState(false);
        if (!data) return null;
        
        // Check if data is JSON-like (object or array) for syntax highlighting
        const isJsonObject = typeof data === 'object' && data !== null;
        
        // For JSON objects, always use highlighting
        let dataToHighlight = data;
        let canHighlight = isJsonObject;
        
        // For strings, check if it looks like JSON/Python structure
        if (!isJsonObject && typeof data === 'string') {
            const trimmed = data.trim();
            // Check if it looks like JSON or Python structure
            const startsLikeStructure = trimmed.startsWith('{') || trimmed.startsWith('[');
            
            if (startsLikeStructure) {
                // Try multiple parsing strategies
                let parsed = null;
                
                // Strategy 1: Direct JSON parse
                try {
                    parsed = JSON.parse(data);
                } catch (e1) {
                    // Strategy 2: Python-style conversion
                    try {
                        const jsonStr = data
                            .replace(/'/g, '"')
                            .replace(/True/g, 'true')
                            .replace(/False/g, 'false')
                            .replace(/None/g, 'null');
                        parsed = JSON.parse(jsonStr);
                    } catch (e2) {
                        // Strategy 3: If it's a Python repr, just display as-is but styled
                        // We'll still try to highlight it as a string
                    }
                }
                
                if (parsed) {
                    dataToHighlight = parsed;
                    canHighlight = true;
                }
            }
        }
        
        // Generate content for display and line counting
        const content = typeof dataToHighlight === 'string' 
            ? dataToHighlight 
            : JSON.stringify(dataToHighlight, null, 2);
        const lineCount = content.split('\n').length;
        
        return (
            <div className="mb-4">
                <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                        {isCollapsible && lineCount > 5 && (
                            <button 
                                onClick={() => setIsCollapsed(!isCollapsed)}
                                className="p-0.5 hover:bg-slate-200 rounded transition-colors"
                            >
                                <svg className={`w-3 h-3 text-slate-400 transition-transform ${isCollapsed ? '' : 'rotate-90'}`} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>
                            </button>
                        )}
                        <span className="text-xs font-semibold text-slate-500 uppercase tracking-wide">{label}</span>
                        <span className="text-[10px] text-slate-400">({lineCount} lines)</span>
                    </div>
                    <CopyButton value={data} field={field} />
                </div>
                {!isCollapsed && (
                    <div className="bg-slate-900 rounded-lg overflow-hidden">
                        <pre className="text-xs font-mono p-3 overflow-x-auto overflow-y-auto max-h-64 scrollbar-thin whitespace-pre-wrap break-all" style={{ maxWidth: '100%', wordBreak: 'break-word' }}>
                            {canHighlight ? (
                                <JsonHighlight data={dataToHighlight} />
                            ) : (
                                <span className="text-slate-100">{content}</span>
                            )}
                        </pre>
                    </div>
                )}
                {isCollapsed && (
                    <div className="bg-slate-100 text-slate-500 text-xs p-2 rounded-lg cursor-pointer hover:bg-slate-200" onClick={() => setIsCollapsed(false)}>
                        Click to expand ({lineCount} lines)
                    </div>
                )}
            </div>
        );
    };
    
    // Get display name for a span
    const getSpanDisplayName = (span) => {
        // Priority: agent > flow_name > crew_name > tool_name > model > type label
        return span.data?.agent 
            || span.data?.flow_name 
            || span.data?.crew_name 
            || span.data?.tool_name 
            || span.data?.model 
            || getSpanTypeInfo(span.type).label;
    };
    
    // Tree node component
    const TreeNode = ({ span, depth = 0 }) => {
        const typeInfo = getSpanTypeInfo(span.type);
        const isExpanded = expandedSpans.has(span.id);
        // Use _uniqueKey for selection to avoid matching duplicate span IDs
        const isSelected = selectedSpan?._uniqueKey === span._uniqueKey;
        const hasChildren = span.children?.length > 0;
        const IconComponent = typeInfo.icon;
        
        return (
            <div>
                <div
                    className={`flex items-center gap-2 px-2 py-1.5 rounded-lg cursor-pointer transition-colors ${
                        isSelected ? 'bg-blue-100 border border-blue-300' : 'hover:bg-slate-100'
                    }`}
                    style={{ paddingLeft: `${depth * 16 + 8}px` }}
                    onClick={() => setSelectedSpan(span)}
                >
                    {hasChildren ? (
                        <button onClick={(e) => { e.stopPropagation(); toggleSpan(span.id); }} className="p-0.5">
                            <svg className={`w-3 h-3 text-slate-400 transition-transform ${isExpanded ? 'rotate-90' : ''}`} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                        </button>
                    ) : <div className="w-4" />}
                    
                    <div className={`w-6 h-6 rounded ${typeInfo.color} text-white flex items-center justify-center flex-shrink-0`}>
                        <IconComponent />
                    </div>
                    
                    <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-medium text-slate-900 truncate">
                                {getSpanDisplayName(span)}
                            </span>
                            {span.error && <span className="w-2 h-2 rounded-full bg-red-500" title="Error" />}
                        </div>
                    </div>
                    
                    <span className="text-[10px] font-mono text-slate-400">{formatDuration(span.duration_ms)}</span>
                </div>
                
                {isExpanded && hasChildren && (
                    <div>
                        {span.children.map(child => <TreeNode key={child._uniqueKey || child.id} span={child} depth={depth + 1} />)}
                    </div>
                )}
            </div>
        );
    };
    
    // Run comparison component - uses root span duration (crew/flow kickoff)
    const RunComparison = () => {
        if (!selectedTest || selectedTest.totalRuns < 2) return null;
        
        const runs = selectedTest.runs;
        
        // Get crew name from root span
        const firstRun = runs[0];
        const rootSpanForName = firstRun?.spans.find(s => s.type === 'crew_kickoff' || s.type === 'flow_kickoff' || !s.parent_id);
        const crewName = rootSpanForName?.data?.crew_name || selectedTest.agentName || 'Unknown Crew';
        
        // Get test ID from test context
        const testId = selectedTest.baseTestId || 'N/A';
        
        const metrics = runs.map(run => {
            // Find root span (crew_kickoff or flow_kickoff) - span with no parent
            const rootSpan = run.spans.find(s => !s.parent_id || (s.type === 'crew_kickoff' || s.type === 'flow_kickoff'));
            const duration = rootSpan?.duration_ms || 0;
            
            // Get run ID from test context
            const runId = run.spans[0]?.test_context?.test_id || `run-${run.runIndex}`;
            
            // Count LLM calls and tokens from LLM spans only
            const llmSpans = run.spans.filter(s => s.type === 'llm_call');
            const totalTokens = llmSpans.reduce((sum, s) => sum + ((s.data?.tokens?.prompt || 0) + (s.data?.tokens?.completion || 0)), 0);
            const errors = run.spans.filter(s => s.error).length;
            const llmCalls = llmSpans.length;
            const toolCalls = run.spans.filter(s => s.type === 'tool_call').length;
            
            return { runNumber: run.runNumber, runIndex: run.runIndex, runId, duration, totalTokens, errors, llmCalls, toolCalls };
        });
        
        const avgDuration = metrics.reduce((sum, m) => sum + m.duration, 0) / metrics.length;
        
        return (
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-t border-blue-200 p-3">
                <div className="text-xs font-semibold text-blue-800 mb-1 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="2">
                            <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5"/>
                        </svg>
                        <span>Run Comparison</span>
                    </div>
                    <span className="font-medium text-indigo-600">{crewName}</span>
                </div>
                <div className="text-[9px] text-slate-500 mb-2 font-mono truncate" title={testId}>Test ID: {testId}</div>
                <div className="grid grid-cols-3 gap-2 text-[10px]">
                    {metrics.map(m => (
                        <div 
                            key={m.runNumber} 
                            className={`p-2 rounded cursor-pointer transition-colors ${selectedRun?.runNumber === m.runNumber ? 'bg-blue-100 border border-blue-300' : 'bg-white/60 hover:bg-white/80'}`}
                            onClick={() => {
                                const run = selectedTest.runs.find(r => r.runNumber === m.runNumber);
                                if (run) {
                                    setSelectedRun(run);
                                    setExpandedSpans(new Set(run.spans.map(s => s.id)));
                                    setSelectedSpan(null);
                                }
                            }}
                        >
                            <div className="font-semibold text-slate-700 mb-0.5">Run {m.runNumber}</div>
                            <div className="text-[9px] text-slate-400 font-mono truncate mb-1" title={m.runId}>{m.runId.substring(0, 12)}...</div>
                            <div className={`font-mono ${Math.abs(m.duration - avgDuration) > avgDuration * 0.2 ? 'text-amber-600' : 'text-slate-600'}`}>
                                {formatDuration(m.duration)}
                            </div>
                            <div className="text-slate-500">{m.totalTokens} tokens</div>
                            <div className="text-slate-400">{m.llmCalls} LLM / {m.toolCalls} tools</div>
                            {m.errors > 0 && <div className="text-red-600 font-medium">{m.errors} errors</div>}
                        </div>
                    ))}
                </div>
                {metrics.some(m => Math.abs(m.duration - avgDuration) > avgDuration * 0.3) && (
                    <div className="mt-2 text-[10px] text-amber-700 bg-amber-50 border border-amber-200 rounded p-1.5">
                        âš ï¸ Significant variance detected between runs - possible non-determinism
                    </div>
                )}
            </div>
        );
    };
    
    // Find parent span
    const findParentSpan = (parentId) => {
        return filteredSpans.find(s => s.id === parentId);
    };
    
    // Detail panel for selected span
    const DetailPanel = ({ span }) => {
        if (!span) {
            return (
                <div className="h-full flex items-center justify-center text-slate-400">
                    <div className="text-center">
                        <Icons.Activity />
                        <p className="mt-2 text-sm">Select a span to view details</p>
                    </div>
                </div>
            );
        }
        
        const typeInfo = getSpanTypeInfo(span.type);
        const IconComponent = typeInfo.icon;
        const parentSpan = span.parent_id ? findParentSpan(span.parent_id) : null;
        const hasError = span.error;
        
        return (
            <div className="h-full overflow-y-auto scrollbar-thin p-4">
                {/* Error Banner - Prominent at top */}
                {hasError && (
                    <div className="bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg p-4 mb-4 shadow-lg">
                        <div className="flex items-start gap-3">
                            <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0">
                                <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5" stroke="currentColor" strokeWidth="2">
                                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                                </svg>
                            </div>
                            <div className="flex-1">
                                <div className="font-semibold text-sm mb-1">Execution Error</div>
                                <pre className="text-xs font-mono bg-white/10 rounded p-2 overflow-auto max-h-32 whitespace-pre-wrap break-all">
                                    {span.error}
                                </pre>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Header */}
                <div className={`${hasError ? 'bg-red-50 border-red-200' : typeInfo.bg + ' ' + typeInfo.border} border rounded-lg p-4 mb-4`}>
                    <div className="flex items-center gap-3 mb-3">
                        <div className={`w-10 h-10 rounded-lg ${hasError ? 'bg-red-500' : typeInfo.color} text-white flex items-center justify-center`}>
                            {hasError ? (
                                <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5" stroke="currentColor" strokeWidth="2">
                                    <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                                </svg>
                            ) : <IconComponent />}
                        </div>
                        <div className="flex-1">
                            <div className="text-xs font-medium text-slate-500 uppercase">{typeInfo.label}</div>
                            <div className={`text-lg font-semibold ${hasError ? 'text-red-700' : typeInfo.text}`}>
                                {span.data?.agent || span.data?.model || span.data?.tool_name || span.data?.crew_name || 'Unnamed'}
                            </div>
                        </div>
                    </div>
                    
                    {/* Metrics */}
                    <div className="grid grid-cols-3 gap-3 text-xs">
                        <div className="bg-white/60 rounded p-2">
                            <div className="text-slate-500">Duration</div>
                            <div className="font-mono font-semibold text-slate-900">{formatDuration(span.duration_ms)}</div>
                        </div>
                        {span.data?.tokens && (
                            <>
                                <div className="bg-white/60 rounded p-2">
                                    <div className="text-slate-500">Prompt Tokens</div>
                                    <div className="font-mono font-semibold text-slate-900">{span.data.tokens.prompt || 0}</div>
                                </div>
                                <div className="bg-white/60 rounded p-2">
                                    <div className="text-slate-500">Completion Tokens</div>
                                    <div className="font-mono font-semibold text-slate-900">{span.data.tokens.completion || 0}</div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
                
                {/* Data Sections - Check multiple possible field names */}
                <DataSection 
                    label="Inputs" 
                    data={span.data?.inputs} 
                    field="inputs" 
                />
                <DataSection 
                    label="Task / Description" 
                    data={span.data?.task || span.data?.task_description} 
                    field="task" 
                />
                <DataSection 
                    label={span.type === 'llm_call' ? 'Prompt Preview' : 'Prompt'} 
                    data={span.data?.prompt_preview || span.data?.prompt} 
                    field="prompt" 
                />
                <DataSection 
                    label="Result / Output" 
                    data={span.data?.result || span.data?.response} 
                    field="output" 
                />
                
                {/* Tool-specific data */}
                {span.type === 'tool_call' && (
                    <DataSection label="Tool Input" data={span.data?.tool_input} field="tool_input" />
                )}
                
                {/* Agents list for crew spans */}
                {span.data?.agents && span.data.agents.length > 0 && (
                    <DataSection label="Agents in Crew" data={span.data.agents} field="agents" />
                )}
                
                {/* Flow state tracking - show state diffs */}
                {(span.type === 'flow_kickoff' || span.type === 'flow_step') && (
                    <>
                        {span.state_before && Object.keys(span.state_before).length > 0 && (
                            <DataSection label="State Before" data={span.state_before} field="state_before" />
                        )}
                        {span.state_after && Object.keys(span.state_after).length > 0 && (
                            <DataSection label="State After" data={span.state_after} field="state_after" />
                        )}
                        {span.state_diff && Object.keys(span.state_diff).length > 0 && (
                            <div className="mb-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-xs font-semibold text-amber-600 uppercase tracking-wide">State Changes</span>
                                    <span className="text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">{Object.keys(span.state_diff).length} fields changed</span>
                                </div>
                                <div className="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg p-3 space-y-2">
                                    {Object.entries(span.state_diff).map(([key, diff]) => (
                                        <div key={key} className="text-xs">
                                            <div className="font-semibold text-amber-800 mb-1">{key}</div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div className="bg-red-50 border border-red-200 rounded p-2">
                                                    <div className="text-[10px] text-red-600 mb-1">Before</div>
                                                    <pre className="font-mono text-red-800 whitespace-pre-wrap break-all">{JSON.stringify(diff.before, null, 2)}</pre>
                                                </div>
                                                <div className="bg-green-50 border border-green-200 rounded p-2">
                                                    <div className="text-[10px] text-green-600 mb-1">After</div>
                                                    <pre className="font-mono text-green-800 whitespace-pre-wrap break-all">{JSON.stringify(diff.after, null, 2)}</pre>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </>
                )}
                
                {/* Show all raw data for debugging */}
                <details className="mt-4">
                    <summary className="text-xs font-semibold text-slate-400 uppercase tracking-wide cursor-pointer hover:text-slate-600">
                        Raw Data (Debug)
                    </summary>
                    <div className="mt-2 bg-slate-900 rounded-lg overflow-hidden">
                        <pre className="text-[10px] font-mono p-2 overflow-auto max-h-48">
                            {span.data ? <JsonHighlight data={span.data} /> : <span className="text-slate-400">No data</span>}
                        </pre>
                    </div>
                </details>
                
                {/* Metadata */}
                <div className="mt-4 pt-4 border-t border-slate-200">
                    <div className="flex items-center justify-between mb-2">
                        <span className="text-xs font-semibold text-slate-500 uppercase tracking-wide">Metadata</span>
                        {parentSpan && (
                            <button
                                onClick={() => setSelectedSpan(parentSpan)}
                                className="text-[10px] text-blue-600 hover:text-blue-800 flex items-center gap-1"
                            >
                                <svg viewBox="0 0 24 24" fill="none" className="w-3 h-3" stroke="currentColor" strokeWidth="2">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                                Go to parent
                            </button>
                        )}
                    </div>
                    <div className="grid grid-cols-2 gap-2 text-xs">
                        <div>
                            <span className="text-slate-500">Span ID:</span>
                            <div className="font-mono text-slate-700 truncate">{span.id}</div>
                        </div>
                        <div>
                            <span className="text-slate-500">Parent ID:</span>
                            <div className="font-mono text-slate-700 truncate">{span.parent_id || 'None (Root)'}</div>
                        </div>
                        <div>
                            <span className="text-slate-500">Start Time:</span>
                            <div className="font-mono text-slate-700">{new Date(span.start_time).toLocaleTimeString()}.{String(span.start_time % 1000).padStart(3, '0')}</div>
                        </div>
                        <div>
                            <span className="text-slate-500">End Time:</span>
                            <div className="font-mono text-slate-700">{span.end_time ? `${new Date(span.end_time).toLocaleTimeString()}.${String(span.end_time % 1000).padStart(3, '0')}` : '-'}</div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };
    
    return (
        <div className="h-full flex flex-col bg-white">
            {/* Header */}
            <div className="flex-shrink-0 border-b border-slate-200 px-4 py-3">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white">
                            <Icons.Activity />
                        </div>
                        <div>
                            <h2 className="text-lg font-semibold text-slate-900">Execution Traces</h2>
                            <p className="text-xs text-slate-500">Debug AI agent flows</p>
                        </div>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg"><Icons.X /></button>
                </div>
                
                {/* Summary Stats */}
                {traceData.summary && (
                    <div className="flex items-center gap-2 mt-3 text-xs">
                        <span className="bg-slate-100 px-2 py-1 rounded font-mono">{formatDuration(traceData.summary.total_duration_ms)}</span>
                        <span className="bg-violet-100 text-violet-700 px-2 py-1 rounded">{traceData.summary.llm_calls} LLM</span>
                        <span className="bg-emerald-100 text-emerald-700 px-2 py-1 rounded">{traceData.summary.tool_calls} Tools</span>
                        <span className="bg-slate-100 px-2 py-1 rounded">{traceData.summary.total_tokens.toLocaleString()} tokens</span>
                        {traceData.summary.errors > 0 && <span className="bg-red-100 text-red-700 px-2 py-1 rounded">{traceData.summary.errors} errors</span>}
                    </div>
                )}
            </div>
            
            {/* Controls */}
            <div className="flex-shrink-0 border-b border-slate-200 px-4 py-2 flex items-center gap-3 bg-slate-50">
                <select
                    value={selectedTest?.baseTestId || ''}
                    onChange={(e) => {
                        const test = groupedTests.find(t => t.baseTestId === e.target.value);
                        setSelectedTest(test);
                        setSelectedRun(test?.runs[0]);
                        setExpandedSpans(new Set(test?.runs[0]?.spans.map(s => s.id) || []));
                        setSelectedSpan(null);
                    }}
                    className="text-xs border border-slate-300 rounded px-2 py-1 bg-white"
                >
                    {groupedTests.map(test => (
                        <option key={test.baseTestId} value={test.baseTestId}>Test {test.testNumber}: {test.agentName}</option>
                    ))}
                </select>
                
                {selectedTest?.totalRuns > 1 && (
                    <div className="flex gap-1">
                        {selectedTest.runs.map(run => (
                            <button
                                key={run.runIndex}
                                onClick={() => { setSelectedRun(run); setExpandedSpans(new Set(run.spans.map(s => s.id))); setSelectedSpan(null); }}
                                className={`px-2 py-1 text-xs rounded ${selectedRun?.runIndex === run.runIndex ? 'bg-blue-500 text-white' : 'bg-white border border-slate-300'}`}
                            >
                                Run {run.runNumber}
                            </button>
                        ))}
                    </div>
                )}
                
                <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="text-xs border border-slate-300 rounded px-2 py-1 bg-white">
                    <option value="all">All Types</option>
                    <option value="agent_execute">Agents</option>
                    <option value="llm_call">LLM Calls</option>
                    <option value="tool_call">Tools</option>
                </select>
                
                <input
                    type="text"
                    placeholder="Search..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="text-xs border border-slate-300 rounded px-2 py-1 bg-white flex-1 max-w-48"
                />
                
                <button onClick={expandAll} className="text-xs px-2 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50">Expand</button>
                <button onClick={collapseAll} className="text-xs px-2 py-1 bg-white border border-slate-300 rounded hover:bg-slate-50">Collapse</button>
            </div>
            
            {/* Split Pane */}
            <div className="flex-1 flex overflow-hidden">
                {/* Left: Tree + Run Comparison */}
                <div className="w-96 border-r border-slate-200 bg-slate-50 flex flex-col">
                    {/* Tree */}
                    <div className="flex-1 p-2 overflow-y-auto scrollbar-thin">
                        {spanHierarchy.length === 0 ? (
                            <div className="text-center py-8 text-slate-400 text-sm">No spans match filter</div>
                        ) : (
                            spanHierarchy.map(span => <TreeNode key={span._uniqueKey || span.id} span={span} />)
                        )}
                    </div>
                    
                    {/* Run Comparison Section - Fixed to bottom */}
                    {selectedTest?.totalRuns > 1 && (
                        <div className="flex-shrink-0">
                            <RunComparison />
                        </div>
                    )}
                </div>
                
                {/* Right: Details */}
                <div className="flex-1 bg-white overflow-hidden">
                    <DetailPanel span={selectedSpan} />
                </div>
            </div>
        </div>
    );
};


// === components/views/reports/report-detail.jsx ===
/**
 * Report Detail View
 * Full report view with provenance, behavioral profiles, and test results
 * Works with the actual report data structure (agents/teams format)
 */

const ReportDetailView = ({ report, onBack }) => {
    const [expandedSections, setExpandedSections] = useState({ provenance: false, profiles: true });
    const [testFilter, setTestFilter] = useState({ dimension: 'all', entity: 'all', result: 'all' });
    const [selectedTest, setSelectedTest] = useState(null);
    const [showTraceViewer, setShowTraceViewer] = useState(false);
    const [activeTab, setActiveTab] = useState('tests');

    const toggleSection = (section) => {
        setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
    };

    // Use report data directly (from the list or from window)
    const reportData = report || window.IdentroData?.report || {};
    
    // Build a lookup map for test specs by ID to get rich names/descriptions
    // The IdentroData has agents, crews, and flows with testSpecs that include name and ui_description
    const testSpecLookup = useMemo(() => {
        const lookup = new Map();
        const data = window.IdentroData;
        
        if (!data) return lookup;
        
        // Build lookup from agents
        for (const agent of data.agents || []) {
            for (const [dimension, dimSpec] of Object.entries(agent.testSpecs || {})) {
                for (const test of dimSpec.tests || []) {
                    if (test.id) {
                        lookup.set(test.id, {
                            name: test.name,
                            ui_description: test.ui_description || test.description,
                            ...test
                        });
                    }
                }
            }
        }
        
        // Build lookup from crews
        for (const crew of data.crews || []) {
            for (const [dimension, dimSpec] of Object.entries(crew.testSpecs || {})) {
                for (const test of dimSpec.tests || []) {
                    if (test.id) {
                        lookup.set(test.id, {
                            name: test.name,
                            ui_description: test.ui_description || test.description,
                            ...test
                        });
                    }
                }
            }
        }
        
        // Build lookup from flows
        for (const flow of data.flows || []) {
            for (const [dimension, dimSpec] of Object.entries(flow.testSpecs || {})) {
                for (const test of dimSpec.tests || []) {
                    if (test.id) {
                        lookup.set(test.id, {
                            name: test.name,
                            ui_description: test.ui_description || test.description,
                            ...test
                        });
                    }
                }
            }
        }
        
        // Also include from tests array if available
        for (const test of data.tests || []) {
            if (test.id && !lookup.has(test.id)) {
                lookup.set(test.id, {
                    name: test.name,
                    ui_description: test.ui_description || test.description,
                    ...test
                });
            }
        }
        
        return lookup;
    }, []);
    
    // Collect all tests from agents and teams (same logic as FullReportView)
    const allTests = [];
    
    if (reportData.agents) {
        for (const [agentName, agent] of Object.entries(reportData.agents)) {
            if (agent.dimensions) {
                for (const [dimensionName, dimension] of Object.entries(agent.dimensions)) {
                    if (dimension.tests) {
                        dimension.tests.forEach(test => {
                            allTests.push({
                                ...test,
                                agentName,
                                dimension: dimensionName,
                                isTeam: false
                            });
                        });
                    }
                }
            }
        }
    }
    
    if (reportData.teams) {
        for (const [teamName, team] of Object.entries(reportData.teams)) {
            if (team.dimensions) {
                for (const [dimensionName, dimension] of Object.entries(team.dimensions)) {
                    if (dimension.tests) {
                        dimension.tests.forEach(test => {
                            allTests.push({
                                ...test,
                                agentName: teamName,
                                dimension: dimensionName,
                                isTeam: true
                            });
                        });
                    }
                }
            }
        }
    }

    // Get unique values for filters
    const uniqueAgents = [...new Set(allTests.map(t => t.agentName))].sort();
    const uniqueDimensions = [...new Set(allTests.map(t => t.dimension))].sort();

    // Apply filters
    const filteredTests = allTests.filter(test => {
        if (testFilter.entity !== 'all' && test.agentName !== testFilter.entity) return false;
        if (testFilter.dimension !== 'all' && test.dimension !== testFilter.dimension) return false;
        if (testFilter.result === 'passed' && !test.passed) return false;
        if (testFilter.result === 'failed' && test.passed) return false;
        return true;
    });

    // Calculate summary
    const totalTests = allTests.length;
    const passedTests = allTests.filter(t => t.passed).length;
    const failedTests = allTests.filter(t => !t.passed).length;
    const successRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;

    // Get provenance data
    const provenance = reportData.provenance || {};
    const filesUsed = provenance.filesUsed || {};

    if (selectedTest) {
        return <TestDetailPanel test={selectedTest} onClose={() => setSelectedTest(null)} />;
    }

    // Show trace viewer as full-screen overlay
    if (showTraceViewer && reportData.traces) {
        return (
            <div className="fixed inset-0 z-50 bg-white">
                <TraceViewer 
                    traceData={reportData.traces} 
                    onClose={() => setShowTraceViewer(false)} 
                />
            </div>
        );
    }

    return (
        <div className="animate-in">
            {/* Report Header */}
            <div className="bg-white rounded-lg border border-slate-200 p-6 shadow-soft mb-4">
                <div className="flex items-start justify-between mb-4">
                    <div>
                        <h1 className="text-xl font-semibold text-slate-900">Identro-Eval Test Report</h1>
                        <p className="text-sm text-slate-500 mt-1">Automated AI Agent Quality Evaluation</p>
                    </div>
                    {(reportData.hasTraces || reportData.traces) && (
                        <button
                            onClick={() => setShowTraceViewer(true)}
                            className="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg hover:from-indigo-600 hover:to-purple-700 transition text-sm font-medium flex items-center gap-2 shadow-md hover:shadow-lg"
                        >
                            <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                            </svg>
                            View Execution Traces
                        </button>
                    )}
                </div>
                
                <div className="flex items-center gap-6 text-sm">
                    <div className="flex items-center gap-2">
                        <span className="text-slate-500">Generated:</span>
                        <span className="font-mono text-slate-700">
                            {reportData.metadata?.timestamp 
                                ? new Date(reportData.metadata.timestamp).toLocaleString() 
                                : reportData.timestamp 
                                    ? new Date(reportData.timestamp).toLocaleString()
                                    : 'Unknown'}
                        </span>
                    </div>
                    <div className="flex items-center gap-2">
                        <span className="text-slate-500">Project:</span>
                        <span className="font-mono bg-slate-100 px-2 py-0.5 rounded text-slate-700">
                            {reportData.metadata?.project || reportData.name || 'Unknown'}
                        </span>
                    </div>
                </div>
            </div>

            {/* Stats Row - Wide horizontal bar */}
            <div className="bg-white rounded-lg border border-slate-200 p-4 shadow-soft mb-4">
                <div className="flex items-center gap-6 divide-x divide-slate-200 flex-wrap">
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-medium text-slate-500 uppercase">Total Tests</span>
                        <span className="text-sm font-semibold text-slate-900">{totalTests}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Passed</span>
                        <span className="text-sm font-semibold text-emerald-600">{passedTests}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Failed</span>
                        <span className="text-sm font-semibold text-red-600">{failedTests}</span>
                    </div>
                    <div className="flex items-center gap-2 pl-6">
                        <span className="text-xs font-medium text-slate-500 uppercase">Success Rate</span>
                        <span className={`text-sm font-semibold ${successRate >= 85 ? 'text-emerald-600' : successRate >= 70 ? 'text-amber-600' : 'text-red-600'}`}>
                            {successRate}%
                        </span>
                    </div>
                </div>
            </div>

            {/* Test Run Provenance */}
            {(provenance.runId || reportData.id) && (
                <div className="mb-4">
                    <div className="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-soft">
                        {/* Header */}
                        <button 
                            onClick={() => toggleSection('provenance')}
                            className="w-full px-5 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors border-b border-slate-100"
                        >
                            <div className="flex items-center gap-3">
                                <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5 text-orange-500" stroke="currentColor" strokeWidth="1.5">
                                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" strokeLinecap="round" strokeLinejoin="round"/>
                                    <line x1="7" y1="7" x2="7.01" y2="7" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                                <span className="font-semibold text-slate-900">Test Run Provenance</span>
                                <span className="text-sm font-mono text-slate-500">
                                    {provenance.runId || reportData.id || 'N/A'}
                                </span>
                            </div>
                            <span className={`text-slate-400 transition-transform ${expandedSections.provenance ? '' : '-rotate-90'}`}>
                                <svg viewBox="0 0 24 24" fill="none" className="w-5 h-5" stroke="currentColor" strokeWidth="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </span>
                        </button>
                        
                        {expandedSections.provenance && (
                            <div className="p-5 border-t border-slate-100">
                                {/* Top Row - Run ID, Timestamp, Framework */}
                                <div className="grid grid-cols-3 gap-8 mb-6">
                                    <div>
                                        <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">RUN ID</div>
                                        <div className="font-mono text-slate-800 text-sm break-all">
                                            {provenance.runId || reportData.id || 'N/A'}
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">TIMESTAMP</div>
                                        <div className="font-mono text-slate-800 text-sm">
                                            {provenance.timestamp 
                                                ? new Date(provenance.timestamp).toLocaleString('en-US', {
                                                    month: 'short', day: 'numeric', year: 'numeric',
                                                    hour: 'numeric', minute: '2-digit', hour12: true
                                                  })
                                                : reportData.timestamp 
                                                    ? new Date(reportData.timestamp).toLocaleString('en-US', {
                                                        month: 'short', day: 'numeric', year: 'numeric',
                                                        hour: 'numeric', minute: '2-digit', hour12: true
                                                      })
                                                    : 'N/A'}
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">FRAMEWORK</div>
                                        <div className="font-mono text-slate-800 text-sm">
                                            {provenance.environment?.framework || 'crewai'}
                                        </div>
                                    </div>
                                </div>

                                {/* Team Contracts Table */}
                                {filesUsed.teamContracts && filesUsed.teamContracts.length > 0 && (
                                    <div className="mb-6">
                                        <div className="flex items-center gap-2 mb-3">
                                            <Icons.Users />
                                            <span className="text-sm font-medium text-slate-700">Team Contracts</span>
                                            <span className="text-xs text-slate-400">{filesUsed.teamContracts.length}</span>
                                        </div>
                                        <div className="border border-slate-200 rounded-lg overflow-hidden">
                                            <table className="w-full text-sm">
                                                <thead className="bg-slate-50">
                                                    <tr className="text-left text-xs text-slate-500 uppercase tracking-wide">
                                                        <th className="px-4 py-2 font-medium">File Path</th>
                                                        <th className="px-4 py-2 font-medium">Source</th>
                                                        <th className="px-4 py-2 font-medium">Content Hash</th>
                                                        <th className="px-4 py-2 font-medium">Last Modified</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {filesUsed.teamContracts.map((contract, idx) => (
                                                        <tr key={idx} className="hover:bg-slate-50">
                                                            <td className="px-4 py-3">
                                                                <span className="text-blue-600 font-mono text-xs">
                                                                    {contract.path || contract.filePath || 'N/A'}
                                                                </span>
                                                            </td>
                                                            <td className="px-4 py-3">
                                                                <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700 uppercase">
                                                                    {contract.source || 'identro'}
                                                                </span>
                                                            </td>
                                                            <td className="px-4 py-3 font-mono text-xs text-slate-500">
                                                                {contract.hash ? `${contract.hash.slice(0, 12)}...` : 'N/A'}
                                                            </td>
                                                            <td className="px-4 py-3 text-xs text-slate-600">
                                                                {contract.lastModified ? new Date(contract.lastModified).toLocaleString() : 'N/A'}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* Test Specifications Table */}
                                {filesUsed.testSpecs && filesUsed.testSpecs.length > 0 && (
                                    <div className="mb-6">
                                        <div className="flex items-center gap-2 mb-3">
                                            <Icons.FileText />
                                            <span className="text-sm font-medium text-slate-700">Test Specifications</span>
                                            <span className="text-xs text-slate-400">{filesUsed.testSpecs.length}</span>
                                        </div>
                                        <div className="border border-slate-200 rounded-lg overflow-hidden">
                                            <table className="w-full text-sm">
                                                <thead className="bg-slate-50">
                                                    <tr className="text-left text-xs text-slate-500 uppercase tracking-wide">
                                                        <th className="px-4 py-2 font-medium">File Path</th>
                                                        <th className="px-4 py-2 font-medium">Source</th>
                                                        <th className="px-4 py-2 font-medium">Content Hash</th>
                                                        <th className="px-4 py-2 font-medium">Last Modified</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {filesUsed.testSpecs.map((spec, idx) => (
                                                        <tr key={idx} className="hover:bg-slate-50">
                                                            <td className="px-4 py-3">
                                                                <span className="text-blue-600 font-mono text-xs">
                                                                    {spec.path || spec.filePath || 'N/A'}
                                                                </span>
                                                            </td>
                                                            <td className="px-4 py-3">
                                                                <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700 uppercase">
                                                                    {spec.source || 'identro'}
                                                                </span>
                                                            </td>
                                                            <td className="px-4 py-3 font-mono text-xs text-slate-500">
                                                                {spec.hash ? `${spec.hash.slice(0, 12)}...` : 'N/A'}
                                                            </td>
                                                            <td className="px-4 py-3 text-xs text-slate-600">
                                                                {spec.lastModified ? new Date(spec.lastModified).toLocaleString() : 'N/A'}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* Environment Info Cards */}
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="border border-slate-200 rounded-lg p-4">
                                        <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">NODE.JS</div>
                                        <div className="font-mono text-slate-800">
                                            {provenance.environment?.nodeVersion || 'N/A'}
                                        </div>
                                    </div>
                                    <div className="border border-slate-200 rounded-lg p-4">
                                        <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">IDENTRO VERSION</div>
                                        <div className="font-mono text-slate-800">
                                            {provenance.environment?.identroVersion || 'N/A'}
                                        </div>
                                    </div>
                                    <div className="border border-slate-200 rounded-lg p-4">
                                        <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">FRAMEWORK</div>
                                        <div className="font-mono text-slate-800">
                                            {provenance.environment?.framework || 'N/A'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}

            {/* Tabs */}
            <div className="border-b border-slate-200 mb-6">
                <div className="flex gap-1">
                    <button
                        onClick={() => setActiveTab('tests')}
                        className={`px-4 py-2.5 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${
                            activeTab === 'tests' 
                                ? 'border-violet-500 text-violet-600' 
                                : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                        }`}
                    >
                        <Icons.CheckCircle />
                        Test Results ({totalTests})
                    </button>
                    {reportData.behavioralProfiles && Object.keys(reportData.behavioralProfiles).length > 0 && (
                        <button
                            onClick={() => setActiveTab('profiles')}
                            className={`px-4 py-2.5 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${
                                activeTab === 'profiles' 
                                    ? 'border-violet-500 text-violet-600' 
                                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
                            }`}
                        >
                            <Icons.BarChart />
                            Behavior Profiles ({Object.keys(reportData.behavioralProfiles).length})
                        </button>
                    )}
                </div>
            </div>

            {/* Tab Content */}
            <div className="min-h-[400px]">
                {/* Test Results Tab */}
                {activeTab === 'tests' && (
                    <div className="animate-in">
                        {/* Filters */}
                        <div className="bg-white rounded-lg border border-slate-200 p-4 shadow-soft mb-4">
                            <div className="flex items-center gap-4 flex-wrap">
                                <FilterDropdown 
                                    label="Entity" 
                                    options={uniqueAgents} 
                                    value={testFilter.entity === 'all' ? '' : testFilter.entity} 
                                    onChange={(v) => setTestFilter(prev => ({ ...prev, entity: v || 'all' }))} 
                                />
                                <FilterDropdown 
                                    label="Dimension" 
                                    options={uniqueDimensions} 
                                    value={testFilter.dimension === 'all' ? '' : testFilter.dimension} 
                                    onChange={(v) => setTestFilter(prev => ({ ...prev, dimension: v || 'all' }))} 
                                />
                                <FilterDropdown 
                                    label="Result" 
                                    options={['passed', 'failed']} 
                                    value={testFilter.result === 'all' ? '' : testFilter.result} 
                                    onChange={(v) => setTestFilter(prev => ({ ...prev, result: v || 'all' }))} 
                                />
                                <div className="ml-auto text-sm text-slate-500">
                                    Showing <strong>{filteredTests.length}</strong> of {allTests.length} tests
                                </div>
                            </div>
                        </div>

                        {/* Test Results */}
                        {filteredTests.length > 0 ? (
                            <div className="space-y-3">
                                {filteredTests.map((test, idx) => {
                                    const score = test.evaluation?.score !== undefined 
                                        ? Math.round(test.evaluation.score * 100) 
                                        : (test.evaluation?.reasoning?.passedPercentage || 0);
                                    const threshold = test.evaluation?.reasoning?.passingThreshold || 100;
                                    const totalRuns = test.totalRuns || (test.isMultiRun ? 3 : 1);
                                    
                                    // Look up rich test data from testSpecs by test ID
                                    const specData = test.id ? testSpecLookup.get(test.id) : null;
                                    
                                    // Use spec data for name/description if available, falling back to report data
                                    const testName = specData?.ui_description || specData?.name || 
                                        test.name || `${test.dimension} Test ${idx + 1}`;
                                    const testDescription = test.input?.scenario || specData?.description ||
                                        test.description || test.evaluation?.ui_explanation || 
                                        `Evaluates ${test.dimension} behavior`;
                                    
                                    return (
                                        <div 
                                            key={test.id || idx}
                                            onClick={() => setSelectedTest({ ...test, displayName: testName, displayDescription: testDescription })}
                                            className="bg-white rounded-lg border border-slate-200 shadow-soft hover:shadow-card hover:border-slate-300 transition-all cursor-pointer group"
                                        >
                                            <div className="p-4">
                                                <div className="flex items-start gap-4">
                                                    {/* Status Icon */}
                                                    <div className={`mt-1 w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
                                                        test.passed ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'
                                                    }`}>
                                                        {test.passed ? <Icons.Check /> : <Icons.X />}
                                                    </div>
                                                    
                                                    {/* Main Content */}
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                            <span className="text-xs bg-violet-100 text-violet-700 px-2 py-0.5 rounded font-medium capitalize">
                                                                {test.dimension}
                                                            </span>
                                                            <span className="text-xs bg-slate-100 text-slate-700 px-2 py-0.5 rounded font-mono">
                                                                {test.agentName}
                                                            </span>
                                                            {test.isTeam && (
                                                                <span className="text-xs text-slate-400 uppercase">CREW</span>
                                                            )}
                                                        </div>
                                                        <h3 className="text-sm font-semibold text-slate-900 mb-1">{testName}</h3>
                                                        <p className="text-xs text-slate-500 line-clamp-2">
                                                            {testDescription.length > 150 ? testDescription.slice(0, 150) + '...' : testDescription}
                                                        </p>
                                                    </div>
                                                    
                                                    {/* Right Side Stats */}
                                                    <div className="flex items-center gap-4 flex-shrink-0">
                                                        <div className="text-right">
                                                            <div className={`text-lg font-mono font-semibold ${test.passed ? 'text-emerald-600' : 'text-red-600'}`}>
                                                                {score}%
                                                            </div>
                                                            <div className="text-xs text-slate-500">{threshold}% required</div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm font-mono text-slate-900">{totalRuns} runs</div>
                                                            <div className="text-xs text-slate-500">
                                                                {test.latencyMs ? `${Math.round(test.latencyMs)}ms` : '-'}
                                                            </div>
                                                        </div>
                                                        <Badge variant={test.passed ? 'passed' : 'failed'}>
                                                            {test.passed ? 'passed' : 'failed'}
                                                        </Badge>
                                                        <span className="text-slate-400 group-hover:text-slate-600 group-hover:translate-x-1 transition-all">
                                                            <Icons.ChevronRight />
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="text-center py-12 bg-white rounded-lg border border-slate-200">
                                <p className="text-slate-500">No test results available</p>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Behavior Profiles Tab */}
                {activeTab === 'profiles' && reportData.behavioralProfiles && (
                    <div className="animate-in">
                        {Object.entries(reportData.behavioralProfiles).map(([entityName, profile]) => (
                            <div key={entityName} className="mb-6">
                                <BehaviorProfile 
                                    profile={{
                                        ...profile,
                                        entityName: entityName,
                                        entityType: profile.entityType || 'entity'
                                    }}
                                />
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
};


// === components/views/reports/latest.jsx ===
/**
 * Reports Latest View
 * Displays the latest report directly or shows a list of reports
 * Uses the shared ReportDetailView for displaying report details
 */

const ReportsLatestView = () => {
    const [selectedReport, setSelectedReport] = useState(null);

    const data = window.IdentroData;
    const reports = data?.reports || [];
    const latestReport = data?.report;

    // If we have a latest report with agents/teams data, show it directly using ReportDetailView
    if (latestReport && (latestReport.agents || latestReport.teams)) {
        return <ReportDetailView report={latestReport} onBack={null} />;
    }

    // If a report is selected from the list, show its details
    if (selectedReport) {
        return <ReportDetailView report={selectedReport} onBack={() => setSelectedReport(null)} />;
    }
    
    // If no reports list, but we have report data, show single report
    if (reports.length === 0 && latestReport) {
        return <ReportDetailView report={latestReport} onBack={null} />;
    }

    // Format date with time
    const formatDateTime = (timestamp) => {
        const date = new Date(timestamp);
        const month = date.toLocaleDateString('en-US', { month: 'short' });
        const day = date.getDate();
        const hour = date.getHours();
        const minute = date.getMinutes().toString().padStart(2, '0');
        const ampm = hour >= 12 ? 'pm' : 'am';
        const hour12 = hour % 12 || 12;
        return `${month} ${day} ${hour12}:${minute} ${ampm}`;
    };

    // Filter out manifest files
    const filteredReports = reports.filter(r => !r.name?.includes('manifest') && !r.id?.includes('manifest'));

    return (
        <div className="animate-in">
            <Header 
                title="Latest Reports" 
                subtitle="Recent evaluation reports"
                actions={
                    <Button icon={Icons.Play}>Run New Evaluation</Button>
                }
            />
            
            {filteredReports.length > 0 ? (
                <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
                    {/* Table Header */}
                    <div className="bg-slate-50 border-b border-slate-200 px-4 py-2">
                        <div className="grid grid-cols-12 gap-3 text-xs font-medium text-slate-500 uppercase tracking-wide">
                            <div className="col-span-5">Report</div>
                            <div className="col-span-2">Date</div>
                            <div className="col-span-2 text-center">Tests</div>
                            <div className="col-span-2 text-center">Result</div>
                            <div className="col-span-1 text-right">Score</div>
                        </div>
                    </div>
                    
                    {/* List Items */}
                    <div className="divide-y divide-slate-100">
                        {filteredReports.map((report, i) => {
                            const successRate = report.successRate || ((report.passed / report.totalTests) * 100);
                            
                            return (
                                <div 
                                    key={report.id || i}
                                    onClick={() => setSelectedReport(report)}
                                    className="px-4 py-3 hover:bg-slate-50 cursor-pointer transition-colors group"
                                >
                                    <div className="grid grid-cols-12 gap-3 items-center">
                                        {/* Report Name */}
                                        <div className="col-span-5">
                                            <div className="flex items-center gap-2">
                                                <span className="text-slate-400">
                                                    <Icons.FileText />
                                                </span>
                                                <div className="min-w-0">
                                                    <div className="font-medium text-slate-900 truncate text-sm">
                                                        {report.name}
                                                    </div>
                                                    <div className="text-xs text-slate-400 font-mono truncate">
                                                        {report.id}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Date with Time */}
                                        <div className="col-span-2">
                                            <div className="text-sm text-slate-600">
                                                {formatDateTime(report.timestamp)}
                                            </div>
                                        </div>
                                        
                                        {/* Tests */}
                                        <div className="col-span-2 text-center">
                                            <span className="text-sm font-mono text-slate-700">{report.totalTests}</span>
                                        </div>
                                        
                                        {/* Result */}
                                        <div className="col-span-2 text-center">
                                            <div className="flex items-center justify-center gap-2 text-xs">
                                                <span className="text-emerald-600 font-medium">{report.passed}âœ“</span>
                                                <span className="text-red-500 font-medium">{report.failed}âœ—</span>
                                            </div>
                                        </div>
                                        
                                        {/* Score */}
                                        <div className="col-span-1 text-right">
                                            <div className="flex items-center justify-end gap-2">
                                                <span className={`text-sm font-semibold font-mono ${
                                                    successRate >= 80 ? 'text-emerald-600' : 
                                                    successRate >= 60 ? 'text-amber-600' : 'text-red-600'
                                                }`}>
                                                    {Math.round(successRate)}%
                                                </span>
                                                <span className="text-slate-300 group-hover:text-slate-500 transition-colors">
                                                    <Icons.ChevronRight />
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            ) : (
                <div className="text-center py-12 bg-white rounded-lg border border-slate-200">
                    <div className="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                        <Icons.FileText />
                    </div>
                    <p className="text-slate-900 font-medium mb-2">No reports found</p>
                    <p className="text-sm text-slate-500">
                        Run <code className="font-mono bg-slate-100 px-1.5 py-0.5 rounded">identro-eval test</code> to generate your first report.
                    </p>
                </div>
            )}
        </div>
    );
};


// === components/views/reports/archive.jsx ===
/**
 * Reports Archive View
 * Historical reports with simple list design
 */

const ReportsArchiveView = () => {
    const [selectedReport, setSelectedReport] = useState(null);
    const [sortBy, setSortBy] = useState('date'); // 'date', 'score', 'tests'
    const [sortOrder, setSortOrder] = useState('desc'); // 'asc', 'desc'

    const data = window.IdentroData;
    
    // Get all reports except the latest one (which is shown in Latest view)
    // Also filter out manifest files
    const allReports = data?.reports || [];
    const archivedReports = allReports.length > 1 
        ? allReports.slice(1).filter(r => !r.name?.includes('manifest') && !r.id?.includes('manifest'))
        : (data?.archivedReports || []).filter(r => !r.name?.includes('manifest') && !r.id?.includes('manifest'));

    // Get full report data from fullReports map
    const fullReports = data?.fullReports || {};

    // If a report is selected, show its details using ReportDetailView
    if (selectedReport) {
        // Get full report data (with agents, teams, provenance, etc.)
        const fullReportData = fullReports[selectedReport.id] || selectedReport;
        
        // Note: Using a fragment to avoid animate-in wrapper which has transform
        // that breaks position:fixed for the TestDetailPanel
        return (
            <>
                <div className="animate-in">
                    {/* Back button */}
                    <button 
                        onClick={() => setSelectedReport(null)}
                        className="inline-flex items-center gap-1.5 text-sm text-slate-500 hover:text-slate-900 mb-4 transition-colors"
                    >
                        <svg viewBox="0 0 24 24" fill="none" className="w-4 h-4" stroke="currentColor" strokeWidth="1.5">
                            <path d="m15 18-6-6 6-6" strokeLinecap="round" strokeLinejoin="round"/>
                        </svg>
                        Back to Archive
                    </button>
                </div>
                <ReportDetailView report={fullReportData} onBack={() => setSelectedReport(null)} />
            </>
        );
    }

    // Sort reports
    const sortedReports = [...archivedReports].sort((a, b) => {
        let comparison = 0;
        switch (sortBy) {
            case 'date':
                comparison = new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
                break;
            case 'score':
                const scoreA = a.successRate || ((a.passed / a.totalTests) * 100);
                const scoreB = b.successRate || ((b.passed / b.totalTests) * 100);
                comparison = scoreB - scoreA;
                break;
            case 'tests':
                comparison = b.totalTests - a.totalTests;
                break;
        }
        return sortOrder === 'asc' ? -comparison : comparison;
    });

    // Calculate archive stats
    const totalArchivedTests = archivedReports.reduce((sum, r) => sum + (r.totalTests || 0), 0);
    const avgSuccessRate = archivedReports.length > 0 
        ? archivedReports.reduce((sum, r) => sum + (r.successRate || ((r.passed / r.totalTests) * 100)), 0) / archivedReports.length
        : 0;

    // Format date with time
    const formatDateTime = (timestamp) => {
        const date = new Date(timestamp);
        const month = date.toLocaleDateString('en-US', { month: 'short' });
        const day = date.getDate();
        const hour = date.getHours();
        const minute = date.getMinutes().toString().padStart(2, '0');
        const ampm = hour >= 12 ? 'pm' : 'am';
        const hour12 = hour % 12 || 12;
        return `${month} ${day} ${hour12}:${minute} ${ampm}`;
    };

    return (
        <div className="animate-in">
            <Header 
                title="Report Archive" 
                subtitle="Historical evaluation reports"
            />
            
            {/* Archive Stats */}
            {archivedReports.length > 0 && (
                <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-soft mb-6">
                    <div className="flex items-center gap-6 divide-x divide-slate-200">
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-medium text-slate-500 uppercase">Total Reports</span>
                            <span className="text-sm font-semibold text-slate-900">{archivedReports.length}</span>
                        </div>
                        <div className="flex items-center gap-2 pl-6">
                            <span className="text-xs font-medium text-slate-500 uppercase">Total Tests Run</span>
                            <span className="text-sm font-semibold text-slate-900">{totalArchivedTests}</span>
                        </div>
                        <div className="flex items-center gap-2 pl-6">
                            <span className="text-xs font-medium text-slate-500 uppercase">Avg Success Rate</span>
                            <span className={`text-sm font-semibold ${avgSuccessRate >= 80 ? 'text-emerald-600' : avgSuccessRate >= 60 ? 'text-amber-600' : 'text-red-600'}`}>
                                {Math.round(avgSuccessRate)}%
                            </span>
                        </div>
                    </div>
                </div>
            )}

            {/* Sort Controls */}
            {archivedReports.length > 1 && (
                <div className="flex items-center gap-4 mb-4">
                    <span className="text-sm text-slate-500">Sort by:</span>
                    <select 
                        value={sortBy}
                        onChange={(e) => setSortBy(e.target.value)}
                        className="text-sm border border-slate-200 rounded-md px-2 py-1 text-slate-600"
                    >
                        <option value="date">Date</option>
                        <option value="score">Success Rate</option>
                        <option value="tests">Test Count</option>
                    </select>
                    <button 
                        onClick={() => setSortOrder(sortOrder === 'desc' ? 'asc' : 'desc')}
                        className="text-sm text-slate-500 hover:text-slate-700 flex items-center gap-1"
                    >
                        {sortOrder === 'desc' ? 'â†“ Descending' : 'â†‘ Ascending'}
                    </button>
                </div>
            )}
            
            {sortedReports.length > 0 ? (
                <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
                    {/* Table Header */}
                    <div className="bg-slate-50 border-b border-slate-200 px-4 py-2">
                        <div className="grid grid-cols-12 gap-3 text-xs font-medium text-slate-500 uppercase tracking-wide">
                            <div className="col-span-5">Report</div>
                            <div className="col-span-2">Date</div>
                            <div className="col-span-2 text-center">Tests</div>
                            <div className="col-span-2 text-center">Result</div>
                            <div className="col-span-1 text-right">Score</div>
                        </div>
                    </div>
                    
                    {/* List Items */}
                    <div className="divide-y divide-slate-100">
                        {sortedReports.map((report, i) => {
                            const successRate = report.successRate || ((report.passed / report.totalTests) * 100);
                            
                            return (
                                <div 
                                    key={report.id || i}
                                    onClick={() => setSelectedReport(report)}
                                    className="px-4 py-3 hover:bg-slate-50 cursor-pointer transition-colors group"
                                >
                                    <div className="grid grid-cols-12 gap-3 items-center">
                                        {/* Report Name */}
                                        <div className="col-span-5">
                                            <div className="flex items-center gap-2">
                                                <span className="text-slate-400">
                                                    <Icons.FileText />
                                                </span>
                                                <div className="min-w-0">
                                                    <div className="font-medium text-slate-900 truncate text-sm">
                                                        {report.name}
                                                    </div>
                                                    <div className="text-xs text-slate-400 font-mono truncate">
                                                        {report.id}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Date with Time */}
                                        <div className="col-span-2">
                                            <div className="text-sm text-slate-600">
                                                {formatDateTime(report.timestamp)}
                                            </div>
                                        </div>
                                        
                                        {/* Tests */}
                                        <div className="col-span-2 text-center">
                                            <span className="text-sm font-mono text-slate-700">{report.totalTests}</span>
                                        </div>
                                        
                                        {/* Result */}
                                        <div className="col-span-2 text-center">
                                            <div className="flex items-center justify-center gap-2 text-xs">
                                                <span className="text-emerald-600 font-medium">{report.passed}âœ“</span>
                                                <span className="text-red-500 font-medium">{report.failed}âœ—</span>
                                            </div>
                                        </div>
                                        
                                        {/* Score */}
                                        <div className="col-span-1 text-right">
                                            <div className="flex items-center justify-end gap-2">
                                                <span className={`text-sm font-semibold font-mono ${
                                                    successRate >= 80 ? 'text-emerald-600' : 
                                                    successRate >= 60 ? 'text-amber-600' : 'text-red-600'
                                                }`}>
                                                    {Math.round(successRate)}%
                                                </span>
                                                <span className="text-slate-300 group-hover:text-slate-500 transition-colors">
                                                    <Icons.ChevronRight />
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            ) : (
                <div className="bg-white rounded-lg border border-slate-200 p-12 text-center">
                    <div className="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                        <Icons.Archive />
                    </div>
                    <p className="text-slate-900 font-medium mb-2">No archived reports</p>
                    <p className="text-sm text-slate-500">
                        Reports will appear here after you run evaluations. 
                        <br />
                        Older reports (7+ days) are automatically archived.
                    </p>
                </div>
            )}
        </div>
    );
};


// === app.jsx ===
/**
 * Main App Component
 * Orchestrates the dashboard layout and view routing with URL hash support
 */

const App = () => {
    // Map URL hash paths to internal view names
    const hashToView = {
        'flows': 'flows',
        'crews': 'crews',
        'agents': 'agents',
        'dimensions': 'dimensions',
        'tests': 'tests',
        'reports/latest': 'reports-latest',
        'reports/archive': 'reports-archive',
    };

    // Map internal view names to URL hash paths
    const viewToHash = {
        'flows': 'flows',
        'crews': 'crews',
        'agents': 'agents',
        'dimensions': 'dimensions',
        'tests': 'tests',
        'reports-latest': 'reports/latest',
        'reports-archive': 'reports/archive',
    };

    // Parse initial view from URL hash or use default
    const getInitialView = () => {
        const hash = window.location.hash.slice(2); // Remove '#/'
        if (hash) {
            // Check for detail views (e.g., flows/flow-name, crews/crew-name, agents/agent-name, dimensions/dim-name, tests/test-id)
            if (hash.startsWith('flows/') && hash.length > 6) {
                return 'flow-detail';
            }
            if (hash.startsWith('crews/') && hash.length > 6) {
                return 'crew-detail';
            }
            if (hash.startsWith('agents/') && hash.length > 7) {
                return 'agent-detail';
            }
            if (hash.startsWith('dimensions/') && hash.length > 11) {
                return 'dimension-detail';
            }
            if (hash.startsWith('tests/') && hash.length > 6) {
                return 'test-detail';
            }
            // Check if it's a direct mapping
            if (hashToView[hash]) {
                return hashToView[hash];
            }
            // Try converting hash to view format (e.g., 'reports/latest' -> 'reports-latest')
            const viewFormat = hash.replace('/', '-');
            return viewFormat || 'reports-latest';
        }
        // Check for INITIAL_VIEW set by CLI
        if (window.INITIAL_VIEW) {
            // Handle both formats (reports/latest and reports-latest)
            if (hashToView[window.INITIAL_VIEW]) {
                return hashToView[window.INITIAL_VIEW];
            }
            return window.INITIAL_VIEW.replace('/', '-');
        }
        return 'reports-latest';
    };

    // Get the entity ID from hash for detail views
    const getEntityIdFromHash = () => {
        const hash = window.location.hash.slice(2);
        if (hash.startsWith('flows/')) {
            return decodeURIComponent(hash.slice(6));
        }
        if (hash.startsWith('crews/')) {
            return decodeURIComponent(hash.slice(6));
        }
        if (hash.startsWith('agents/')) {
            return decodeURIComponent(hash.slice(7));
        }
        if (hash.startsWith('dimensions/')) {
            return decodeURIComponent(hash.slice(11));
        }
        if (hash.startsWith('tests/')) {
            return decodeURIComponent(hash.slice(6));
        }
        return null;
    };

    const [activeView, setActiveView] = useState(getInitialView);
    const [selectedEntityId, setSelectedEntityId] = useState(getEntityIdFromHash);
    const [expandedSections, setExpandedSections] = useState({ entities: true, reports: true });

    // Navigate to a view
    const navigateTo = (view, entityId = null) => {
        setActiveView(view);
        setSelectedEntityId(entityId);
    };

    // Handle crew selection
    const handleSelectCrew = (crewName) => {
        setSelectedEntityId(crewName);
        setActiveView('crew-detail');
        window.history.pushState(null, '', `#/crews/${encodeURIComponent(crewName)}`);
    };

    // Handle agent selection
    const handleSelectAgent = (agentName) => {
        setSelectedEntityId(agentName);
        setActiveView('agent-detail');
        window.history.pushState(null, '', `#/agents/${encodeURIComponent(agentName)}`);
    };

    // Handle dimension selection
    const handleSelectDimension = (dimensionName) => {
        setSelectedEntityId(dimensionName);
        setActiveView('dimension-detail');
        window.history.pushState(null, '', `#/dimensions/${encodeURIComponent(dimensionName)}`);
    };

    // Handle back navigation from detail views
    const handleBackToCrews = () => {
        setSelectedEntityId(null);
        setActiveView('crews');
        window.history.pushState(null, '', '#/crews');
    };

    const handleBackToAgents = () => {
        setSelectedEntityId(null);
        setActiveView('agents');
        window.history.pushState(null, '', '#/agents');
    };

    const handleBackToDimensions = () => {
        setSelectedEntityId(null);
        setActiveView('dimensions');
        window.history.pushState(null, '', '#/dimensions');
    };

    // Handle test selection
    const handleSelectTest = (testId) => {
        setSelectedEntityId(testId);
        setActiveView('test-detail');
        window.history.pushState(null, '', `#/tests/${encodeURIComponent(testId)}`);
    };

    const handleBackToTests = () => {
        setSelectedEntityId(null);
        setActiveView('tests');
        window.history.pushState(null, '', '#/tests');
    };

    // Handle flow selection
    const handleSelectFlow = (flowName) => {
        setSelectedEntityId(flowName);
        setActiveView('flow-detail');
        window.history.pushState(null, '', `#/flows/${encodeURIComponent(flowName)}`);
    };

    const handleBackToFlows = () => {
        setSelectedEntityId(null);
        setActiveView('flows');
        window.history.pushState(null, '', '#/flows');
    };

    // Sync URL hash with view changes (for non-detail views)
    useEffect(() => {
        if (activeView !== 'flow-detail' && activeView !== 'crew-detail' && activeView !== 'agent-detail' && activeView !== 'dimension-detail' && activeView !== 'test-detail') {
            const hashPath = viewToHash[activeView] || activeView.replace('-', '/');
            const newHash = '#/' + hashPath;
            if (window.location.hash !== newHash) {
                window.history.pushState(null, '', newHash);
            }
        }
    }, [activeView]);

    // Listen for hash changes (back/forward navigation)
    useEffect(() => {
        const handleHashChange = () => {
            const newView = getInitialView();
            const entityId = getEntityIdFromHash();
            if (newView !== activeView || entityId !== selectedEntityId) {
                setActiveView(newView);
                setSelectedEntityId(entityId);
            }
        };
        window.addEventListener('hashchange', handleHashChange);
        return () => window.removeEventListener('hashchange', handleHashChange);
    }, [activeView, selectedEntityId]);

    // Handle popstate for browser back/forward
    useEffect(() => {
        const handlePopState = () => {
            const newView = getInitialView();
            const entityId = getEntityIdFromHash();
            setActiveView(newView);
            setSelectedEntityId(entityId);
        };
        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
    }, []);

    const toggleSection = (section) => {
        setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
    };

    const renderView = () => {
        switch (activeView) {
            case 'flows': 
                return <FlowsView onSelectFlow={handleSelectFlow} />;
            case 'flow-detail':
                return <FlowDetailView flowId={selectedEntityId} onBack={handleBackToFlows} />;
            case 'crews': 
                return <CrewsView onSelectCrew={handleSelectCrew} />;
            case 'crew-detail':
                return <CrewDetailView crewId={selectedEntityId} onBack={handleBackToCrews} />;
            case 'agents': 
                return <AgentsView onSelectAgent={handleSelectAgent} />;
            case 'agent-detail':
                return <AgentDetailView agentId={selectedEntityId} onBack={handleBackToAgents} />;
            case 'dimensions': 
                return <DimensionsView onSelectDimension={handleSelectDimension} />;
            case 'dimension-detail':
                return <DimensionDetailView dimensionId={selectedEntityId} onBack={handleBackToDimensions} />;
            case 'tests': 
                return <TestsView onSelectTest={handleSelectTest} />;
            case 'test-detail':
                return <TestDetailView testId={selectedEntityId} onBack={handleBackToTests} />;
            case 'reports-latest': 
                return <ReportsLatestView />;
            case 'reports-archive': 
                return <ReportsArchiveView />;
            default: 
                return <ReportsLatestView />;
        }
    };

    // Check if we're in a detail view to determine parent view for sidebar highlighting
    const isDetailView = activeView === 'flow-detail' || activeView === 'crew-detail' || activeView === 'agent-detail' || activeView === 'dimension-detail' || activeView === 'test-detail';
    const getParentView = () => {
        if (activeView === 'flow-detail') return 'flows';
        if (activeView === 'crew-detail') return 'crews';
        if (activeView === 'agent-detail') return 'agents';
        if (activeView === 'dimension-detail') return 'dimensions';
        if (activeView === 'test-detail') return 'tests';
        return activeView;
    };
    const parentView = getParentView();

    return (
        <div className="min-h-screen bg-slate-50/50">
            <Sidebar 
                activeView={parentView} 
                setActiveView={(view) => navigateTo(view)}
                expandedSections={expandedSections}
                toggleSection={toggleSection}
            />
            <main className="ml-56 p-6">
                <div className="max-w-6xl">
                    {renderView()}
                </div>
            </main>
        </div>
    );
};

// Initialize the app
ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>